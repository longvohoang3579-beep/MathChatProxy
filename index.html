<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tr·ª£ L√Ω To√°n & S√°ng T·∫°o AI üé®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --app-height: 100dvh; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #18191a; color: #e4e6eb; }
        .full-viewport-height { height: var(--app-height); }
        .chat-container { background-color: #242526; }
        .bubble { padding: 10px 14px; border-radius: 18px; margin: 8px 0; max-width: 90%; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4); }
        .user { background: #1e90ff; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai { background: #3a3b3c; color: #e4e6eb; align-self: flex-start; border-bottom-left-radius: 4px; }
        .highlight { background-color: #ffc400; color: #18191a; padding: 2px 4px; border-radius: 4px; font-weight: 600; }
        .typing-indicator { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        .generated-image { border-radius: 12px; border: 2px solid #4a4b4c; margin-top: 8px; max-width: 100%; height: auto; }
    </style>
</head>
<body class="p-0 flex items-center justify-center bg-black">
    <div class="w-full max-w-full sm:max-w-lg bg-[#242526] shadow-2xl rounded-none sm:rounded-2xl flex flex-col overflow-hidden full-viewport-height border border-gray-700">
        
        <header class="bg-gradient-to-r from-gray-800 to-black text-white p-4 text-center shadow-lg rounded-none sm:rounded-t-xl flex-shrink-0">
            <h1 class="text-xl font-extrabold flex items-center justify-center">üé® Tr·ª£ L√Ω To√°n & S√°ng T·∫°o AI</h1>
            <p class="text-sm opacity-80">G√µ `/v·∫Ω [n·ªôi dung]` ƒë·ªÉ t·∫°o ·∫£nh</p>
        </header>

        <main id="chat" class="chat-container overflow-y-auto p-4 flex flex-col space-y-3 flex-grow">
            <div class="bubble ai">Ch√†o b·∫°n! T√¥i c√≥ th·ªÉ gi·∫£i to√°n ho·∫∑c t·∫°o h√¨nh ·∫£nh cho b·∫°n. H√£y th·ª≠ g√µ: <code>/v·∫Ω m·ªôt ch√∫ m√®o phi h√†nh gia</code>.</div>
        </main>

        <footer class="p-3 border-t border-gray-700 bg-[#242526] flex-shrink-0">
            <div id="imagePreview" class="hidden mb-2 p-2 bg-[#3a3b3c] rounded-lg border border-gray-600 shadow-sm">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-400">·∫¢nh ƒë√£ ch·ªçn:</span>
                    <button onclick="clearImage()" class="text-red-400 hover:text-red-300 text-xs font-bold">‚ùå X√≥a ·∫£nh</button>
                </div>
                <img id="previewImg" class="mt-2 max-w-full h-16 object-contain rounded border border-gray-600" alt="Preview Image">
            </div>

            <div class="flex items-end space-x-2">
                <button onclick="document.getElementById('fileInput').click()" title="ƒê√≠nh k√®m ·∫£nh t·ª´ th∆∞ vi·ªán" class="p-3 rounded-full bg-gray-700 hover:bg-gray-600 transition-colors text-xl text-white shadow-md flex-shrink-0">üìé</button>
                <input type="file" accept="image/*" id="fileInput" class="hidden" onchange="handleFileSelect(event)">
                <button onclick="document.getElementById('cameraInput').click()" title="Ch·ª•p ·∫£nh b√†i to√°n" class="p-3 rounded-full bg-gray-700 hover:bg-gray-600 transition-colors text-xl text-white shadow-md flex-shrink-0">üì∏</button>
                <input type="file" accept="image/*" capture="environment" id="cameraInput" class="hidden" onchange="handleFileSelect(event)">

                <input type="text" id="textInput" placeholder="H·ªèi b√†i to√°n ho·∫∑c d√πng l·ªánh /v·∫Ω..."
                       class="flex-grow border border-gray-600 rounded-full px-4 py-3 focus:ring-blue-500 focus:border-blue-500 text-sm bg-gray-700 text-white shadow-inner appearance-none"
                       onkeypress="handleKeyPress(event)">
                
                <button onclick="sendMessage()" id="sendButton" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-3 rounded-full transition-colors font-semibold text-sm shadow-lg flex-shrink-0">G·ª≠i</button>
            </div>
        </footer>
    </div>

    <script>
        const chatBox = document.getElementById("chat");
        const textInput = document.getElementById("textInput");
        const fileInput = document.getElementById("fileInput");
        const cameraInput = document.getElementById("cameraInput");
        const imagePreview = document.getElementById("imagePreview");
        const previewImg = document.getElementById("previewImg");
        const sendButton = document.getElementById("sendButton");
        let imageBase64 = null;

        const API_MATH_URL = "/api/ask";
        const API_IMAGE_URL = "/api/generate-image";

        function handleFileSelect(event) { /* ... Gi·ªØ nguy√™n kh√¥ng ƒë·ªïi ... */ }
        function clearImage() { /* ... Gi·ªØ nguy√™n kh√¥ng ƒë·ªïi ... */ }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function formatAiResponse(text) {
            return text.replace(/\n/g, '<br>').replace(/`(.*?)`/g, '<span class="highlight">$1</span>');
        }

        function addMessage(content, role = "ai", messageType = "text") {
            const div = document.createElement("div");
            div.className = `bubble ${role} flex flex-col`;
            
            let messageContent = '';
            if (messageType === 'user_image') {
                messageContent = `<img src="${content}" class="max-w-full rounded mb-1 border border-gray-600" alt="User image">`;
            } else if (messageType === 'generated_image') {
                messageContent = `<span>ƒê√¢y l√† h√¨nh ·∫£nh c·ªßa b·∫°n:</span><img src="${content}" class="generated-image" alt="AI generated image">`;
            } else { // text
                messageContent = `<span>${role === 'ai' ? formatAiResponse(content) : content.replace(/\n/g, '<br>')}</span>`;
            }
            div.innerHTML = messageContent;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addTypingIndicator(message = "... ƒëang ph√¢n t√≠ch ...") {
            const typingDiv = document.createElement("div");
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'bubble ai flex items-center';
            typingDiv.innerHTML = `<span class="typing-indicator text-gray-400">${message}</span>`;
            chatBox.appendChild(typingDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        async function sendMessage() {
            const text = textInput.value.trim();
            if (!text && !imageBase64) return;
            
            // T√°ch l·ªánh t·∫°o ·∫£nh ra kh·ªèi logic chat th√¥ng th∆∞·ªùng
            if (text.toLowerCase().startsWith('/v·∫Ω ')) {
                await handleImageGeneration(text);
                return;
            }

            await handleMathChat(text);
        }

        async function handleMathChat(text) {
            // Hi·ªÉn th·ªã tin nh·∫Øn c·ªßa ng∆∞·ªùi d√πng
            if (imageBase64) addMessage(previewImg.src, "user", "user_image");
            if (text) addMessage(text, "user");

            const userQuestion = text;
            const imageToSend = imageBase64;
            
            textInput.value = "";
            clearImage();
            sendButton.disabled = true;
            addTypingIndicator("... ƒëang gi·∫£i to√°n ...");

            try {
                const response = await fetch(API_MATH_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ question: userQuestion, imageBase64: imageToSend })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `L·ªói HTTP: ${response.status}`);
                }
                const data = await response.json();
                addMessage(data.response, "ai");
            } catch (error) {
                addMessage(`‚ùå ƒê√£ x·∫£y ra l·ªói khi gi·∫£i to√°n: ${error.message}`, "ai");
            } finally {
                removeTypingIndicator();
                sendButton.disabled = false;
                textInput.focus();
            }
        }
        
        async function handleImageGeneration(text) {
            const prompt = text.substring(4).trim(); // L·∫•y n·ªôi dung sau '/v·∫Ω '
            if (!prompt) {
                addMessage("Vui l√≤ng nh·∫≠p n·ªôi dung b·∫°n mu·ªën v·∫Ω. V√≠ d·ª•: `/v·∫Ω m·ªôt con h·ªï`", "ai");
                return;
            }

            addMessage(text, "user");
            textInput.value = "";
            sendButton.disabled = true;
            addTypingIndicator("... ƒëang v·∫Ω tranh ...");

            try {
                const response = await fetch(API_IMAGE_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ prompt: prompt })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `L·ªói HTTP: ${response.status}`);
                }
                const data = await response.json();
                addMessage(data.imageUrl, "ai", "generated_image");

            } catch (error) {
                addMessage(`‚ùå ƒê√£ x·∫£y ra l·ªói khi t·∫°o ·∫£nh: ${error.message}`, "ai");
            } finally {
                removeTypingIndicator();
                sendButton.disabled = false;
                textInput.focus();
            }
        }
    </script>
</body>
</html>