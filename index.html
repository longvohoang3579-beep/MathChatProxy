<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Assistant Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* --- Giữ nguyên toàn bộ CSS từ phiên bản bạn thích --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        :root { --primary-yellow: #facc15; --dark-bg: #0a0a0c; --main-bg: #141417; --input-bg: #1f1f23; --bubble-ai-bg: #2d2d33; --bubble-user-bg: linear-gradient(135deg, #5e5ce6, #2563eb); --text-primary: #e4e4e7; --text-secondary: #a1a1aa; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--main-bg); } ::-webkit-scrollbar-thumb { background-color: #4a4a52; border-radius: 10px; border: 2px solid var(--main-bg); }
        body { background-color: var(--dark-bg); background-image: radial-gradient(circle at 1% 1%, rgba(255, 255, 255, 0.04) 1px, transparent 0), radial-gradient(circle at 99% 99%, rgba(255, 255, 255, 0.04) 1px, transparent 0); background-size: 50px 50px; color: var(--text-primary); font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow: hidden; }
        #intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: var(--dark-bg); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 1; transition: opacity 1s ease-in-out 6s; }
        .intro-container { position: relative; display: flex; align-items: center; justify-content: center; }
        #intro-yellow-flash { position: absolute; width: 100vw; height: 100vh; background-color: var(--primary-yellow); animation: yellowFlash 2s ease-in-out forwards; } @keyframes yellowFlash { 0% { transform: scale(0); border-radius: 50%; } 50% { transform: scale(1); border-radius: 0; } 100% { transform: scale(1); border-radius: 0; opacity: 0; } }
        #intro-text { position: relative; color: #fff; font-size: 3rem; font-weight: bold; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); opacity: 0; animation: logoAnimate 4s ease-in-out 1.5s forwards; }
        #intro-text::after { content: ''; position: absolute; top: 0; left: -10%; width: 20%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent); transform: skewX(-25deg); opacity: 0; animation: shine 1.5s ease-in-out 3s forwards; }
        #intro-burst { position: absolute; width: 1px; height: 1px; background: white; border-radius: 50%; opacity: 0; animation: burst 1s ease-out 5s forwards; } @keyframes logoAnimate { 0% { opacity: 0; transform: scale(2); } 25% { opacity: 1; transform: scale(1); } 75% { opacity: 1; transform: scale(1); } 100% { opacity: 1; transform: scale(1.1); } } @keyframes shine { 0% { left: -10%; opacity: 1; } 100% { left: 110%; opacity: 1; } } @keyframes burst { from { opacity: 1; transform: scale(0); box-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px var(--primary-yellow), 0 0 30px var(--primary-yellow); } to { opacity: 0; transform: scale(200); box-shadow: 0 0 50px #fff, 0 0 75px var(--primary-yellow); } }
        mark.highlight { background-color: var(--primary-yellow); color: black; font-weight: bold; padding: 2px 5px; border-radius: 4px; }
        #app-wrapper { display: flex; height: 100vh; opacity: 0; transition: opacity 0.5s ease-in; }
        #sidebar { width: 260px; background-color: var(--dark-bg); border-right: 1px solid #27272a; padding: 1rem; display: flex; flex-direction: column; transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); position: fixed; left: 0; top: 0; height: 100%; z-index: 100; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        #sidebar.open { transform: translateX(0); }
        .social-login-container { display: flex; gap: 0.75rem; align-items: center; } .social-btn { background-color: #2d2d33; border: 1px solid #444; color: white; padding: 0.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; } .social-btn:hover { background-color: #444; border-color: var(--primary-yellow); }
        #new-chat-btn { background-color: transparent; border: 1px solid var(--primary-yellow); color: var(--primary-yellow); width: 100%; text-align: center; transition: all 0.2s ease; margin-top: 1rem; } #new-chat-btn:hover { background-color: var(--primary-yellow); color: var(--dark-bg); }
        .history-item { padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-secondary); transition: all 0.2s; border-left: 3px solid transparent; } .history-item:hover { background-color: var(--main-bg); color: var(--text-primary); } .history-item.active { background-color: #27272a; color: white; font-weight: 500; border-left-color: var(--primary-yellow); }
        #chat-container { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; max-width: 900px; margin: 0 auto; padding: 1rem; transition: margin-left 0.4s cubic-bezier(0.25, 1, 0.5, 1); } #sidebar.open ~ #chat-container { margin-left: 260px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 0 0.5rem; } .menu-btn, #settings-btn { font-size: 1.8rem; cursor: pointer; color: var(--primary-yellow); z-index: 101; transition: transform 0.2s; } .menu-btn:hover, #settings-btn:hover { transform: scale(1.1); }
        .chat-box { background: transparent; padding: 1rem; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; scroll-behavior: smooth; margin-top: 1rem; gap: 1rem; }
        .message-group { display: flex; gap: 12px; max-width: 90%; } .message-group.user { align-self: flex-end; flex-direction: row-reverse; } .message-group.ai { align-self: flex-start; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background: #444; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-top: 4px; } .avatar-user { background: #5e5ce6; } .avatar-ai { background: var(--primary-yellow); color: #111; }
        @keyframes fadeInBubble { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } } .bubble { padding: 12px 18px; border-radius: 18px; line-height: 1.6; word-wrap: break-word; white-space: pre-wrap; animation: fadeInBubble 0.3s ease-out forwards; box-shadow: 0 4px 15px rgba(0,0,0,0.2); } .user .bubble { background: var(--bubble-user-bg); color: white; border-bottom-right-radius: 4px; } .ai .bubble { background: var(--bubble-ai-bg); color: var(--text-primary); border-bottom-left-radius: 4px; }
        .welcome-message { text-align: center; color: var(--text-secondary); padding: 2rem 1rem; animation: fadeInBubble 0.5s ease; } .welcome-message h2 { font-size: 1.8rem; font-weight: bold; color: var(--text-primary); }
        .typing-indicator { display: flex; align-items: center; gap: 5px; } .typing-indicator span { width: 8px; height: 8px; background-color: #777; border-radius: 50%; animation: typing 1s infinite; } .typing-indicator span:nth-child(2) { animation-delay: 0.2s; } .typing-indicator span:nth-child(3) { animation-delay: 0.4s; } @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        pre { background-color: #0d1117; color: #c9d1d9; padding: 1rem; border-radius: 8px; overflow-x: auto; border: 1px solid #30363d; font-size: 0.9em; } code { font-family: 'Courier New', Courier, monospace; }
        .input-area { margin-top: 1rem; padding: 0.5rem; background: var(--main-bg); border-radius: 1rem; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); }
        .mode-selector { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; justify-content: center; flex-wrap: wrap; } .mode-btn { background: #2d3748; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; border: 2px solid transparent; font-size: 0.9rem; color: var(--text-secondary); } .mode-btn:hover { background: #4a5568; color: var(--text-primary); } .mode-btn.active { border-color: var(--primary-yellow); background-color: #374151; color: var(--primary-yellow); font-weight: 500; }
        .input-row { display: flex; align-items: flex-end; gap: 0.75rem; background: var(--input-bg); padding: 0.5rem; border-radius: 0.75rem; border: 1px solid #333; transition: border-color 0.2s; } .input-row:focus-within { border-color: var(--primary-yellow); }
        textarea { width: 100%; padding: 0.6rem; border-radius: 0.5rem; background: transparent; border: none; color: white; resize: none; outline: none; max-height: 200px; font-size: 1rem; line-height: 1.5; }
        .icon-btn, .send-btn { background: transparent; padding: 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: none; color: var(--text-secondary); flex-shrink: 0; } .icon-btn:hover { color: var(--primary-yellow); background: #374151; } .send-btn { background: var(--primary-yellow); color: var(--dark-bg); } .send-btn:hover { transform: scale(1.1); }
        .pending-preview { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; padding: 0.5rem; } .pending-preview img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #475569; }
        img.generated-image, .generated-video { border-radius: 12px; max-width: 100%; margin-top: 1rem; display: block; max-height: 400px; margin-left: auto; margin-right: auto; }
        #settings-modal { position: absolute; top: 3rem; right: 1rem; width: 200px; background: var(--main-bg); border: 1px solid var(--primary-yellow); border-radius: 0.75rem; padding: 1rem; display: none; z-index: 100; }
        #voice-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(5px); z-index: 1500; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .mic-wave-container { width: 200px; height: 200px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; } .mic-wave-container.listening .wave { animation: ripple 1.5s ease-out infinite; } .mic-wave-container .wave { position: absolute; width: 100%; height: 100%; border: 4px solid var(--primary-yellow); border-radius: 50%; opacity: 0; } .mic-wave-container .wave:nth-child(2) { animation-delay: 0.3s; } .mic-wave-container .wave:nth-child(3) { animation-delay: 0.6s; } @keyframes ripple { from { transform: scale(0.5); opacity: 1; } to { transform: scale(1.5); opacity: 0; } }
        .mic-icon { font-size: 3rem; color: #111; background-color: var(--primary-yellow); border-radius: 50%; padding: 20px; z-index: 10; cursor: pointer; }
        #limit-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 2000; display: none; align-items: center; justify-content: center; flex-direction: column; } #password-form { background: var(--main-bg); padding: 2.5rem; border-radius: 1rem; text-align: center; border: 3px solid var(--primary-yellow); box-shadow: 0 0 30px rgba(250, 204, 21, 0.3); }
        /* --- Hết CSS --- */
    </style>
    <script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>
</head>
<body>
    <audio id="intro-audio" src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAAAAAACAAAARGF2aW5jaCBSZXNvbHZlMTguMS4z/+xDEgAAMDlQGVoAABAQAASxRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPkAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPkAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPkAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMYoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPkAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMYoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMYoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMYoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPkAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPkAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L-" preload="auto"></audio>
    <div id="intro-screen">
        <div class="intro-container">
            <div id="intro-yellow-flash"></div>
            <div id="intro-text">AI Assistant Pro</div>
            <div id="intro-burst"></div>
        </div>
    </div>

    <div id="limit-overlay">
        <div id="password-form">
            <h2 class="text-2xl font-bold mb-4 text-yellow-500">Đã hết lượt sử dụng miễn phí!</h2>
            <p id="limit-message" class="mb-6 text-gray-300">Vui lòng nhập mật khẩu để mở khóa sử dụng không giới hạn:</p>
            <input type="password" id="password-input" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-yellow-500 outline-none" placeholder="Mật khẩu">
            <button id="unlock-btn" class="mt-4 p-3 bg-yellow-500 text-black font-bold rounded-lg w-full hover:bg-yellow-600 transition">Mở khóa Vô Hạn</button>
            <p id="password-message" class="mt-3 text-red-500 hidden"></p>
        </div>
    </div>
    <div id="voice-overlay">
        <div class="mic-wave-container" id="mic-wave">
            <div class="wave"></div><div class="wave"></div><div class="wave"></div>
            <div class="mic-icon" id="voice-mic-icon">🎤</div>
        </div>
        <p id="voice-status" class="mt-6 text-xl font-medium text-yellow-500">Nhấn Mic để Bắt đầu Nói...</p>
        <button id="voice-close-btn" class="mt-10 p-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition">Tắt Chức Năng Giọng Nói</button>
    </div>

    <div id="app-wrapper">
        <aside id="sidebar">
             <div class="social-login-container mb-4">
                <button onclick="alert('Chức năng đăng nhập Google đang được phát triển!')" class="social-btn" title="Đăng nhập với Google">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M15.545 6.558a9.42 9.42 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.689 7.689 0 0 1 5.352 2.082l-2.284 2.284A4.347 4.347 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.25C2.999 7.58 2.5 8.983 2.5 10.5c0 1.517.499 2.92 1.008 4.086a4.473 4.473 0 0 0 4.492 3.25c1.139 0 2.158-.333 2.966-1.059a4.802 4.802 0 0 0 1.76-3.15h-4.724v-2.31H15.545z"/></svg>
                </button>
                <button onclick="alert('Chức năng đăng nhập Facebook đang được phát triển!')" class="social-btn" title="Đăng nhập với Facebook">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0 0 3.603 0 8.049c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951z"/></svg>
                </button>
                 <button onclick="alert('Chức năng đăng nhập GitHub đang được phát triển!')" class="social-btn" title="Đăng nhập với GitHub">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg>
                </button>
            </div>
            <button id="new-chat-btn" class="p-3 rounded-lg font-bold">＋ New Conversation</button>
            <h2 class="text-gray-400 text-sm font-bold mt-6 mb-2 uppercase">History</h2>
            <div id="chat-history"></div>
        </aside>

        <main id="chat-container">
            <div class="header relative">
                <div id="menu-btn" class="menu-btn">☰</div>
                <div class="flex-grow"></div> <div id="settings-btn">⚙️</div>
                <div id="settings-modal">
                    <label class="block mb-2">Chat Language:</label>
                    <select id="language-select" class="w-full p-2 rounded bg-gray-800 text-white">
                        <option value="vi">Tiếng Việt</option>
                        <option value="en">English</option>
                        <option value="zh-CN">简体中文</option>
                    </select>
                </div>
            </div>
            <div class="chat-box" id="chatBox"></div>
            <div class="input-area">
                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="chat" title="Trò chuyện"><span>Chat</span></button>
                    <button class="mode-btn" data-mode="image" title="Tạo ảnh"><span>Tạo Ảnh</span></button>
                    <button class="mode-btn" data-mode="math" title="Giải toán"><span>Giải Toán</span></button>
                    <button class="mode-btn" data-mode="video" title="Tạo video"><span>Tạo Video</span></button>
                    <button class="mode-btn" data-mode="edit_image" title="Chỉnh sửa ảnh"><span>Sửa Ảnh</span></button>
                    <button class="mode-btn" data-mode="summarize_youtube" title="Tóm tắt YouTube"><span>Tóm Tắt YT</span></button>
                    <button class="mode-btn" data-mode="notetaker" title="Ghi chú văn bản"><span>Ghi Chú</span></button>
                </div>
                <div class="pending-preview" id="previewContainer"></div>
                <div class="input-row">
                    <label class="icon-btn" for="fileInput" title="Tải ảnh">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16"><path d="M6.5 12.5a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1h-3zM3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM.5 4.5A.5.5 0 0 1 1 4h14a.5.5 0 0 1 0 1H1a.5.5 0 0 1-.5-.5zM3 8.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 8.5z"/></svg>
                    </label>
                    <input type="file" id="fileInput" accept="image/*" hidden />
                    <button id="voiceBtn" class="icon-btn" title="Trò chuyện bằng giọng nói">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16"><path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/></svg>
                    </button>
                    <textarea id="mainInput" rows="1" placeholder="Ask me anything..."></textarea>
                    <button id="sendBtn" class="send-btn" title="Gửi">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="22" height="22" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const getEl = (id) => document.getElementById(id);
        const introScreen = getEl('intro-screen'), appWrapper = getEl('app-wrapper'), sidebar = getEl('sidebar'), menuBtn = getEl('menu-btn'), chatContainer = getEl('chat-container'), chatBox = getEl('chatBox'), mainInput = getEl('mainInput'), sendBtn = getEl('sendBtn'), fileInput = getEl('fileInput'), previewContainer = getEl('previewContainer'), languageSelect = getEl('language-select'), settingsBtn = getEl('settings-btn'), settingsModal = getEl('settings-modal'), newChatBtn = getEl('new-chat-btn'), chatHistoryContainer = getEl('chat-history');
        const introAudio = getEl('intro-audio'), voiceBtn = getEl('voiceBtn'), voiceOverlay = getEl('voice-overlay'), voiceCloseBtn = getEl('voice-close-btn'), voiceStatus = getEl('voice-status'), voiceMicIcon = getEl('voice-mic-icon'), micWave = getEl('mic-wave');
        const limitOverlay = getEl('limit-overlay'), passwordInput = getEl('password-input'), unlockBtn = getEl('unlock-btn'), passwordMessage = getEl('password-message');
        const modeButtons = document.querySelectorAll('.mode-btn');

        let currentChatMode = 'chat', uploadedFile = null, chatHistory = {}, activeChatId = null, isRecording = false;

        const MAX_USES = 20;
        const UNLOCK_PASSWORD = "Hoang1082009@";
        let usageCount = parseInt(localStorage.getItem('ai_pro_uses') || '0');
        let isUnlimited = localStorage.getItem('ai_pro_unlimited') === 'true';

        function checkUsageLimit() {
            const isLocked = !isUnlimited && usageCount >= MAX_USES;
            limitOverlay.style.display = isLocked ? 'flex' : 'none';
            // Disable inputs if locked
            [mainInput, sendBtn, voiceBtn, fileInput].forEach(el => el.disabled = isLocked);
            modeButtons.forEach(btn => btn.disabled = isLocked);
            // Visually indicate disabled state for buttons
            [voiceBtn, sendBtn, fileInput.labels[0]].forEach(btn => {
                if(btn) btn.style.opacity = isLocked ? '0.5' : '1';
                if(btn) btn.style.cursor = isLocked ? 'not-allowed' : 'pointer';
            });
            modeButtons.forEach(btn => {
                 btn.style.opacity = isLocked ? '0.5' : '1';
                 btn.style.cursor = isLocked ? 'not-allowed' : 'pointer';
            });
            return !isLocked;
        }


        function incrementUsageCount() {
            if (!isUnlimited) {
                usageCount++;
                localStorage.setItem('ai_pro_uses', usageCount);
                checkUsageLimit(); // Re-check and update UI after incrementing
            }
        }


        unlockBtn.addEventListener('click', () => {
            if (passwordInput.value === UNLOCK_PASSWORD) {
                isUnlimited = true;
                localStorage.setItem('ai_pro_unlimited', 'true');
                passwordMessage.textContent = 'Mở khóa thành công!';
                passwordMessage.className = 'mt-3 text-green-500'; // Make sure hidden is removed
                setTimeout(() => checkUsageLimit(), 1500); // Wait a bit then re-enable inputs
            } else {
                passwordMessage.textContent = 'Mật khẩu sai.';
                passwordMessage.className = 'mt-3 text-red-500'; // Make sure hidden is removed
            }
        });


        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false; // Stop after first result
            recognition.interimResults = false; // Only final results

            recognition.onstart = () => {
                isRecording = true;
                voiceStatus.textContent = "Đang Lắng Nghe...";
                micWave.classList.add('listening');
                voiceMicIcon.textContent = '🔴';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                // Directly handle voice query after getting result
                handleVoiceQuery(transcript, recognition.lang);
            };

            recognition.onend = () => {
                isRecording = false;
                micWave.classList.remove('listening');
                voiceMicIcon.textContent = '🎤';
                // Reset status only if AI is not speaking
                setTimeout(() => {
                    if (!speechSynthesis.speaking) {
                        voiceStatus.textContent = "Nhấn Mic để Bắt đầu Nói...";
                    }
                }, 500);
            };

            recognition.onerror = (event) => {
                 isRecording = false; // Ensure state is reset
                 micWave.classList.remove('listening');
                 voiceMicIcon.textContent = '🎤';
                if(event.error === 'not-allowed'){
                    voiceStatus.innerHTML = `Lỗi: Bạn đã chặn quyền truy cập micro.<br>Vui lòng nhấn vào biểu tượng 🔒 trên thanh địa chỉ để cấp lại quyền.`;
                } else if (event.error === 'no-speech') {
                     voiceStatus.textContent = 'Không nhận dạng được giọng nói. Vui lòng thử lại.';
                } else if (event.error === 'network'){
                     voiceStatus.textContent = 'Lỗi mạng khi nhận dạng giọng nói.';
                }
                 else {
                    voiceStatus.textContent = `Lỗi: ${event.error}`;
                 }
                // Automatically close overlay after error
                 setTimeout(() => {
                    voiceOverlay.style.display = 'none';
                    voiceStatus.textContent = 'Nhấn Mic để Bắt đầu Nói...'; // Reset prompt
                 }, 4000);
            };
        } else {
             // Hide voice button if browser doesn't support it
             voiceBtn.style.display = 'none';
             console.warn("Web Speech Recognition API not supported in this browser.");
        }


        function speak(text, lang) {
            return new Promise((resolve, reject) => {
                speechSynthesis.cancel(); // Cancel any previous speech
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang; // Use the full lang code (e.g., 'vi-VN')
                utterance.rate = 1.0; // Normal speaking rate

                utterance.onstart = () => voiceStatus.textContent = "AI Đang Phản Hồi...";
                utterance.onend = () => {
                    voiceStatus.textContent = "Nhấn Mic để Bắt đầu Nói..."; // Reset after speaking
                    resolve();
                };
                utterance.onerror = (e) => {
                    console.error("Speech Synthesis Error:", e);
                    voiceStatus.textContent = `Lỗi phát âm: ${e.error}`;
                    reject(e);
                };

                 // Add a small delay before speaking to ensure UI updates
                setTimeout(() => speechSynthesis.speak(utterance), 100);
            });
        }


        async function handleVoiceQuery(transcript, langCode) {
            voiceStatus.textContent = "AI Đang Xử Lý...";
            try {
                // Determine short language code (e.g., 'vi') for the chat API
                const shortLang = langCode.split('-')[0];
                const responseData = await callApi('/api/chat', { message: transcript, image: null, language: shortLang });

                // Extract plain text from potential HTML response for speaking
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = responseData.response;
                const aiReplyText = tempDiv.textContent || tempDiv.innerText || "";

                if (!aiReplyText || aiReplyText.startsWith('❌')) {
                    throw new Error(aiReplyText || "AI did not provide a valid response.");
                }

                await speak(aiReplyText, langCode); // Use full lang code for speaking

            } catch (error) {
                console.error("Voice Query Error:", error);
                const errorMessageToSpeak = error.message.includes('HTTP Error') ? "Sorry, there was a problem connecting to the AI." :
                                           error.message.startsWith('❌') ? error.message.substring(2) :
                                           "Sorry, an error occurred while processing your request.";
                await speak(errorMessageToSpeak, langCode); // Speak the error in the detected language
            }
             // Increment usage count regardless of success/error in voice mode
            incrementUsageCount();
        }


        voiceBtn.addEventListener('click', () => {
            if (mainInput.disabled) return; // Don't open if locked
            if (!recognition) {
                 alert("Trình duyệt của bạn không hỗ trợ nhận dạng giọng nói.");
                 return;
            }
            // Check for secure context (HTTPS or localhost) - required for microphone access
            if (!window.isSecureContext && window.location.protocol !== 'http:') {
                alert('Chức năng giọng nói yêu cầu kết nối an toàn (HTTPS) hoặc chạy trên localhost.');
                return;
            }
            // Reset state before opening
            voiceStatus.textContent = "Nhấn Mic để Bắt đầu Nói...";
            micWave.classList.remove('listening');
            voiceMicIcon.textContent = '🎤';
            voiceOverlay.style.display = 'flex';
        });


        voiceMicIcon.addEventListener('click', () => {
            if (!recognition) return; // Should not happen if button is visible
            if (isRecording) {
                recognition.stop(); // Manually stop recording
            } else {
                // Set language based on dropdown
                const langMap = {'vi': 'vi-VN', 'en': 'en-US', 'zh-CN': 'zh-CN'};
                recognition.lang = langMap[languageSelect.value] || 'vi-VN';
                try {
                    recognition.start(); // Start listening
                } catch(e) {
                    // Catch potential errors like microphone already in use
                    voiceStatus.textContent = `Lỗi: ${e.message}. Micro có thể đang bận.`;
                    console.error("Recognition start error:", e);
                }
            }
        });


        voiceCloseBtn.addEventListener('click', () => {
            if(isRecording) recognition.stop(); // Stop recording if active
            speechSynthesis.cancel(); // Stop speaking if active
            voiceOverlay.style.display = 'none'; // Close overlay
        });


        function playIntro() {
            setTimeout(() => {
                introScreen.style.opacity = '0';
                introAudio.play().catch(e => {}); // Play sound, ignore error if browser blocks autoplay
                setTimeout(() => {
                    introScreen.style.display = 'none';
                    appWrapper.style.opacity = '1';
                    document.body.style.overflow = 'auto'; // Allow scrolling after intro
                }, 1000); // Wait for fade out
            }, 6000); // Intro duration
        }

        // --- Core Chat Logic (History, Message Handling, API Calls) ---
        function saveHistoryToStorage() { localStorage.setItem('ai_pro_history', JSON.stringify(chatHistory)); }
        function loadHistoryFromStorage() { const storedHistory = localStorage.getItem('ai_pro_history'); if (storedHistory) { chatHistory = JSON.parse(storedHistory); } }

        function startNewChat() {
            const newId = `chat_${Date.now()}`; activeChatId = newId;
            chatHistory[activeChatId] = { title: 'New Conversation', messages: [] };
            chatBox.innerHTML = `<div class="welcome-message"><h2>Welcome to AI Assistant Pro</h2><p>How can I help you today?</p></div>`;
            renderChatHistory(); saveHistoryToStorage();
            document.querySelector('.mode-btn[data-mode="chat"]')?.click(); // Reset to chat mode
        }

        function loadChat(chatId) {
            if (!chatHistory[chatId]) return;
            activeChatId = chatId; chatBox.innerHTML = '';
            const messages = chatHistory[chatId].messages;
            if (messages.length === 0) {
                 chatBox.innerHTML = `<div class="welcome-message"><h2>Welcome back!</h2><p>Continue your conversation.</p></div>`;
            } else {
                messages.forEach(msg => appendMessage(msg.content, msg.type, false)); // Don't re-save loaded messages
            }
            renderChatHistory();
             document.querySelector('.mode-btn[data-mode="chat"]')?.click(); // Reset to chat mode
        }

        function renderChatHistory() {
            chatHistoryContainer.innerHTML = '';
            Object.keys(chatHistory).sort((a, b) => b.localeCompare(a)).forEach(chatId => { // Newest first
                const chat = chatHistory[chatId];
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item'; historyItem.textContent = chat.title; historyItem.dataset.chatId = chatId;
                if (chatId === activeChatId) historyItem.classList.add('active');
                historyItem.addEventListener('click', () => loadChat(chatId));
                chatHistoryContainer.appendChild(historyItem);
            });
        }

         function updateChatTitle(firstUserMessage, isImageOnly = false) {
             const currentChat = chatHistory[activeChatId];
             if (currentChat && currentChat.title === 'New Conversation') {
                 let newTitle = "Untitled Chat"; // Default if no text
                 if (firstUserMessage) {
                     newTitle = firstUserMessage.substring(0, 30) + (firstUserMessage.length > 30 ? '...' : '');
                 } else if (isImageOnly) {
                     newTitle = "Image Analysis"; // Specific title for image-only input
                 }
                 currentChat.title = newTitle;
                 renderChatHistory();
                 saveHistoryToStorage();
             }
         }


        // --- Event Listeners ---
        newChatBtn.addEventListener('click', () => { startNewChat(); if(sidebar.classList.contains('open')) sidebar.classList.remove('open'); });
        menuBtn.addEventListener('click', () => sidebar.classList.toggle('open'));
        settingsBtn.addEventListener('click', () => settingsModal.style.display = settingsModal.style.display === 'block' ? 'none' : 'block');
        // Close modals on outside click
        document.addEventListener('click', (e) => {
             if (sidebar.classList.contains('open') && !sidebar.contains(e.target) && e.target !== menuBtn) sidebar.classList.remove('open');
             if (settingsModal.style.display === 'block' && !settingsModal.contains(e.target) && e.target !== settingsBtn) settingsModal.style.display = 'none';
        });

        modeButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (button.disabled) return; // Prevent changing mode if locked
                modeButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentChatMode = button.dataset.mode;
                // Update placeholder text
                switch(currentChatMode) {
                    case 'summarize_youtube': mainInput.placeholder = 'Paste YouTube video URL here...'; break;
                    case 'edit_image': mainInput.placeholder = 'Upload image & describe desired changes...'; break;
                    case 'notetaker': mainInput.placeholder = 'Paste text for note-taking...'; break;
                    case 'math': mainInput.placeholder = 'Enter math problem or upload image...'; break;
                    case 'image': mainInput.placeholder = 'Describe the image you want to create...'; break;
                    case 'video': mainInput.placeholder = 'Describe the short video/GIF...'; break;
                    default: mainInput.placeholder = 'Ask me anything...';
                }
                 // Show/Hide file input based on mode
                fileInput.labels[0].style.display = ['chat', 'math', 'edit_image'].includes(currentChatMode) ? 'flex' : 'none';
            });
        });

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) { uploadedFile = null; previewContainer.innerHTML = ''; return; }
            const reader = new FileReader();
            reader.onloadend = () => { uploadedFile = reader.result; previewContainer.innerHTML = `<img src="${reader.result}" alt="preview">`; };
            reader.onerror = () => { alert("Error reading file."); uploadedFile = null; previewContainer.innerHTML = ''; }
            reader.readAsDataURL(file);
        });

        // --- Main Send Function ---
        const handleSendMessage = async () => {
            if (!checkUsageLimit()) return; // Check limit before proceeding

            const prompt = mainInput.value.trim();
            const image = uploadedFile; // Use the stored base64 image

            // Specific check for edit_image mode
            if (currentChatMode === 'edit_image' && !image) {
                alert("Please upload an image before describing edits.");
                return;
            }
             // General check for input
            if (!prompt && !image && !['chat', 'math'].includes(currentChatMode)) { // Allow image-only for chat/math
                 alert("Please provide input (text or image).");
                 return;
            }
             if (!prompt && currentChatMode === 'summarize_youtube') {
                 alert("Please paste a YouTube URL.");
                 return;
             }
             if (!prompt && currentChatMode === 'notetaker') {
                  alert("Please paste the text to summarize.");
                  return;
             }


            if (document.querySelector('.welcome-message')) document.querySelector('.welcome-message').remove(); // Remove welcome message

            // Prepare user message display content
            let userMessageContent = prompt;
            if (image) {
                // Display image preview within the user bubble
                userMessageContent = `<img src="${image}" style="max-height: 100px; max-width: 150px; border-radius: 8px; display:block; margin-bottom: 5px;" alt="uploaded"><p>${prompt || (currentChatMode === 'edit_image' ? 'Edit this image' : 'Analyze this image')}</p>`;
            }

            appendMessage(userMessageContent || "[Image Sent]", 'user'); // Display user message
            updateChatTitle(prompt, !prompt && !!image); // Update title (pass true if image only)
            const loadingBubble = showLoading(); // Show AI typing indicator

            // Store current values before clearing
            const currentPromptValue = prompt;
            const currentImageValue = image;

            // Clear input fields immediately
            mainInput.value = '';
            previewContainer.innerHTML = '';
            uploadedFile = null;
            fileInput.value = ''; // Reset file input element
            mainInput.style.height = 'auto'; // Reset textarea height

            try {
                let responseData;
                let finalContent = ''; // Variable to store the final HTML for the bubble

                switch (currentChatMode) {
                    case 'image': // Use Pollinations directly
                        responseData = await callApi('/api/pollinations-image', { prompt: currentPromptValue });
                        finalContent = `<img src="${responseData.imageUrl}" class="generated-image">`;
                        break;
                    case 'edit_image': // Step 1: Gemini generates prompt, Step 2: Pollinations generates image
                        loadingBubble.querySelector('.bubble').innerHTML = 'Generating edit description...';
                        const descriptionResponse = await callApi('/api/edit-image', { message: currentPromptValue, image: currentImageValue });
                        const newPrompt = descriptionResponse.response;
                         if (newPrompt.startsWith('❌')) throw new Error(newPrompt); // Handle Gemini error

                        loadingBubble.querySelector('.bubble').innerHTML = 'Generating edited image...';
                        const imageResponse = await callApi('/api/pollinations-image', { prompt: newPrompt });
                        finalContent = `<p><strong>Generated based on:</strong> ${newPrompt}</p><img src="${imageResponse.imageUrl}" class="generated-image">`;
                        break;
                    case 'math': // Use Gemini
                        responseData = await callApi('/api/math', { question: currentPromptValue, image: currentImageValue });
                        finalContent = responseData.response;
                        loadingBubble.querySelector('.bubble').innerHTML = finalContent; // Update bubble content
                        MathJax.typesetPromise([loadingBubble]); // Render LaTeX *after* updating content
                        break; // MathJax handles rendering, skip setting finalContent again
                    case 'summarize_youtube': // Use Gemini via specific endpoint
                        responseData = await callApi('/api/summarize-youtube', { youtubeUrl: currentPromptValue });
                        finalContent = responseData.response;
                        break;
                    case 'notetaker': // Use Gemini via specific endpoint
                        responseData = await callApi('/api/summarize-text', { textToSummarize: currentPromptValue });
                        finalContent = responseData.response;
                        break;
                    case 'video': // Use Pollinations frames endpoint
                        loadingBubble.querySelector('.bubble').innerHTML = 'Generating video frames...';
                        responseData = await callApi('/api/pollinations-frames', { prompt: currentPromptValue });
                        if (!responseData.frames || responseData.frames.length === 0) throw new Error('No video frames received.');
                        loadingBubble.querySelector('.bubble').innerHTML = 'Rendering GIF...';
                        const videoUrl = await createGifFromFrames(responseData.frames);
                        finalContent = `<img src="${videoUrl}" class="generated-video" alt="Generated Video">`;
                        break;
                    default: // 'chat' mode (Use Gemini)
                        responseData = await callApi('/api/chat', { message: currentPromptValue, image: currentImageValue, language: languageSelect.value });
                        finalContent = responseData.response;
                        break;
                }

                // Update the bubble content, unless handled by specific logic (like MathJax)
                 if (currentChatMode !== 'math') {
                    loadingBubble.querySelector('.bubble').innerHTML = finalContent;
                 }

                saveMessage(loadingBubble.querySelector('.bubble').innerHTML, 'ai'); // Save the final AI message content
                incrementUsageCount(); // Increment usage only on successful response

            } catch (error) {
                console.error("Error in handleSendMessage:", error);
                const errorMessage = `❌ Lỗi: ${error.message}`;
                loadingBubble.querySelector('.bubble').textContent = errorMessage; // Display error in bubble
                saveMessage(errorMessage, 'ai'); // Save error message to history
                // Do not increment usage count on error
            }
        };

        // --- Attach Event Listeners ---
        sendBtn.addEventListener('click', handleSendMessage);
        mainInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } });

        // --- Helper Functions ---
        function appendMessage(content, type, save = true) {
            const group = document.createElement('div');
            group.className = `message-group ${type}`;
            group.innerHTML = `<div class="avatar avatar-${type}">${type === 'user' ? 'U' : 'AI'}</div><div class="bubble">${content}</div>`;
            chatBox.appendChild(group);
            // Scroll to bottom with a slight delay to allow rendering
             setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 50);
            if (save) saveMessage(content, type);
            return group;
        }
        function saveMessage(content, type) { if (activeChatId && chatHistory[activeChatId]) { chatHistory[activeChatId].messages.push({ type, content }); saveHistoryToStorage(); } }
        function showLoading() {
            const group = document.createElement('div');
            group.className = 'message-group ai';
            group.innerHTML = `<div class="avatar avatar-ai">AI</div><div class="bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
            chatBox.appendChild(group);
             setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 50);
            return group;
        }

       async function callApi(endpoint, body) {
           const serverUrl = window.location.origin; // Use relative path
           try {
               const response = await fetch(`${serverUrl}${endpoint}`, {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify(body),
               });
               const responseBody = await response.text(); // Get raw response text first
               if (!response.ok) {
                   // Try to parse JSON error first, fallback to text
                   try {
                       const errorJson = JSON.parse(responseBody);
                       // Prefer specific error messages if available
                       throw new Error(errorJson.response || errorJson.message || `Server error ${response.status}`);
                   } catch (e) {
                        // If not JSON or parsing fails, use the raw text
                        throw new Error(responseBody || `Server error ${response.status}`);
                   }
               }
                // If response is OK, parse JSON
               return JSON.parse(responseBody);
           } catch (error) {
               // Handle network errors or errors thrown above
               console.error(`API call to ${endpoint} failed:`, error);
                // Make error message more user-friendly
               throw new Error(`Failed to communicate with the server: ${error.message}`);
           }
       }

        function createGifFromFrames(frames) {
             return new Promise((resolve, reject) => {
                 if (!frames || frames.length === 0) {
                     return reject(new Error("No frames provided to create GIF."));
                 }
                 const gif = new GIF({ workers: 2, quality: 10, width: 512, height: 512 });
                 const imagePromises = frames.map(frameData => new Promise(resolveImg => {
                     const img = new Image();
                     img.crossOrigin = "anonymous";
                     img.src = frameData; // Assuming frameData is a base64 URL
                     img.onload = () => resolveImg(img);
                     img.onerror = () => { console.warn("Failed to load a frame for GIF"); resolveImg(null); }; // Don't break everything if one frame fails
                 }));
                 Promise.all(imagePromises).then(imageElements => {
                     const validImages = imageElements.filter(img => img);
                     if (validImages.length === 0) return reject(new Error("Could not load any valid frames for GIF."));
                     validImages.forEach(img => gif.addFrame(img, { delay: 100 })); // 100ms delay per frame
                     gif.on('finished', (blob) => {
                         const url = URL.createObjectURL(blob);
                         resolve(url);
                     });
                     gif.render();
                 }).catch(reject); // Catch errors during image loading
             });
        }

        // Auto-resize textarea
        mainInput.addEventListener('input', () => { mainInput.style.height = 'auto'; mainInput.style.height = (mainInput.scrollHeight) + 'px'; });

        // --- Initialize App ---
        function initializeApp() {
            playIntro(); // Start intro animation and sound
            loadHistoryFromStorage(); // Load past chats
            if (Object.keys(chatHistory).length === 0) startNewChat(); // Start new if no history
            else loadChat(Object.keys(chatHistory).sort().pop()); // Load latest chat
            renderChatHistory(); // Display chat history list
            checkUsageLimit(); // Check and apply usage limits
             // Set initial placeholder and file input visibility
            document.querySelector('.mode-btn[data-mode="chat"]').click();
        }
        initializeApp(); // Run initialization
    });
    </script>
</body>
</html>