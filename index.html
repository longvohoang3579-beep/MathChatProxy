<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Assistant Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* --- Giữ nguyên toàn bộ CSS từ file doc --- */ [cite: 1515-1673]
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        :root { --primary-yellow: #facc15; --dark-bg: #0a0a0c; --main-bg: #141417; --input-bg: #1f1f23; --bubble-ai-bg: #2d2d33; --bubble-user-bg: linear-gradient(135deg, #5e5ce6, #2563eb); --text-primary: #e4e4e7; --text-secondary: #a1a1aa; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--main-bg); } ::-webkit-scrollbar-thumb { background-color: #4a4a52; border-radius: 10px; border: 2px solid var(--main-bg); }
        body { background-color: var(--dark-bg); background-image: radial-gradient(circle at 1% 1%, rgba(255, 255, 255, 0.04) 1px, transparent 0), radial-gradient(circle at 99% 99%, rgba(255, 255, 255, 0.04) 1px, transparent 0); background-size: 50px 50px; color: var(--text-primary); font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow: hidden; }
        #intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: var(--dark-bg); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 1; transition: opacity 1s ease-in-out 6s; }
        .intro-container { position: relative; display: flex; align-items: center; justify-content: center; }
        #intro-yellow-flash { position: absolute; width: 100vw; height: 100vh; background-color: var(--primary-yellow); animation: yellowFlash 2s ease-in-out forwards; } @keyframes yellowFlash { 0% { transform: scale(0); border-radius: 50%; } 50% { transform: scale(1); border-radius: 0; } 100% { transform: scale(1); border-radius: 0; opacity: 0; } }
        #intro-text { position: relative; color: #fff; font-size: 3rem; font-weight: bold; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); opacity: 0; animation: logoAnimate 4s ease-in-out 1.5s forwards; }
        #intro-text::after { content: ''; position: absolute; top: 0; left: -10%; width: 20%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent); transform: skewX(-25deg); opacity: 0; animation: shine 1.5s ease-in-out 3s forwards; }
        #intro-burst { position: absolute; width: 1px; height: 1px; background: white; border-radius: 50%; opacity: 0; animation: burst 1s ease-out 5s forwards; } @keyframes logoAnimate { 0% { opacity: 0; transform: scale(2); } 25% { opacity: 1; transform: scale(1); } 75% { opacity: 1; transform: scale(1); } 100% { opacity: 1; transform: scale(1.1); } } @keyframes shine { 0% { left: -10%; opacity: 1; } 100% { left: 110%; opacity: 1; } } @keyframes burst { from { opacity: 1; transform: scale(0); box-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px var(--primary-yellow), 0 0 30px var(--primary-yellow); } to { opacity: 0; transform: scale(200); box-shadow: 0 0 50px #fff, 0 0 75px var(--primary-yellow); } }
        #app-wrapper { display: flex; height: 100vh; opacity: 0; transition: opacity 0.5s ease-in; position: relative; z-index: 1; }
        mark.highlight { background-color: var(--primary-yellow); color: black; font-weight: bold; padding: 2px 5px; border-radius: 4px; }
        #sidebar { width: 260px; background-color: var(--dark-bg); border-right: 1px solid #27272a; padding: 1rem; display: flex; flex-direction: column; transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); position: fixed; left: 0; top: 0; height: 100%; z-index: 100; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        #sidebar.open { transform: translateX(0); }
        .social-btn { background-color: #2d2d33; border: 1px solid #444; color: white; padding: 0.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; } .social-btn:hover { background-color: #444; border-color: var(--primary-yellow); }
        #new-chat-btn { background-color: transparent; border: 1px solid var(--primary-yellow); color: var(--primary-yellow); width: 100%; text-align: center; transition: all 0.2s ease; margin-top: 1rem; } #new-chat-btn:hover { background-color: var(--primary-yellow); color: var(--dark-bg); }
        .history-item { padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-secondary); transition: all 0.2s; border-left: 3px solid transparent; } .history-item:hover { background-color: var(--main-bg); color: var(--text-primary); } .history-item.active { background-color: #27272a; color: white; font-weight: 500; border-left-color: var(--primary-yellow); }
        #chat-container { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; max-width: 900px; margin: 0 auto; padding: 1rem; transition: margin-left 0.4s cubic-bezier(0.25, 1, 0.5, 1); margin-left: auto; margin-right: auto; position: relative; }
        #sidebar.open ~ #chat-container { margin-left: 260px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 0 0.5rem; position: relative; z-index: 50; }
        .menu-btn, #settings-btn { font-size: 1.8rem; cursor: pointer; color: var(--primary-yellow); z-index: 51; transition: transform 0.2s; }
        .menu-btn:hover, #settings-btn:hover { transform: scale(1.1); }
        .chat-box { background: transparent; padding: 1rem; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; scroll-behavior: smooth; margin-top: 1rem; gap: 1rem; }
        .message-group { display: flex; gap: 12px; max-width: 90%; } .message-group.user { align-self: flex-end; flex-direction: row-reverse; } .message-group.ai { align-self: flex-start; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background: #444; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-top: 4px; } .avatar-user { background: #5e5ce6; color: white; } .avatar-ai { background: var(--primary-yellow); color: #111; }
        @keyframes fadeInBubble { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } } .bubble { padding: 12px 18px; border-radius: 18px; line-height: 1.6; word-wrap: break-word; white-space: pre-wrap; animation: fadeInBubble 0.3s ease-out forwards; box-shadow: 0 4px 15px rgba(0,0,0,0.2); } .user .bubble { background: var(--bubble-user-bg); color: white; border-bottom-right-radius: 4px; } .ai .bubble { background: var(--bubble-ai-bg); color: var(--text-primary); border-bottom-left-radius: 4px; }
        .welcome-message { text-align: center; color: var(--text-secondary); padding: 2rem 1rem; animation: fadeInBubble 0.5s ease; } .welcome-message h2 { font-size: 1.8rem; font-weight: bold; color: var(--text-primary); }
        .typing-indicator { display: flex; align-items: center; gap: 5px; } .typing-indicator span { width: 8px; height: 8px; background-color: #777; border-radius: 50%; animation: typing 1s infinite; } .typing-indicator span:nth-child(2) { animation-delay: 0.2s; } .typing-indicator span:nth-child(3) { animation-delay: 0.4s; } @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        pre { background-color: #0d1117; color: #c9d1d9; padding: 1rem; border-radius: 8px; overflow-x: auto; border: 1px solid #30363d; font-size: 0.9em; } code { font-family: 'Courier New', Courier, monospace; }
        .input-area { margin-top: 1rem; padding: 0.5rem; background: var(--main-bg); border-radius: 1rem; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); }
        .mode-selector { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; justify-content: center; position: relative; }
        .mode-btn { background: #2d3748; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; border: 2px solid transparent; font-size: 0.9rem; color: var(--text-secondary); } .mode-btn:hover:not(:disabled) { background: #4a5568; color: var(--text-primary); } .mode-btn.active { border-color: var(--primary-yellow); background-color: #374151; color: var(--primary-yellow); font-weight: 500; } .mode-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .hidden-modes { position: absolute; bottom: 100%; right: 0; left: 0; background: var(--main-bg); border-radius: 10px; padding: 10px; margin-bottom: 8px; box-shadow: 0 -5px 15px rgba(0,0,0,0.3); display: flex; flex-wrap: wrap; gap: 8px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out, border-width 0.3s ease-in-out; border: 1px solid transparent; z-index: 10; justify-content: center; }
        .hidden-modes.open { max-height: 300px; border: 1px solid #333; padding: 10px; }
        .mode-selector > .mode-btn { padding: 0.5rem 1.5rem; }
        #mode-expand-btn { background: #2d3748; color: var(--primary-yellow); border-radius: 50%; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; line-height: 1; transition: transform 0.3s ease; z-index: 11; }
        #mode-expand-btn:hover { background: #4a5568; transform: rotate(90deg); }
        .input-row { display: flex; align-items: flex-end; gap: 0.75rem; background: var(--input-bg); padding: 0.5rem; border-radius: 0.75rem; border: 1px solid #333; transition: border-color 0.2s; } .input-row:focus-within { border-color: var(--primary-yellow); }
        textarea:disabled { opacity: 0.6; cursor: not-allowed; }
        .icon-btn:disabled, .send-btn:disabled { opacity: 0.5; cursor: not-allowed !important; transform: none !important; background-color: #2d3748 !important; color: var(--text-secondary) !important; }
        textarea { width: 100%; padding: 0.6rem; border-radius: 0.5rem; background: transparent; border: none; color: white; resize: none; outline: none; max-height: 200px; font-size: 1rem; line-height: 1.5; }
        .icon-btn, .send-btn { background: transparent; padding: 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: none; color: var(--text-secondary); flex-shrink: 0; } .icon-btn:hover:not(:disabled) { color: var(--primary-yellow); background: #374151; } .send-btn { background: var(--primary-yellow); color: var(--dark-bg); } .send-btn:hover:not(:disabled) { transform: scale(1.1); }
        .pending-preview { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; padding: 0.5rem; } .pending-preview img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #475569; }
        img.generated-image, .generated-video { border-radius: 12px; max-width: 100%; margin-top: 1rem; display: block; max-height: 400px; margin-left: auto; margin-right: auto; }
        #settings-modal { position: absolute; top: 3rem; right: 1rem; width: 200px; background: var(--main-bg); border: 1px solid var(--primary-yellow); border-radius: 0.75rem; padding: 1rem; display: none; z-index: 100; }
        #voice-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(5px); z-index: 1500; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .mic-wave-container { width: 200px; height: 200px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; } .mic-wave-container.listening .wave { animation: ripple 1.5s ease-out infinite; } .mic-wave-container .wave { position: absolute; width: 100%; height: 100%; border: 4px solid var(--primary-yellow); border-radius: 50%; opacity: 0; } .mic-wave-container .wave:nth-child(2) { animation-delay: 0.3s; } .mic-wave-container .wave:nth-child(3) { animation-delay: 0.6s; } @keyframes ripple { from { transform: scale(0.5); opacity: 1; } to { transform: scale(1.5); opacity: 0; } }
        .mic-icon { font-size: 3rem; color: #111; background-color: var(--primary-yellow); border-radius: 50%; padding: 20px; z-index: 10; cursor: pointer; }
        #limit-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 2000; display: none; align-items: center; justify-content: center; flex-direction: column; } #password-form { background: var(--main-bg); padding: 2.5rem; border-radius: 1rem; text-align: center; border: 3px solid var(--primary-yellow); box-shadow: 0 0 30px rgba(250, 204, 21, 0.3); }
        .summary-actions { margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem; border-top: 1px solid #444; padding-top: 0.75rem; }
        .summary-btn { background-color: #374151; color: #e5e7eb; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem; cursor: pointer; transition: background-color 0.2s; border: none; }
        .summary-btn:hover:not(:disabled) { background-color: #4b5563; }
        .summary-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        /* --- Hết CSS --- */
    </style>
    <script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>
</head>
<body>
    <div id="intro-screen">
        <div class="intro-container">
            <div id="intro-yellow-flash"></div>
            <div id="intro-text">AI Assistant Pro</div>
            <div id="intro-burst"></div>
        </div>
    </div>
    <audio id="intro-audio" src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAAAAAACAAAARGF2aW5jaCBSZXNvbHZlMTguMS4z/+xDEgAAMDlQGVoAABAQAASxRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPkAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPkAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPkAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMYoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPkAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMYoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMYoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPkAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMPkAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//+xDEgAAMFoAAGVoAABAQAAQyRAUIgABAAAEwAABAIAADSAAAAQAAA0AAAQIECBAgQIED/L9//" preload="auto"></audio>
    <div id="limit-overlay" class="fixed inset-0 bg-black bg-opacity-95 z-[2000] flex items-center justify-center flex-col hidden">
        <div id="password-form" class="bg-main-bg p-10 rounded-xl text-center border-2 border-primary-yellow shadow-lg shadow-yellow-500/20">
             <h2 class="text-2xl font-bold mb-4 text-yellow-500">Đã hết lượt sử dụng miễn phí hôm nay!</h2>
             <p id="limit-message" class="mb-6 text-gray-300">Vui lòng nhập mật khẩu để mở khóa sử dụng không giới hạn:</p>
             <input type="password" id="password-input" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-yellow-500 outline-none" placeholder="Mật khẩu">
             <button id="unlock-btn" class="mt-4 p-3 bg-yellow-500 text-black font-bold rounded-lg w-full hover:bg-yellow-600 transition">Mở khóa Vô Hạn</button>
             <p id="password-message" class="mt-3 text-red-500 hidden"></p>
        </div>
    </div>
     <div id="voice-overlay" class="fixed inset-0 bg-black bg-opacity-90 backdrop-blur-sm z-[1500] flex flex-col items-center justify-center text-white hidden">
        <div class="mic-wave-container" id="mic-wave">
            <div class="wave"></div><div class="wave"></div><div class="wave"></div>
            <div class="mic-icon" id="voice-mic-icon">🎤</div>
        </div>
        <p id="voice-status" class="mt-6 text-xl font-medium text-yellow-500">Nhấn Mic để Bắt đầu Nói...</p>
        <button id="voice-close-btn" class="mt-10 p-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition">Tắt Chức Năng Giọng Nói</button>
    </div>

    <div id="app-wrapper" class="flex h-screen opacity-0 transition-opacity duration-500 ease-in relative z-[1]">
        <aside id="sidebar" class="w-64 bg-dark-bg border-r border-gray-800 p-4 flex flex-col fixed left-0 top-0 h-full z-[100] shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out sm:translate-x-0">
             <div class="social-login-container mb-4 flex gap-3">
                 <button onclick="alert('Đăng nhập Google đang phát triển!')" class="social-btn w-10 h-10 flex items-center justify-center"><i class="fab fa-google"></i></button>
                 <button onclick="alert('Đăng nhập Facebook đang phát triển!')" class="social-btn w-10 h-10 flex items-center justify-center"><i class="fab fa-facebook-f"></i></button>
                 <button onclick="alert('Đăng nhập GitHub đang phát triển!')" class="social-btn w-10 h-10 flex items-center justify-center"><i class="fab fa-github"></i></button>
             </div>
             <button id="new-chat-btn" class="py-2 px-4 rounded-lg font-medium border border-yellow-500 text-yellow-500 hover:bg-yellow-500 hover:text-dark-bg transition w-full mt-4">＋ Cuộc trò chuyện mới</button>
             <h2 class="text-gray-400 text-sm font-bold mt-6 mb-2 uppercase">Lịch sử</h2>
             <div id="chat-history" class="flex-grow overflow-y-auto space-y-1 pr-2"></div>
             <div id="usage-counter" class="text-center text-sm text-gray-400 mt-auto pt-4 border-t border-gray-700">Đang tải lượt sử dụng...</div>
        </aside>

        <main id="chat-container" class="flex-grow flex flex-col h-screen max-w-4xl mx-auto p-4 transition-all duration-300 ease-in-out sm:ml-64">
            <div class="header relative flex justify-between items-center px-2">
                 <button id="menu-btn" class="menu-btn sm:hidden">☰</button> <div class="flex-grow"></div>
                 <button id="settings-btn" class="menu-btn">⚙️</button>
                 <div id="settings-modal" class="absolute top-10 right-0 w-52 bg-main-bg border border-yellow-500 rounded-lg p-4 z-[100] hidden shadow-lg">
                     <label class="block mb-2 text-sm font-medium text-gray-300">Ngôn ngữ Chat:</label>
                     <select id="language-select" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600 focus:ring-yellow-500 focus:border-yellow-500 outline-none">
                         <option value="vi">Tiếng Việt</option>
                         <option value="en">English</option>
                         <option value="zh-CN">简体中文</option>
                     </select>
                 </div>
            </div>
            <div id="chatBox" class="chat-box flex-grow overflow-y-auto p-4 space-y-4">
                </div>
            <div class="input-area mt-4 p-2 bg-main-bg rounded-xl shadow-inner">
                <div class="mode-selector flex flex-wrap gap-2 justify-center mb-3 relative">
                     <button class="mode-btn active" data-mode="chat" title="Trò chuyện"><span>💬 Chat</span></button>
                     <button id="mode-expand-btn" class="icon-btn w-10 h-10 flex items-center justify-center rounded-full text-xl leading-none" title="Chức năng mở rộng">
                        <span id="expand-icon">+</span>
                    </button>
                     <div id="hidden-modes" class="hidden-modes absolute bottom-full left-0 right-0 mb-2 bg-main-bg p-3 rounded-lg shadow-lg border border-gray-700 flex flex-wrap gap-2 justify-center max-h-0 overflow-hidden transition-all duration-300 ease-out z-10">
                        <button class="mode-btn" data-mode="persona" title="Nhập vai nhân vật"><span>🎭 Nhập Vai</span></button>
                        <button class="mode-btn" data-mode="image" title="Tạo ảnh"><span>🖼️ Tạo Ảnh</span></button>
                        <button class="mode-btn" data-mode="math" title="Giải toán"><span>🧮 Giải Toán</span></button>
                        <button class="mode-btn" data-mode="video" title="Tạo video"><span>🎥 Tạo Video</span></button>
                        <button class="mode-btn" data-mode="edit_image" title="Chỉnh sửa ảnh"><span>✍️ Sửa Ảnh</span></button>
                        <button class="mode-btn" data-mode="summarize_youtube" title="Tóm tắt YouTube"><span>▶️ Tóm Tắt YT</span></button>
                        <button class="mode-btn" data-mode="notetaker" title="Ghi chú văn bản"><span>📝 Ghi Chú</span></button>
                        <button class="mode-btn" data-mode="analyze_stock" title="Phân tích Chứng khoán"><span>📈 Chứng Khoán</span></button>
                    </div>
                </div>
                <div id="previewContainer" class="pending-preview flex gap-2 flex-wrap mb-2 px-2"></div>
                <div class="input-row flex items-end gap-2 bg-input-bg p-2 rounded-lg border border-gray-700 focus-within:border-yellow-500 transition-colors">
                    <label id="fileInputLabel" class="icon-btn flex items-center justify-center w-10 h-10 rounded-lg cursor-pointer hover:bg-gray-700" for="fileInput" title="Tải ảnh">
                         <i class="fas fa-paperclip"></i>
                    </label>
                    <input type="file" id="fileInput" accept="image/*" class="hidden" />
                    <button id="voiceBtn" class="icon-btn flex items-center justify-center w-10 h-10 rounded-lg hover:bg-gray-700" title="Trò chuyện bằng giọng nói">
                         <i class="fas fa-microphone"></i>
                    </button>
                    <textarea id="mainInput" class="flex-grow bg-transparent text-white resize-none outline-none p-2 rounded-lg max-h-40 text-base leading-snug" rows="1" placeholder="Ask me anything..."></textarea>
                    <button id="sendBtn" class="send-btn flex items-center justify-center w-10 h-10 rounded-lg bg-yellow-500 text-dark-bg hover:bg-yellow-400 transition-transform transform hover:scale-110">
                         <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Khai báo biến DOM ---
        const getEl = (id) => document.getElementById(id);
        const introScreen = getEl('intro-screen'), appWrapper = getEl('app-wrapper'), introAudio = getEl('intro-audio');
        const sidebar = getEl('sidebar'), menuBtn = getEl('menu-btn'), chatContainer = getEl('chat-container'), chatBox = getEl('chatBox'), mainInput = getEl('mainInput'), sendBtn = getEl('sendBtn'), fileInput = getEl('fileInput'), fileInputLabel = getEl('fileInputLabel'), previewContainer = getEl('previewContainer'), languageSelect = getEl('language-select'), settingsBtn = getEl('settings-btn'), settingsModal = getEl('settings-modal'), newChatBtn = getEl('new-chat-btn'), chatHistoryContainer = getEl('chat-history');
        const voiceBtn = getEl('voiceBtn'), voiceOverlay = getEl('voice-overlay'), voiceCloseBtn = getEl('voice-close-btn'), voiceStatus = getEl('voice-status'), voiceMicIcon = getEl('voice-mic-icon'), micWave = getEl('mic-wave');
        const limitOverlay = getEl('limit-overlay'), passwordInput = getEl('password-input'), unlockBtn = getEl('unlock-btn'), passwordMessage = getEl('password-message');
        const modeButtons = document.querySelectorAll('.mode-selector .mode-btn');
        const expandBtn = getEl('mode-expand-btn');
        const hiddenModesContainer = getEl('hidden-modes');
        const usageCounterEl = getEl('usage-counter');

        let currentChatMode = 'chat', uploadedFile = null, chatHistory = {}, activeChatId = null, isRecording = false;
        let currentPersonaDesc = localStorage.getItem('ai_pro_persona_desc') || '';
        let isModeExpanded = false;

        // === Logic Giới Hạn Hàng Ngày ===
        const MAX_DAILY_USES = 20;
        const UNLOCK_PASSWORD = "Hoang1082009@";
        let usageData = { count: 0, date: '', unlocked: false };
        function loadUsageData() {
            const today = new Date().toDateString(); // Sử dụng toDateString để chỉ so sánh ngày
            const storedData = JSON.parse(localStorage.getItem('ai_pro_usage_v3')) || { count: 0, date: '', unlocked: false };
            if (storedData.unlocked) {
                usageData = { ...storedData, date: today };
            } else if (storedData.date === today) {
                usageData = storedData;
            } else {
                usageData = { count: 0, date: today, unlocked: false };
            }
            saveUsageData(); // Lưu lại (đặc biệt là date mới)
            checkUsageLimit(); // Kiểm tra ngay khi tải
        }
        function saveUsageData() { localStorage.setItem('ai_pro_usage_v3', JSON.stringify(usageData)); updateUsageDisplay(); }
        function updateUsageDisplay() {
            if (!usageCounterEl) return;
            usageCounterEl.innerHTML = usageData.unlocked
                ? `<span class="text-green-400 font-bold">Vô hạn</span> | <a href="#" id="lock-limit" class="text-red-400 hover:text-red-300">Khóa Lại</a>`
                : `Còn lại: <span class="text-yellow-400 font-bold">${Math.max(0, MAX_DAILY_USES - usageData.count)}</span> lượt`;
            // Gắn lại sự kiện cho nút khóa (nếu có)
            document.getElementById('lock-limit')?.addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm("Bạn có chắc muốn khóa lại giới hạn sử dụng không?")) {
                    usageData.unlocked = false;
                    usageData.count = MAX_DAILY_USES; // Đặt về hết lượt để khóa ngay
                    saveUsageData();
                    checkUsageLimit(); // Cập nhật UI khóa
                }
            });
        }
        function checkUsageLimit() {
            const isLocked = !usageData.unlocked && usageData.count >= MAX_DAILY_USES;
            limitOverlay.style.display = isLocked ? 'flex' : 'none';
            const controls = [mainInput, sendBtn, voiceBtn, fileInput, ...modeButtons, expandBtn];
            controls.forEach(el => {
                if (el) {
                    el.disabled = isLocked;
                    const targetElement = el.tagName === 'INPUT' && el.type === 'file' ? fileInputLabel : el; // Nhắm vào label của file input
                    if (targetElement) {
                         targetElement.style.opacity = isLocked ? '0.5' : '1';
                         targetElement.style.cursor = isLocked ? 'not-allowed' : 'pointer';
                    }
                }
            });
             // Đảm bảo menu mode đóng khi bị khóa
             if (isLocked) toggleModeExpand(true);
            return !isLocked;
        }
        function incrementUsageCount() {
            if (!usageData.unlocked) {
                usageData.count++;
                saveUsageData(); // Lưu & cập nhật hiển thị
                checkUsageLimit(); // Kiểm tra lại nếu đã hết lượt
            }
        }
        unlockBtn.addEventListener('click', () => {
            if (passwordInput.value === UNLOCK_PASSWORD) {
                usageData.unlocked = true;
                usageData.date = new Date().toDateString();
                saveUsageData();
                checkUsageLimit(); // Gọi để ẩn overlay và bật lại nút
                passwordMessage.textContent = 'Mở khóa thành công!';
                passwordMessage.className = 'mt-3 text-green-500';
                passwordInput.value = ''; // Xóa pass sau khi đúng
                setTimeout(() => passwordMessage.textContent = '', 2000); // Ẩn thông báo thành công
            } else {
                passwordMessage.textContent = 'Mật khẩu sai.';
                passwordMessage.className = 'mt-3 text-red-500';
            }
        });

        // === Logic Intro Screen ===
        function playIntro() {
            introScreen.style.display = 'flex';
            try { introAudio.play().catch(e => {}); } catch(e) {}
            setTimeout(() => {
                introScreen.style.opacity = '0';
                appWrapper.style.opacity = '1';
                setTimeout(() => { introScreen.style.display = 'none'; }, 1000);
            }, 6000);
        }

        // === Logic Voice Chat ===
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let conversationMode = false;
        let silenceTimeout;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'vi-VN';
            recognition.onresult = (event) => { clearTimeout(silenceTimeout); const transcript = event.results[0][0].transcript; voiceStatus.textContent = `Bạn: "${transcript}"`; handleVoiceQuery(transcript, recognition.lang); };
            recognition.onend = () => { if (isRecording) { startListening(); } voiceMicIcon.classList.remove('animate-pulse'); micWave.classList.remove('listening'); isRecording = false; };
            recognition.onerror = (event) => { console.error("Speech Error:", event.error); voiceStatus.textContent = `Lỗi: ${event.error}`; isRecording = false; micWave.classList.remove('listening'); if (!conversationMode) setTimeout(() => voiceOverlay.style.display = 'none', 3000); };
        } else { voiceBtn.style.display = 'none'; }
        function startListening() {
             if (!recognition || isRecording) { if(isRecording) recognition.stop(); return; } // Dừng nếu đang ghi, thoát nếu chưa sẵn sàng
             voiceStatus.textContent = "Đang Nghe..."; voiceMicIcon.classList.add('animate-pulse'); micWave.classList.add('listening'); isRecording = true;
             recognition.lang = languageSelect.value === 'en' ? 'en-US' : (languageSelect.value === 'zh-CN' ? 'zh-CN' : 'vi-VN');
             recognition.start(); clearTimeout(silenceTimeout); silenceTimeout = setTimeout(() => { if (isRecording) recognition.stop(); voiceStatus.textContent = "Hết thời gian."; }, 7000);
        }
        function speak(text, lang) { return new Promise(resolve => { const u = new SpeechSynthesisUtterance(text); u.lang = lang.includes('-') ? lang : (lang === 'en' ? 'en-US' : (lang === 'zh-CN' ? 'zh-CN' : 'vi-VN')); u.onend = resolve; u.onerror = resolve; speechSynthesis.speak(u); }); }
        async function handleVoiceQuery(transcript, langCode) { /* Giữ nguyên logic gọi API và speak */
             voiceStatus.textContent = "AI Processing...";
            try {
                const shortLang = langCode.split('-')[0];
                const systemInstruction = getSystemInstruction(shortLang);
                const responseData = await callApi('/api/chat', { message: transcript, image: null, language: shortLang, systemInstruction: systemInstruction });
                const tempDiv = document.createElement('div'); tempDiv.innerHTML = responseData.response;
                const aiReplyText = tempDiv.textContent || tempDiv.innerText || "";
                if (!aiReplyText || aiReplyText.startsWith('❌')) throw new Error(aiReplyText || "AI response invalid.");
                await speak(aiReplyText, langCode);
            } catch (error) {
                const errorMsg = error.message.includes('HTTP Error') ? "Problem connecting." : error.message.startsWith('❌') ? error.message.substring(2) : "Error processing.";
                await speak(errorMsg, langCode);
            } finally {
                incrementUsageCount();
                if (conversationMode && !speechSynthesis.speaking) startListening();
                else if (!conversationMode) setTimeout(() => voiceOverlay.style.display = 'none', 500);
            }
        }
        voiceBtn.addEventListener('click', () => { if (!checkUsageLimit()) return; if (!recognition) return alert("Not supported."); if (!window.isSecureContext && window.location.protocol !== 'http:') return alert('Requires HTTPS/localhost.'); voiceOverlay.style.display = 'flex'; conversationMode = true; startListening(); });
        voiceMicIcon.addEventListener('click', () => { if (isRecording) recognition.stop(); else startListening(); });
        voiceCloseBtn.addEventListener('click', () => { conversationMode = false; if (isRecording) recognition.stop(); voiceOverlay.style.display = 'none'; });

        // === Flashcard/Mindmap ===
        function addSummaryActions(bubbleElement, summaryText) { /* Giữ nguyên */ }
        async function generateNotes(type, text, button) { /* Giữ nguyên */ }

        // === Cá nhân hóa AI ===
        function getSystemInstruction(lang) { /* Giữ nguyên */ }
        function setPersona(description) { /* Giữ nguyên */ }

        // --- Core Chat Logic ---
        function saveHistoryToStorage() { localStorage.setItem('ai_chat_history_v2', JSON.stringify(chatHistory)); }
        function loadHistoryFromStorage() { chatHistory = JSON.parse(localStorage.getItem('ai_chat_history_v2')) || {}; }

        function appendMessage(content, type, save = true) {
             const messageGroup = document.createElement('div'); messageGroup.className = `message-group ${type}`;
             const avatar = document.createElement('div'); avatar.className = `avatar avatar-${type}`; avatar.textContent = type === 'user' ? '👤' : '🤖';
             const bubble = document.createElement('div'); bubble.className = 'bubble'; bubble.innerHTML = content;
             messageGroup.appendChild(avatar); messageGroup.appendChild(bubble); chatBox.appendChild(messageGroup);
             setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 50); // Delay scroll
             if (save) saveMessage(content, type);
             return messageGroup;
        }
        function saveMessage(content, type) {
            if (!activeChatId || !chatHistory[activeChatId]) return;
            chatHistory[activeChatId].messages.push({ content, type, timestamp: Date.now() });
            saveHistoryToStorage();
        }
        function displayWelcomeMessage() {
            chatBox.innerHTML = `<div class="welcome-message"><h2>AI Assistant Pro 🤖</h2><p class="mt-4">How can I help you today?</p><p class="mt-2 text-sm text-gray-500">(Use the <span class="text-yellow-500 font-bold">+</span> button to explore features like Image Gen, Math, Persona...)</p></div>`;
        }
        function startNewChat() {
            activeChatId = `chat_${Date.now()}`;
            chatHistory[activeChatId] = { title: 'New Conversation', messages: [] };
            displayWelcomeMessage();
            renderChatHistory();
            saveHistoryToStorage();
            handleModeSelection('chat'); // Reset to chat mode
        }
        function loadChat(chatId) {
            if (!chatHistory[chatId]) return startNewChat(); // Start new if ID invalid
            activeChatId = chatId; chatBox.innerHTML = '';
            const messages = chatHistory[activeChatId].messages || [];
            if (messages.length === 0) displayWelcomeMessage();
            else messages.forEach(msg => appendMessage(msg.content, msg.type, false));
            renderChatHistory();
            handleModeSelection('chat'); // Reset to chat mode
        }
         function renderChatHistory() {
             chatHistoryContainer.innerHTML = '';
             const sortedKeys = Object.keys(chatHistory).sort((a, b) => parseInt(b.split('_')[1]) - parseInt(a.split('_')[1])); // Sort by timestamp desc
             sortedKeys.forEach(key => {
                 const chat = chatHistory[key];
                 // Chỉ hiển thị nếu có tin nhắn hoặc là chat mới nhất đang trống
                 if ((chat.messages && chat.messages.length > 0) || key === activeChatId) {
                     const item = document.createElement('div');
                     item.className = `history-item ${key === activeChatId ? 'active' : ''}`;
                     item.dataset.chatId = key;
                     // Lấy tiêu đề từ chat hoặc tạo tiêu đề mặc định
                     item.textContent = chat.title || 'New Conversation';
                     item.addEventListener('click', () => loadChat(key));
                     chatHistoryContainer.appendChild(item);
                 } else {
                     // Optionally delete empty chats that are not the current one
                     // delete chatHistory[key];
                 }
             });
             if (chatHistoryContainer.innerHTML === '') {
                  chatHistoryContainer.innerHTML = '<div class="text-center text-gray-500 mt-4">No history yet.</div>';
             }
         }
        function updateChatTitle(firstUserMessage, isImageOnly = false) {
             if (!activeChatId || !chatHistory[activeChatId]) return;
             // Chỉ cập nhật nếu là 'New Conversation'
             if (chatHistory[activeChatId].title === 'New Conversation') {
                 let newTitle = "Untitled";
                 if (firstUserMessage) newTitle = firstUserMessage.substring(0, 30) + (firstUserMessage.length > 30 ? '...' : '');
                 else if (isImageOnly) newTitle = "Image Input";
                 chatHistory[activeChatId].title = newTitle;
                 saveHistoryToStorage();
                 renderChatHistory(); // Cập nhật sidebar ngay lập tức
             }
        }
        function showLoading() { /* Giữ nguyên */ }
        async function callApi(endpoint, body) { /* Giữ nguyên */ }
        function createGifFromFrames(frames) { /* Giữ nguyên */ }

        // === Mode Selector Logic ===
        function toggleModeExpand(forceClose = false) { /* Giữ nguyên */ }
        expandBtn.addEventListener('click', (e) => { e.preventDefault(); toggleModeExpand(); });
        function handleModeSelection(selectedMode) { /* Giữ nguyên */ }
        modeButtons.forEach(button => { button.addEventListener('click', () => { if (!button.disabled) handleModeSelection(button.dataset.mode); }); });

        // === Main Send Function ===
        const handleSendMessage = async () => {
             if (!checkUsageLimit()) return;
             const prompt = mainInput.value.trim(); const image = uploadedFile;

             if (currentChatMode === 'persona' && !currentPersonaDesc) {
                  if (!prompt) { alert("Vui lòng nhập vai trò."); return; }
                  setPersona(prompt); mainInput.value = ''; mainInput.placeholder = `Chatting as ${currentPersonaDesc}...`; return;
             }
             if (currentChatMode === 'edit_image' && !image) { alert("Vui lòng tải ảnh."); return; }
             if (!prompt && currentChatMode === 'analyze_stock') { alert("Vui lòng nhập mã chứng khoán."); return; }
             if (!prompt && currentChatMode === 'summarize_youtube') { alert("Vui lòng dán URL YouTube."); return; }
             if (!prompt && currentChatMode === 'notetaker') { alert("Vui lòng dán văn bản."); return; }
             if (!prompt && !image && !['chat', 'math', 'persona'].includes(currentChatMode)) { return; }

             if (document.querySelector('.welcome-message')) document.querySelector('.welcome-message').remove();
             let userMsgContent = prompt;
             if (image && ['chat', 'math', 'edit_image', 'persona'].includes(currentChatMode)) {
                 userMsgContent = `<img src="${image}" style="max-height:100px; border-radius:8px; margin-bottom:5px; display:block;" alt="uploaded"><p>${prompt || 'Analyze/Edit'}</p>`;
             }
             appendMessage(userMsgContent || (image ? "[Image]" : "[Empty]"), 'user');
             updateChatTitle(prompt, !prompt && !!image);
             const loadingBubbleGroup = showLoading(); // Lưu lại group thay vì bubble
             const currentPromptValue = prompt; const currentImageValue = image;
             mainInput.value = ''; previewContainer.innerHTML = ''; uploadedFile = null; fileInput.value = ''; mainInput.style.height = 'auto';

            try {
                let responseData; let finalContent = ''; let isSummaryResult = false;
                let systemInstruction = getSystemInstruction(languageSelect.value);

                switch (currentChatMode) {
                    case 'image': responseData = await callApi('/api/pollinations-image', { prompt: currentPromptValue }); finalContent = `<img src="${responseData.imageUrl}" class="generated-image">`; break;
                    case 'edit_image':
                        loadingBubbleGroup.querySelector('.bubble').innerHTML = 'Generating edit description...';
                        systemInstruction = `Analyze image and user text. Generate ONLY a detailed English prompt for image generation...`;
                        const descRes = await callApi('/api/edit-image', { message: currentPromptValue, image: currentImageValue, systemInstruction });
                        const newPrompt = descRes.response; if (newPrompt.startsWith('❌')) throw new Error(newPrompt);
                        loadingBubbleGroup.querySelector('.bubble').innerHTML = 'Generating edited image...';
                        const imgRes = await callApi('/api/pollinations-image', { prompt: newPrompt });
                        finalContent = `<p><strong>Based on:</strong> ${newPrompt}</p><img src="${imgRes.imageUrl}" class="generated-image">`;
                        break;
                    case 'math': systemInstruction = `Solve math in Vietnamese...`; responseData = await callApi('/api/math', { question: currentPromptValue, image: currentImageValue, systemInstruction }); finalContent = responseData.response; break;
                    case 'summarize_youtube': responseData = await callApi('/api/summarize-youtube', { youtubeUrl: currentPromptValue }); finalContent = responseData.response; isSummaryResult = true; break;
                    case 'notetaker': systemInstruction = "You are a notetaker..."; responseData = await callApi('/api/summarize-text', { textToSummarize: currentPromptValue, systemInstruction }); finalContent = responseData.response; isSummaryResult = true; break;
                    case 'analyze_stock': responseData = await callApi('/api/analyze-stock', { stockSymbol: currentPromptValue }); finalContent = responseData.response; break;
                    case 'video':
                         loadingBubbleGroup.querySelector('.bubble').innerHTML = 'Generating frames...';
                         responseData = await callApi('/api/pollinations-frames', { prompt: currentPromptValue });
                         if (!responseData.frames || !Array.isArray(responseData.frames) || responseData.frames.length === 0) { throw new Error(responseData.message || 'Video frame gen failed.'); }
                         loadingBubbleGroup.querySelector('.bubble').innerHTML = 'Rendering GIF...';
                         const videoUrl = await createGifFromFrames(responseData.frames);
                         finalContent = `<img src="${videoUrl}" class="generated-video">`; break;
                    case 'persona': case 'chat':
                         responseData = await callApi('/api/chat', { message: currentPromptValue, image: currentImageValue, language: languageSelect.value, systemInstruction: systemInstruction });
                         finalContent = responseData.response; break;
                }

                const aiBubbleElement = loadingBubbleGroup.querySelector('.bubble');
                aiBubbleElement.innerHTML = finalContent; // Cập nhật nội dung vào bubble

                if (currentChatMode === 'math') { MathJax.typesetPromise([aiBubbleElement]); }
                if (isSummaryResult && !finalContent.startsWith('❌')) {
                    const tempDiv = document.createElement('div'); tempDiv.innerHTML = finalContent;
                    const summaryText = tempDiv.textContent || tempDiv.innerText || "";
                    addSummaryActions(aiBubbleElement, summaryText);
                }
                saveMessage(aiBubbleElement.innerHTML, 'ai'); // Lưu HTML cuối cùng
                incrementUsageCount();

            } catch (error) {
                loadingBubbleGroup.querySelector('.bubble').innerHTML = `❌ Error: ${error.message}`; // Hiển thị lỗi trong bubble
                saveMessage(loadingBubbleGroup.querySelector('.bubble').innerHTML, 'ai'); // Lưu lỗi
            }
        };

        // --- Event Listeners and Initializers ---
        sendBtn.addEventListener('click', handleSendMessage);
        mainInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } });
        mainInput.addEventListener('input', () => { mainInput.style.height = 'auto'; mainInput.style.height = (mainInput.scrollHeight) + 'px'; });
        fileInput.addEventListener('change', (event) => { /* Giữ nguyên */ });

        function initializeApp() {
            playIntro(); // THÊM LẠI INTRO
            loadHistoryFromStorage();
            if (Object.keys(chatHistory).length === 0) startNewChat();
            else loadChat(Object.keys(chatHistory).sort((a,b) => parseInt(b.split('_')[1]) - parseInt(a.split('_')[1]))[0]); // Load chat mới nhất
            
            renderChatHistory();
            loadUsageData(); // Load giới hạn
            
            const savedLang = localStorage.getItem('chat_language') || 'vi';
            languageSelect.value = savedLang;
            
            handleModeSelection('chat'); // Đặt mode mặc định
        }
        initializeApp();
    });
    </script>
</body>
</html>