<!DOCTYPE html>
<html lang="vi">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>Táº¡o áº¢nh & Chat Gemini</title>
Â  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
Â  Â  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

Â  <style>
Â  Â  body {
Â  Â  Â  background-color: #0f0f0f;
Â  Â  Â  color: white;
Â  Â  Â  font-family: "Segoe UI", sans-serif;
Â  Â  Â  margin: 0;
Â  Â  Â  padding-bottom: 60px;
Â  Â  }
Â  Â  .tab-btn {
Â  Â  Â  flex: 1;
Â  Â  Â  padding: 0.75rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  text-align: center;
Â  Â  Â  border-bottom: 3px solid transparent;
Â  Â  }
Â  Â  .tab-btn.active {
Â  Â  Â  border-color: #22c55e;
Â  Â  Â  color: #22c55e;
Â  Â  }
Â  Â  .generated-image-container {
Â  Â  Â  position: relative;
Â  Â  Â  text-align: center;
Â  Â  Â  max-width: 550px;
Â  Â  Â  margin: 0 auto;
Â  Â  }
Â  Â  /* Thiáº¿t láº­p khung chat */
Â  Â  .chat-message {
Â  Â  Â  padding: 0.5rem 1rem;
Â  Â  Â  border-radius: 0.75rem;
Â  Â  Â  margin-bottom: 0.5rem;
Â  Â  Â  max-width: 85%;
Â  Â  }
Â  Â  .user-message {
Â  Â  Â  background-color: #3b82f6; /* Blue */
Â  Â  Â  align-self: flex-end;
Â  Â  Â  margin-left: auto;
Â  Â  }
Â  Â  .ai-message {
Â  Â  Â  background-color: #4b5563; /* Gray */
Â  Â  Â  align-self: flex-start;
Â  Â  Â  margin-right: auto;
Â  Â  }
Â  Â  /* Fix cho MathJax Ä‘á»ƒ cÄƒn chá»‰nh Ä‘Ãºng */
Â  Â  .math-container p, .math-container div {
Â  Â  Â  white-space: normal !important;
Â  Â  }
Â  </style>
</head>

<body class="min-h-screen flex flex-col items-center p-5">
Â  <div class="w-full max-w-3xl bg-gray-900 rounded-2xl shadow-lg">
Â  Â  <div class="flex border-b border-gray-700">
Â  Â  Â  <div class="tab-btn active" id="tab-image">ğŸ–¼ï¸ Táº¡o áº¢nh</div>
Â  Â  Â  <div class="tab-btn" id="tab-chat">ğŸ’¬ Chat</div>
Â  Â  Â  <div class="tab-btn" id="tab-math">ğŸ§® Giáº£i ToÃ¡n</div>
Â  Â  </div>

Â  Â  Â  Â  <div id="content-image" class="p-5">
Â  Â  Â  <textarea id="imagePrompt" rows="3" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700"
Â  Â  Â  Â  placeholder="Nháº­p mÃ´ táº£ áº£nh báº¡n muá»‘n táº¡o..."></textarea>
Â  Â  Â  <button id="btnCreateImage" class="w-full mt-3 bg-green-600 py-2 rounded-lg font-bold hover:bg-green-700">Táº¡o áº¢nh</button>
Â  Â  Â  <div id="imageResult" class="mt-4 text-center"></div>
Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="content-chat" class="p-5 hidden flex flex-col h-96">
Â  Â  Â  <div id="chatHistory" class="flex-grow overflow-y-auto mb-4 p-2 flex flex-col">
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  <textarea id="chatPrompt" rows="2" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700"
Â  Â  Â  Â  placeholder="Nháº­p ná»™i dung chat..."></textarea>
Â  Â  Â  <button id="btnChat" class="w-full mt-3 bg-blue-600 py-2 rounded-lg font-bold hover:bg-blue-700">Gá»­i Chat</button>
Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="content-math" class="p-5 hidden">
Â  Â  Â  <textarea id="mathPrompt" rows="3" class="w-full p-3 bg-gray-800 rounded-lg border border-gray-700"
Â  Â  Â  Â  placeholder="Nháº­p bÃ i toÃ¡n cáº§n giáº£i..."></textarea>
Â  Â  Â  <button id="btnMath" class="w-full mt-3 bg-yellow-500 py-2 rounded-lg font-bold hover:bg-yellow-600">Giáº£i ToÃ¡n</button>
Â  Â  Â  <div id="mathResult" class="mt-4 text-gray-300 math-container"></div>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  // Biáº¿n toÃ n cá»¥c Ä‘á»ƒ lÆ°u lá»‹ch sá»­ chat
Â  Â  let chatHistory = [];
Â  Â  
Â  Â  // HÃ m chuyá»ƒn Ä‘á»•i Markdown cÆ¡ báº£n sang HTML (in Ä‘áº­m vÃ  xuá»‘ng dÃ²ng)
Â  Â  function markdownToHtml(text) {
Â  Â  Â  // 1. Chuyá»ƒn Ä‘á»•i **in Ä‘áº­m**
Â  Â  Â  let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
Â  Â  Â  // 2. Chuyá»ƒn Ä‘á»•i xuá»‘ng dÃ²ng
Â  Â  Â  html = html.replace(/\n/g, '<br>');
Â  Â  Â  return html;
Â  Â  }

Â  Â  // HÃ m hiá»ƒn thá»‹ tin nháº¯n trong khung chat
Â  Â  function appendMessage(sender, text) {
Â  Â  Â  const historyDiv = document.getElementById("chatHistory");
Â  Â  Â  const msgDiv = document.createElement("div");
Â  Â  Â  const htmlContent = markdownToHtml(text);
Â  Â  Â  
Â  Â  Â  msgDiv.classList.add("chat-message");
Â  Â  Â  
Â  Â  Â  if (sender === 'user') {
Â  Â  Â  Â  msgDiv.classList.add("user-message");
Â  Â  Â  Â  msgDiv.innerHTML = htmlContent;
Â  Â  Â  } else {
Â  Â  Â  Â  msgDiv.classList.add("ai-message");
Â  Â  Â  Â  msgDiv.innerHTML = htmlContent;
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  historyDiv.appendChild(msgDiv);
Â  Â  Â  // Cuá»™n xuá»‘ng dÆ°á»›i cÃ¹ng
Â  Â  Â  historyDiv.scrollTop = historyDiv.scrollHeight;
Â  Â  }

Â  Â  // ----- Tab chuyá»ƒn Ä‘á»•i (Giá»¯ nguyÃªn) -----
Â  Â  const tabs = document.querySelectorAll(".tab-btn");
Â  Â  const contents = {
Â  Â  Â  "tab-image": document.getElementById("content-image"),
Â  Â  Â  "tab-chat": document.getElementById("content-chat"),
Â  Â  Â  "tab-math": document.getElementById("content-math")
Â  Â  };

Â  Â  tabs.forEach(tab => {
Â  Â  Â  tab.addEventListener("click", () => {
Â  Â  Â  Â  tabs.forEach(t => t.classList.remove("active"));
Â  Â  Â  Â  Object.values(contents).forEach(c => c.classList.add("hidden"));
Â  Â  Â  Â  tab.classList.add("active");
Â  Â  Â  Â  contents[tab.id].classList.remove("hidden");
Â  Â  Â  Â  // Reset lá»‹ch sá»­ chat khi chuyá»ƒn tab (tÃ¹y chá»n)
Â  Â  Â  Â  if (tab.id !== 'tab-chat') {
Â  Â  Â  Â  Â  chatHistory = [];
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  });

Â  Â  // ğŸ–¼ï¸ Pollinations (Giá»¯ nguyÃªn)
Â  Â  document.getElementById("btnCreateImage").addEventListener("click", async () => {
Â  Â  Â  const prompt = document.getElementById("imagePrompt").value.trim();
Â  Â  Â  const resDiv = document.getElementById("imageResult");
Â  Â  Â  if (!prompt) return alert("Nháº­p mÃ´ táº£ áº£nh.");

Â  Â  Â  // Cáº­p nháº­t tráº¡ng thÃ¡i chá»
Â  Â  Â  resDiv.innerHTML = `<p class='text-gray-400 font-bold'>ÄANG Táº O áº¢NH...</p>`; 
Â  Â  Â  
Â  Â  Â  const res = await fetch("/api/pollinations-image", {
Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  body: JSON.stringify({ prompt })
Â  Â  Â  });
Â  Â  Â  const data = await res.json();
Â  Â  Â  resDiv.innerHTML = `
Â  Â  Â  Â  <div class="generated-image-container">
Â  Â  Â  Â  Â  <img src="${data.imageUrl}" class="rounded-lg w-full">
Â  Â  Â  Â  Â  <div class="image-watermark-cover"></div>
Â  Â  Â  Â  </div>`;
Â  Â  });

Â  Â  // ğŸ’¬ Chat (ÄÃƒ Cáº¬P NHáº¬T CHAT LIÃŠN Tá»¤C)
Â  Â  document.getElementById("btnChat").addEventListener("click", async () => {
Â  Â  Â  const prompt = document.getElementById("chatPrompt").value.trim();
Â  Â  Â  const historyDiv = document.getElementById("chatHistory");
Â  Â  Â  const btn = document.getElementById("btnChat");

Â  Â  Â  if (!prompt) return;

Â  Â  Â  // 1. ThÃªm tin nháº¯n ngÆ°á»i dÃ¹ng vÃ o lá»‹ch sá»­ vÃ  giao diá»‡n
Â  Â  Â  appendMessage('user', prompt);
Â  Â  Â  chatHistory.push({ role: "user", text: prompt });
Â  Â  Â  document.getElementById("chatPrompt").value = ''; // XÃ³a input

Â  Â  Â  // 2. Hiá»ƒn thá»‹ tráº¡ng thÃ¡i chá»
Â  Â  Â  const statusDiv = document.createElement("div");
Â  Â  Â  statusDiv.classList.add("ai-message", "text-gray-400", "font-bold");
Â  Â  Â  statusDiv.id = "chatStatus";
Â  Â  Â  statusDiv.textContent = "ÄANG TRáº¢ Lá»œI...";
Â  Â  Â  historyDiv.appendChild(statusDiv);
Â  Â  Â  historyDiv.scrollTop = historyDiv.scrollHeight;
Â  Â  Â  btn.disabled = true;

Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch("/api/chat", {
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  // ğŸ’¡ Gá»­i lá»‹ch sá»­ chat lÃªn server
Â  Â  Â  Â  Â  body: JSON.stringify({ message: prompt, history: chatHistory })
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await res.json();

Â  Â  Â  Â  // XÃ³a tráº¡ng thÃ¡i chá»
Â  Â  Â  Â  statusDiv.remove();

Â  Â  Â  Â  const reply = data.response || "âŒ KhÃ´ng cÃ³ pháº£n há»“i tá»« Gemini.";
Â  Â  Â  Â  
Â  Â  Â  Â  // 3. ThÃªm pháº£n há»“i AI vÃ o lá»‹ch sá»­ vÃ  giao diá»‡n
Â  Â  Â  Â  appendMessage('ai', reply);
Â  Â  Â  Â  chatHistory.push({ role: "assistant", text: reply }); 
Â  Â  Â  Â  
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  statusDiv.textContent = "âŒ Lá»—i káº¿t ná»‘i Ä‘áº¿n server.";
Â  Â  Â  Â  console.error(err);
Â  Â  Â  } finally {
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  }
Â  Â  });

Â  Â  // ğŸ§® Math (ÄÃƒ Cáº¬P NHáº¬T HIá»‚N THá»Š LATEX)
Â  Â  document.getElementById("btnMath").addEventListener("click", async () => {
Â  Â  Â  const question = document.getElementById("mathPrompt").value.trim();
Â  Â  Â  const resDiv = document.getElementById("mathResult");
Â  Â  Â  const btn = document.getElementById("btnMath");

Â  Â  Â  if (!question) return alert("Nháº­p bÃ i toÃ¡n.");
Â  Â  Â  
Â  Â  Â  resDiv.innerHTML = `<p class='text-gray-400 font-bold'>ÄANG TRáº¢ Lá»œI...</p>`;
Â  Â  Â  btn.disabled = true;

Â  Â  Â  try {
Â  Â  Â  Â  const res = await fetch("/api/math", {
Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  body: JSON.stringify({ question })
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  
Â  Â  Â  Â  const rawResponse = data.response || "âŒ KhÃ´ng cÃ³ pháº£n há»“i tá»« Gemini.";
Â  Â  Â  Â  
Â  Â  Â  Â  // 1. Chuyá»ƒn Ä‘á»•i Markdown vÃ  xuá»‘ng dÃ²ng
Â  Â  Â  Â  let htmlContent = markdownToHtml(rawResponse);

Â  Â  Â  Â  // 2. Hiá»ƒn thá»‹ ná»™i dung
Â  Â  Â  Â  resDiv.innerHTML = htmlContent;
Â  Â  Â  Â  
Â  Â  Â  Â  // 3. Gá»i MathJax Ä‘á»ƒ render LaTeX
Â  Â  Â  Â  MathJax.typesetPromise([resDiv]).catch((err) => console.error("MathJax Error:", err));

Â  Â  Â  } catch (err) {
Â  Â  Â  Â  resDiv.textContent = "âŒ Lá»—i káº¿t ná»‘i Ä‘áº¿n server.";
Â  Â  Â  Â  console.error(err);
Â  Â  Â  } finally {
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  }
Â  Â  });
Â  </script>
</body>
</html>