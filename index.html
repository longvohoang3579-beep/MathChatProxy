<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Assistant Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* --- Gi·ªØ nguy√™n to√†n b·ªô CSS c·ªßa b·∫°n --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        :root { --primary-yellow: #facc15; --dark-bg: #0a0a0c; /* ... */ }
        body { font-family: 'Inter', sans-serif; /* ... */ }
        .summary-actions { margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem; border-top: 1px solid #444; padding-top: 0.75rem; }
        .summary-btn { background-color: #374151; /* ... */ }
        .personality-selector { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .personality-selector label { font-size: 0.9rem; color: var(--text-secondary); }
        .personality-select { background-color: #2d3748; color: white; border: 1px solid #444; border-radius: 6px; padding: 0.3rem 0.5rem; font-size: 0.9rem; }
         /* Style cho avatar AI c√° nh√¢n h√≥a */
        .avatar-ai.marketing { background-color: #3b82f6; color: white; } /* Blue */
        .avatar-ai.tutor { background-color: #10b981; color: white; } /* Green */
        .avatar-ai.creative { background-color: #a855f7; color: white; } /* Purple */
        .avatar-ai.default { background: var(--primary-yellow); color: #111; } /* Default Yellow */
    </style>
    <script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>
</head>
<body>
    <audio id="intro-audio" src="data:audio/mpeg;base64,..."></audio>
    <div id="intro-screen">...</div>
    <div id="limit-overlay">...</div>
    <div id="voice-overlay">...</div>

    <div id="app-wrapper">
        <aside id="sidebar">
            <div class="social-login-container mb-4">...</div>
             <button id="new-chat-btn" class="p-3 rounded-lg font-bold">Ôºã New Conversation</button>
             <div class="personality-selector mt-6">
                 <label for="personality-select">AI Personality:</label>
                 <select id="personality-select" class="personality-select flex-grow">
                     <option value="default">Default Assistant</option>
                     <option value="marketing">üíº Marketing Pro</option>
                     <option value="tutor">üéì Academic Tutor</option>
                     <option value="creative">üé® Idea Creator</option>
                 </select>
             </div>
             <h2 class="text-gray-400 text-sm font-bold mt-4 mb-2 uppercase">History</h2>
             <div id="chat-history"></div>
             <div id="usage-counter" class="text-center text-sm text-gray-400 mt-auto pt-4 border-t border-gray-700">Loading usage...</div>
        </aside>

        <main id="chat-container">
            <div class="header relative">...</div>
            <div class="chat-box" id="chatBox"></div>
            <div class="input-area">
                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="chat" title="Tr√≤ chuy·ªán"><span>Chat</span></button>
                    <button class="mode-btn" data-mode="image" title="T·∫°o ·∫£nh"><span>T·∫°o ·∫¢nh</span></button>
                    <button class="mode-btn" data-mode="math" title="Gi·∫£i to√°n"><span>Gi·∫£i To√°n</span></button>
                    <button class="mode-btn" data-mode="video" title="T·∫°o video"><span>T·∫°o Video</span></button>
                    <button class="mode-btn" data-mode="edit_image" title="Ch·ªânh s·ª≠a ·∫£nh"><span>S·ª≠a ·∫¢nh</span></button>
                    <button class="mode-btn" data-mode="notetaker" title="Ghi ch√∫ vƒÉn b·∫£n"><span>Ghi Ch√∫</span></button>
                </div>
                <div class="pending-preview" id="previewContainer"></div>
                <div class="input-row">...</div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Gi·ªØ nguy√™n t·∫•t c·∫£ c√°c bi·∫øn DOM v√† logic c≈© ---
        const getEl = (id) => document.getElementById(id);
        const introScreen = getEl('intro-screen'), /*...*/ personalitySelect = getEl('personality-select'); // Th√™m personalitySelect

        let currentChatMode = 'chat', uploadedFile = null, chatHistory = {}, activeChatId = null, isRecording = false;
        let currentPersonality = 'default'; // Bi·∫øn l∆∞u personality ƒëang ch·ªçn

        // === Logic Gi·ªõi H·∫°n H√†ng Ng√†y (Gi·ªØ nguy√™n) ===
        // ...
        function loadUsageData() { /* ... */ }
        function saveUsageData() { /* ... */ }
        function checkUsageLimit() { /* ... */ }
        function incrementUsageCount() { /* ... */ }
        unlockBtn.addEventListener('click', () => { /* ... */ });

        // === Logic Voice Chat (Gi·ªØ nguy√™n) ===
        // ...
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let conversationMode = false;
        let silenceTimeout;
        if (SpeechRecognition) { /* ... */ }
        else { voiceBtn.style.display = 'none'; }
        function startListening() { /* ... */ }
        function speak(text, lang) { /* ... */ }
        async function handleVoiceQuery(transcript, langCode) {
            // G·ª≠i c·∫£ personality hi·ªán t·∫°i khi g·ªçi voice chat
            voiceStatus.textContent = "AI Processing...";
            try {
                const shortLang = langCode.split('-')[0];
                const systemInstruction = getSystemInstruction(currentPersonality, shortLang); // L·∫•y instruction theo personality
                const responseData = await callApi('/api/chat', { message: transcript, image: null, language: shortLang, systemInstruction: systemInstruction }); // G·ª≠i instruction
                // ... (x·ª≠ l√Ω response v√† speak)
            } catch (error) { /* ... */ }
            incrementUsageCount();
        }
        voiceBtn.addEventListener('click', () => { /* ... */ });
        voiceMicIcon.addEventListener('click', () => { /* ... */ });
        voiceCloseBtn.addEventListener('click', () => { /* ... */ });

        // === Logic Flashcard/Mindmap (Gi·ªØ nguy√™n) ===
        function addSummaryActions(bubbleElement, summaryText) { /* ... */ }

        // === Core Chat Logic (C·∫≠p nh·∫≠t) ===
        function playIntro() { /* ... Gi·ªØ nguy√™n ... */ }
        function saveHistoryToStorage() { /* ... Gi·ªØ nguy√™n ... */ }
        function loadHistoryFromStorage() { /* ... Gi·ªØ nguy√™n ... */ }
        function startNewChat() { /* ... Gi·ªØ nguy√™n ... */ }
        function loadChat(chatId) { /* ... Gi·ªØ nguy√™n ... */ }
        function renderChatHistory() { /* ... Gi·ªØ nguy√™n ... */ }
        function updateChatTitle(firstUserMessage, isImageOnly = false) { /* ... Gi·ªØ nguy√™n ... */ }

        // --- Event Listeners ---
        newChatBtn.addEventListener('click', () => { /* ... */ });
        menuBtn.addEventListener('click', () => { /* ... */ });
        settingsBtn.addEventListener('click', () => { /* ... */ });
        document.addEventListener('click', (e) => { /* ... */ }); // Close modals
        modeButtons.forEach(button => { /* ... Gi·ªØ nguy√™n logic c·∫≠p nh·∫≠t placeholder v√† file input visibility ... */ });
        fileInput.addEventListener('change', (event) => { /* ... Gi·ªØ nguy√™n ... */ });

        // === Logic C√° nh√¢n h√≥a AI (M·ªöI) ===
        function getSystemInstruction(personality, lang) {
            const langName = { 'vi': 'Ti·∫øng Vi·ªát', 'en': 'English', 'zh-CN': 'ÁÆÄ‰Ωì‰∏≠Êñá' }[lang] || 'Ti·∫øng Vi·ªát';
            let instruction = `You are a helpful AI assistant. Respond in **${langName}**. Keep answers concise, use markdown, highlight with <mark class="highlight">...</mark>. Analyze image if provided.`; // Default

            switch (personality) {
                case 'marketing':
                    instruction = `You are Marketing Pro AI. Respond in **${langName}** with creative marketing ideas, strategies, and copywriting tips. Be enthusiastic and focus on results. Analyze images for branding/marketing potential.`;
                    break;
                case 'tutor':
                    instruction = `You are an Academic Tutor AI. Respond in **${langName}**. Explain concepts clearly, provide step-by-step solutions (especially for math), and encourage learning. Be patient and supportive. Analyze images related to academic problems.`;
                    break;
                case 'creative':
                    instruction = `You are an Idea Creator AI. Respond in **${langName}**. Brainstorm unique and imaginative ideas for stories, art, projects, etc. Be playful and think outside the box. Use images as inspiration.`;
                    break;
            }
            return instruction;
        }

        personalitySelect.addEventListener('change', (e) => {
            currentPersonality = e.target.value;
            localStorage.setItem('ai_pro_personality', currentPersonality); // L∆∞u l·ª±a ch·ªçn
            // C·∫≠p nh·∫≠t avatar AI trong c√°c tin nh·∫Øn ƒë√£ hi·ªÉn th·ªã (n·∫øu mu·ªën)
            document.querySelectorAll('.avatar-ai').forEach(avatar => {
                avatar.className = `avatar avatar-ai ${currentPersonality}`; // Th√™m class m·ªõi
            });
             // C√≥ th·ªÉ th√™m l·ªùi ch√†o khi ƒë·ªïi personality
             appendMessage(`Switched to ${personalitySelect.options[personalitySelect.selectedIndex].text} personality!`, 'ai', false);
        });

        function loadPersonality() {
            const savedPersonality = localStorage.getItem('ai_pro_personality') || 'default';
            currentPersonality = savedPersonality;
            personalitySelect.value = currentPersonality;
        }


        // --- H√†m G·ª≠i Ch√≠nh (C·∫≠p nh·∫≠t ƒë·ªÉ g·ª≠i personality instruction) ---
        const handleSendMessage = async () => {
             if (!checkUsageLimit()) return;
             const prompt = mainInput.value.trim(); const image = uploadedFile;
             if (currentChatMode === 'edit_image' && !image) { alert("Please upload an image for editing."); return; }
             if (!prompt && !image) { return; }

             if (document.querySelector('.welcome-message')) document.querySelector('.welcome-message').remove();
             let userMessageContent = prompt;
             if (image) userMessageContent = `<img src="${image}" style="max-height: 100px; max-width: 150px; border-radius: 8px; display:block; margin-bottom: 5px;" alt="uploaded"><p>${prompt || 'Analyze/Edit this image'}</p>`;

             appendMessage(userMessageContent || "[Image Sent]", 'user');
             updateChatTitle(prompt, !prompt && !!image);
             const loadingBubble = showLoading(); // Hi·ªÉn th·ªã loading v·ªõi avatar m·∫∑c ƒë·ªãnh
             const currentPromptValue = prompt; const currentImageValue = image;
             mainInput.value = ''; previewContainer.innerHTML = ''; uploadedFile = null; fileInput.value = ''; mainInput.style.height = 'auto';

            try {
                let responseData;
                let finalContent = '';
                let isSummaryResult = false;
                let systemInstruction = getSystemInstruction(currentPersonality, languageSelect.value); // L·∫•y instruction theo personality

                switch (currentChatMode) {
                    case 'image':
                        responseData = await callApi('/api/pollinations-image', { prompt: currentPromptValue });
                        finalContent = `<img src="${responseData.imageUrl}" class="generated-image">`;
                        break;
                    case 'edit_image':
                        loadingBubble.querySelector('.bubble').innerHTML = 'Generating edit description...';
                        // G·ª≠i instruction ri√™ng cho edit_image
                        systemInstruction = `Analyze image and user text. Generate ONLY a detailed English prompt for an image generation model (like Pollinations) to create the edited image.`;
                        const descriptionResponse = await callApi('/api/edit-image', { message: currentPromptValue, image: currentImageValue, systemInstruction: systemInstruction });
                        const newPrompt = descriptionResponse.response;
                        if (newPrompt.startsWith('‚ùå')) throw new Error(newPrompt);
                        loadingBubble.querySelector('.bubble').innerHTML = 'Generating edited image...';
                        const imageResponse = await callApi('/api/pollinations-image', { prompt: newPrompt });
                        finalContent = `<p><strong>Generated based on:</strong> ${newPrompt}</p><img src="${imageResponse.imageUrl}" class="generated-image">`;
                        break;
                    case 'math':
                        // Math kh√¥ng d√πng personality, d√πng instruction ri√™ng
                        systemInstruction = `Solve math in Vietnamese. Show steps & final result. Use LaTeX ($...$) and <mark class="highlight">...</mark>. Analyze image if provided.`;
                        responseData = await callApi('/api/math', { question: currentPromptValue, image: currentImageValue, systemInstruction: systemInstruction });
                        finalContent = responseData.response;
                        break; // MathJax x·ª≠ l√Ω sau
                    case 'notetaker':
                        // Notetaker d√πng instruction ri√™ng
                        systemInstruction = "You are a notetaker. Extract key decisions, action items, main topics. Format in Vietnamese with headings (## Decisions, ## Actions, ## Topics) and bullets.";
                        responseData = await callApi('/api/summarize-text', { textToSummarize: currentPromptValue, systemInstruction: systemInstruction });
                        finalContent = responseData.response;
                        isSummaryResult = true;
                        break;
                     case 'video':
                         loadingBubble.querySelector('.bubble').innerHTML = 'Generating video frames...';
                         responseData = await callApi('/api/pollinations-frames', { prompt: currentPromptValue });
                         if (!responseData.frames || !Array.isArray(responseData.frames) || responseData.frames.length === 0) {
                              throw new Error(responseData.message || 'Video frame generation failed or not implemented.');
                         }
                         loadingBubble.querySelector('.bubble').innerHTML = 'Rendering GIF...';
                         const videoUrl = await createGifFromFrames(responseData.frames);
                         finalContent = `<img src="${videoUrl}" class="generated-video" alt="Generated Video">`;
                         break;
                    default: // chat (d√πng personality instruction)
                        responseData = await callApi('/api/chat', { message: currentPromptValue, image: currentImageValue, language: languageSelect.value, systemInstruction: systemInstruction });
                        finalContent = responseData.response;
                        break;
                }

                const aiBubbleElement = loadingBubble.querySelector('.bubble');
                const aiAvatarElement = loadingBubble.querySelector('.avatar-ai'); // L·∫•y avatar c·ªßa bubble loading

                aiBubbleElement.innerHTML = finalContent; // C·∫≠p nh·∫≠t n·ªôi dung
                aiAvatarElement.className = `avatar avatar-ai ${currentPersonality}`; // C·∫≠p nh·∫≠t class avatar theo personality

                if (currentChatMode === 'math') {
                     MathJax.typesetPromise([aiBubbleElement]);
                }
                if (isSummaryResult && !finalContent.startsWith('‚ùå')) {
                    addSummaryActions(aiBubbleElement, finalContent);
                }

                saveMessage(aiBubbleElement.innerHTML, 'ai'); // L∆∞u n·ªôi dung cu·ªëi c√πng
                incrementUsageCount();

            } catch (error) { /* ... Gi·ªØ nguy√™n x·ª≠ l√Ω l·ªói ... */
                 console.error("Error in handleSendMessage:", error);
                 const errorMessage = `‚ùå L·ªói: ${error.message}`;
                 loadingBubble.querySelector('.bubble').textContent = errorMessage;
                 saveMessage(errorMessage, 'ai');
            }
        };

        // --- Helper Functions (C·∫≠p nh·∫≠t appendMessage v√† showLoading ƒë·ªÉ d√πng personality) ---
        function appendMessage(content, type, save = true) {
            const group = document.createElement('div');
            group.className = `message-group ${type}`;
            const avatarClass = type === 'user' ? 'avatar-user' : `avatar-ai ${currentPersonality}`; // D√πng personality hi·ªán t·∫°i cho AI
            group.innerHTML = `<div class="avatar ${avatarClass}">${type === 'user' ? 'U' : 'AI'}</div><div class="bubble">${content}</div>`;
            chatBox.appendChild(group);
            setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 50);
            if (save) saveMessage(content, type);
            return group;
        }

        function showLoading() {
            const group = document.createElement('div');
            group.className = 'message-group ai';
            // Hi·ªÉn th·ªã avatar theo personality hi·ªán t·∫°i ngay c·∫£ khi loading
            group.innerHTML = `<div class="avatar avatar-ai ${currentPersonality}">AI</div><div class="bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
            chatBox.appendChild(group);
            setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 50);
            return group;
        }
        function saveMessage(content, type) { /* ... Gi·ªØ nguy√™n ... */ }
        async function callApi(endpoint, body) { /* ... Gi·ªØ nguy√™n ... */ }
        function createGifFromFrames(frames) { /* ... Gi·ªØ nguy√™n ... */ }
        mainInput.addEventListener('input', () => { /* ... Gi·ªØ nguy√™n ... */ });

        // --- Initialize App ---
        function initializeApp() {
            playIntro();
            loadHistoryFromStorage();
            loadPersonality(); // Load personality ƒë√£ l∆∞u
            if (Object.keys(chatHistory).length === 0) startNewChat();
            else loadChat(Object.keys(chatHistory).sort().pop());
            renderChatHistory();
            loadUsageData(); // Load v√† ki·ªÉm tra gi·ªõi h·∫°n
            document.querySelector('.mode-btn[data-mode="chat"]')?.click();
        }
        initializeApp();
    });
    </script>
</body>
</html>