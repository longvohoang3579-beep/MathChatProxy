<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Assistant Pro</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
  /* ====== Global ====== */
  :root{
    --bg:#0f0f13;
    --panel:#1a1c29;
    --muted:#9aa0b0;
    --gold:#ffd24d;
  }
  html,body { height:100%; margin:0; background:var(--bg); color:#fff; font-family:"Segoe UI",sans-serif; overflow:hidden; }

  /* ====== INTRO STYLES ====== */
  #intro-screen {
    position:fixed; inset:0; z-index:2000;
    background: linear-gradient(180deg,#050406 0%, #070507 60%, #000001 100%);
    display:flex; align-items:center; justify-content:center; flex-direction:column;
    transition:opacity .9s ease;
    overflow:hidden;
  }
  canvas#intro-canvas { position:absolute; inset:0; width:100%; height:100%; display:block; }

  #intro-content { position:relative; z-index:2010; text-align:center; pointer-events:none; }
  #intro-text {
    color:var(--gold); font-weight:800; font-size:3rem; letter-spacing:.6px;
    text-shadow: 0 0 18px rgba(255,215,0,0.8), 0 0 44px rgba(255,140,0,0.35);
    -webkit-background-clip: text; background-clip:text;
    animation: shimmer 2.6s linear infinite;
  }
  @keyframes shimmer {
    0%{ filter:brightness(1) saturate(1); text-shadow:0 0 14px rgba(255,220,120,0.6); }
    50%{ filter:brightness(1.25) saturate(1.2); text-shadow:0 0 30px rgba(255,240,160,0.95); }
    100%{ filter:brightness(1) saturate(1); text-shadow:0 0 14px rgba(255,220,120,0.6); }
  }
  #intro-subtext { color: #ffeecf; margin-top:.5rem; opacity:.9; pointer-events:none; }

  #intro-burst {
    position:absolute; inset:0; z-index:2020; pointer-events:none;
    background: radial-gradient(circle at 50% 40%, rgba(255,230,140,0.98), rgba(255,180,80,0.85) 20%, rgba(255,100,40,0.3) 45%, transparent 60%);
    opacity:0; mix-blend-mode:screen; transition:opacity .7s ease;
    transform:scale(1);
  }

  .intro-spark{
    position:absolute; width:6px; height:6px; border-radius:50%;
    box-shadow:0 0 10px rgba(255,210,120,0.9), 0 0 20px rgba(255,140,40,0.6);
    pointer-events:none; opacity:0.95; transform:translate(-50%,-50%);
  }

  /* shake class for strong explosion effect */
  .shake {
    animation: screenShake .45s cubic-bezier(.36,.07,.19,.97);
  }
  @keyframes screenShake {
    10%, 90% { transform: translate3d(-1px, 0, 0); }
    20%, 80% { transform: translate3d(2px, 0, 0); }
    30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
    40%, 60% { transform: translate3d(4px, 0, 0); }
  }

  /* ====== App UI (kept original look) ====== */
  .app-wrap { position:relative; width:100%; height:100%; display:flex; align-items:flex-start; justify-content:center; padding:28px; box-sizing:border-box; }
  .container { width:900px; background:var(--panel); border-radius:16px; padding:20px; box-shadow:0 15px 30px rgba(0,0,0,.7); display:none; box-sizing:border-box; }

  /* top bar: hamburger + title + settings */
  .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; position:relative; }
  .hamburger { display:flex; align-items:center; justify-content:center; width:44px; height:44px; background:#111217; border-radius:10px; cursor:pointer; }
  .hamburger:hover{ box-shadow:0 6px 18px rgba(0,0,0,0.6); }
  .logo-title { font-weight:700; font-size:1.1rem; color:var(--gold); text-shadow:0 0 8px rgba(255,200,80,0.25); }
  #settings-btn { position:relative; cursor:pointer; width:44px; height:44px; display:flex; align-items:center; justify-content:center; border-radius:10px; background:#111217; }

  /* slide menu */
  #side-menu {
    position:fixed; left:0; top:0; bottom:0; width:320px; background:linear-gradient(180deg,#0f1115,#0b0c0f);
    transform:translateX(-110%); transition:transform .32s ease; z-index:2100; box-shadow: 6px 0 30px rgba(0,0,0,0.6);
    padding:18px;
  }
  #side-menu.open { transform:translateX(0); }
  #side-menu h3{ color:var(--gold); margin:4px 0 10px; }
  .menu-btn{ display:block; padding:10px 12px; border-radius:8px; cursor:pointer; color:#dfe6f2; background:transparent; margin-bottom:8px; }
  .menu-btn:hover{ background:rgba(255,255,255,0.02); }

  /* tabs area: single chat with mode controls under input */
  .chat-area { display:flex; flex-direction:column; gap:12px; }
  .chat-box { background:#111827; border-radius:12px; padding:12px; height:420px; overflow:auto; display:flex; flex-direction:column; scroll-behavior:smooth; }
  .bubble { max-width:80%; padding:10px 14px; border-radius:12px; margin-bottom:10px; line-height:1.4; white-space:pre-wrap; }
  .user-bubble{ background:#2563eb; color:#fff; align-self:flex-end; border-bottom-right-radius:2px; }
  .ai-bubble{ background:#374151; color:#e5e7eb; align-self:flex-start; border-bottom-left-radius:2px; }
  .ai-bubble .title-large { display:block; font-size:1.05rem; font-weight:700; color:var(--gold); margin-bottom:6px; }
  .thumbnail { width:84px; height:84px; object-fit:cover; border-radius:8px; border:2px solid rgba(255,255,255,0.06); margin-top:8px; display:block; }

  .controls { display:flex; gap:8px; align-items:center; }
  .input-row { display:flex; gap:8px; align-items:center; margin-top:6px; }
  textarea { width:100%; min-height:46px; max-height:120px; resize:none; padding:10px; border-radius:10px; background:#1e1e2a; border:1px solid #333; color:#fff; }
  .send-btn { background:#6366f1; color:#fff; padding:10px 12px; border-radius:12px; cursor:pointer; display:flex; align-items:center; justify-content:center; }

  .mode-bar { margin-top:8px; display:flex; gap:8px; }
  .mode-btn { padding:8px 12px; border-radius:999px; background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--gold); cursor:pointer; }
  .mode-btn.active { background:linear-gradient(90deg,#ffdb7a,#ffb36a); color:#111; border:none; box-shadow:0 6px 18px rgba(255,180,60,0.12); }

  /* small icons */
  .icon-btn { width:40px; height:40px; border-radius:8px; background:#101217; display:flex; align-items:center; justify-content:center; cursor:pointer; }

  /* pending preview */
  .pending-preview{ display:flex; gap:8px; margin-top:6px; flex-wrap:wrap; }

  /* settings popover */
  #settings-modal { position:absolute; top:56px; right:4px; width:220px; background:var(--panel); border-radius:10px; padding:10px; border:1px solid rgba(250,200,21,0.12); display:none; z-index:2200; }
  #settings-modal.show{ display:block; }

  /* history list */
  .history-item{ padding:10px; border-radius:8px; margin-bottom:8px; cursor:pointer; background:transparent; color:#dfe6f2; }
  .history-item:hover{ background:rgba(255,255,255,0.02); }

  /* responsive */
  @media (max-width:980px){ .container{ width:92%; } }
  @media (max-width:640px){
    #intro-text{ font-size:1.6rem; }
    .container{ width:95%; padding:12px; }
    #side-menu{ width:86%; }
  }
</style>
</head>
<body>

<!-- INTRO -->
<div id="intro-screen" aria-hidden="false">
  <canvas id="intro-canvas"></canvas>

  <div id="intro-content">
    <div id="intro-text">AI Assistant Pro</div>
    <!-- no extra subtitle per request -->
  </div>

  <div id="intro-burst" aria-hidden="true"></div>
  <!-- dynamic sparks appended via JS -->
</div>

<!-- APP WRAPPER -->
<div class="app-wrap" aria-hidden="true">
  <!-- side menu (history/new chat) -->
  <div id="side-menu" aria-hidden="true">
    <h3>Menu</h3>
    <button class="menu-btn" id="new-chat-btn">🆕 New Chat</button>
    <div style="margin-top:12px;color:#bfc8d6;margin-bottom:8px;font-weight:600;">History</div>
    <div id="history-list" style="max-height:72vh; overflow:auto;"></div>
  </div>

  <!-- main container -->
  <div class="container" id="mainApp" aria-hidden="true">
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="hamburger" id="hamburger" title="Menu (New chat & History)">
          <!-- triple bars -->
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h16M4 17h16" stroke="#ffd24d" stroke-width="1.6" stroke-linecap="round"/></svg>
        </div>
        <div class="logo-title">AI Assistant Pro</div>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <div id="settings-btn" title="Settings (language)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z" stroke="#ffd24d" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 0 1 3.3 17.8l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09c.64 0 1.19-.27 1.51-1a1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 0 1 6.2 3.3l.06.06a1.65 1.65 0 0 0 1.82.33H8a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09c0 .64.27 1.19 1 1.51h.92a1.65 1.65 0 0 0 1.82-.33l.06-.06A2 2 0 0 1 20.7 6.2l-.06.06c-.38.38-.47 1.07-.33 1.82V9c0 .64.27 1.19 1 1.51H21a2 2 0 1 1 0 4h-.09c-.64 0-1.19.27-1.51 1z" stroke="#ffd24d" stroke-width="0.9" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>

        <div id="settings-modal">
          <label style="color:#dfe6f2;font-weight:600;font-size:0.9rem;margin-bottom:8px;display:block;">Language</label>
          <select id="language-select" style="width:100%;padding:8px;border-radius:8px;background:#0f1720;color:#fff;border:1px solid #2b3038;">
            <option value="en">English</option>
            <option value="vi">Tiếng Việt</option>
            <option value="zh">中文</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Chat area -->
    <div class="chat-area">
      <div class="chat-box" id="chatBox" aria-live="polite"></div>

      <!-- pending preview (uploaded thumbnails) -->
      <div class="pending-preview" id="pendingPreview"></div>

      <!-- input row -->
      <div class="input-row">
        <label class="icon-btn" title="Upload image/file">
          <input id="fileInput" type="file" accept="image/*,.pdf,.txt,.docx" style="display:none" />
          <svg id="fileIcon" width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M7 7v10a2 2 0 0 0 2 2h6" stroke="#ffd24d" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M20 7l-8-5-8 5v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7z" stroke="#ffd24d" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </label>

        <textarea id="chatInput" placeholder="Type a message..."></textarea>

        <button class="send-btn" id="sendBtn" title="Send">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M5 12l14 7-7-7 7-7-14 7z" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <!-- mode controls -->
      <div class="mode-bar" role="tablist" aria-label="Modes">
        <button class="mode-btn active" data-mode="chat">Chat</button>
        <button class="mode-btn" data-mode="image">Create Image</button>
        <button class="mode-btn" data-mode="video">Create Video</button>
        <button class="mode-btn" data-mode="math">Solve Math</button>
      </div>
    </div>
  </div>
</div>

<!-- GIF worker libs -->
<script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>
<script src="https://unpkg.com/gif.js@0.2.0/dist/gif.worker.js"></script>

<script>
/* ========= INTRO CANVAS (light blobs) & TIMING ========= */
(function introModule(){
  const canvas = document.getElementById('intro-canvas');
  const introScreen = document.getElementById('intro-screen');
  const burst = document.getElementById('intro-burst');
  const appWrap = document.querySelector('.app-wrap');
  const mainApp = document.getElementById('mainApp');

  const sparks = [];
  function resize(){
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resize);
  resize();
  const ctx = canvas.getContext('2d');

  // Light blob class - circular gradient moving on smooth orbits
  class Blob {
    constructor(cx,cy,orbitR,size,hue,spd,dir,off){
      this.cx=cx; this.cy=cy; this.orbitR=orbitR; this.size=size;
      this.hue=hue; this.spd=spd; this.dir=dir; this.off=off;
    }
    update(t){
      const ang = this.off + this.dir * t * this.spd;
      const x = this.cx + Math.cos(ang)*this.orbitR + Math.sin(t*this.spd*0.7)*18;
      const y = this.cy + Math.sin(ang*0.9)*this.orbitR*0.6 + Math.cos(t*this.spd*0.6)*12;
      const size = this.size * (1 + 0.1*Math.sin(ang*2 + t*0.8));
      this.draw(x,y,size);
    }
    draw(x,y,size){
      const g = ctx.createRadialGradient(x,y,0,x,y,size*1.6);
      g.addColorStop(0, `hsla(${this.hue},100%,65%,1)`);
      g.addColorStop(0.25, `hsla(${(this.hue+20)%360},100%,55%,0.85)`);
      g.addColorStop(0.6, `hsla(${(this.hue+40)%360},90%,45%,0.45)`);
      g.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.save();
      ctx.globalCompositeOperation='screen';
      ctx.fillStyle=g;
      ctx.beginPath(); ctx.arc(x,y,size,0,Math.PI*2); ctx.fill();
      ctx.globalCompositeOperation='lighter';
      ctx.strokeStyle='rgba(255,240,200,0.06)';
      ctx.lineWidth=Math.max(1, size*0.11);
      ctx.beginPath(); ctx.arc(x,y,size*1.04,0,Math.PI*2); ctx.stroke();
      ctx.restore();
    }
  }

  let blobs=[];
  function createBlobs(){
    blobs=[];
    const w=canvas.width, h=canvas.height;
    const centers = [{cx:w*0.25, cy:h*0.35},{cx:w*0.78, cy:h*0.65}];
    const sets = [[40,24,12],[12,28,48]];
    centers.forEach((c,i)=>{
      sets[i].forEach((hue,j)=>{
        blobs.push(new Blob(c.cx,c.cy, Math.min(w,h)*(0.12+0.06*j+Math.random()*0.04), 38+Math.random()*40, hue + Math.random()*8 -4, 0.55+Math.random()*0.75, Math.random()>0.5?1:-1, Math.random()*Math.PI*2));
      });
    });
    // satellites
    for(let k=0;k<8;k++){
      blobs.push(new Blob(w*0.5 + (Math.random()*w - w/2)*0.55, h*0.5 + (Math.random()*h - h/2)*0.35, 20 + Math.random()*180, 8 + Math.random()*18, 30 + Math.random()*40, 0.8+Math.random()*1.2, Math.random()>0.5?1:-1, Math.random()*Math.PI*2));
    }
  }
  createBlobs();

  // spawn tiny DOM sparks for metallic shimmer
  function spawnSparks(){
    const count = Math.min(90, Math.max(30, Math.round(window.innerWidth/18)));
    for(let i=0;i<count;i++){
      const el = document.createElement('div');
      el.className='intro-spark';
      el.style.left = (Math.random()*100)+'%';
      el.style.top = (10 + Math.random()*70)+'%';
      const scale = 0.6 + Math.random()*1.6;
      el.style.width = (4*scale)+'px';
      el.style.height = (4*scale)+'px';
      el.style.opacity = (0.35 + Math.random()*0.8);
      el.style.transition = `transform ${5+Math.random()*6}s ease-in-out, opacity ${6+Math.random()*4}s linear`;
      document.getElementById('intro-screen').appendChild(el);
      setTimeout(()=> {
        const dx=(Math.random()-0.5)*240; const dy=(Math.random()-0.5)*120;
        el.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
        el.style.opacity = (0.1 + Math.random()*0.6);
      }, 60 + Math.random()*400);
      // remove after max lifetime
      setTimeout(()=> el.remove(), 11000);
      sparks.push(el);
    }
  }
  spawnSparks();

  // render loop
  let start = performance.now();
  let running = true;
  function render(now){
    if(!running) return;
    const t = (now - start)/1000;
    ctx.clearRect(0,0,canvas.width, canvas.height);
    // subtle dark base
    const vg = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
    vg.addColorStop(0,'#050406'); vg.addColorStop(1,'#070507');
    ctx.fillStyle=vg; ctx.fillRect(0,0,canvas.width,canvas.height);
    // update blobs
    for(const b of blobs) b.update(t);
    // radial sheen
    ctx.globalCompositeOperation='lighter';
    const cx = canvas.width*0.52, cy = canvas.height*0.45;
    const largeG = ctx.createRadialGradient(cx,cy,0,cx,cy,Math.max(canvas.width, canvas.height)*0.6);
    largeG.addColorStop(0,'rgba(255,220,140,0.035)');
    largeG.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=largeG; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.globalCompositeOperation='source-over';
    requestAnimationFrame(render);
  }
  requestAnimationFrame(render);

  // TIMING: 6s visible then strong burst + shake then fade out
  const VISIBLE = 6000;
  setTimeout(()=> {
    // show burst
    burst.style.opacity='1';
    // intensify sparks outward
    document.querySelectorAll('.intro-spark').forEach(s=>{
      s.style.transitionDuration = (0.45 + Math.random()*0.6)+'s';
      const dx = (Math.random()-0.5)*900; const dy=(Math.random()-0.5)*600;
      s.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px)) scale(1.6)`;
      s.style.opacity = '1';
    });

    // apply strong shake to body/container for explosion
    document.body.classList.add('shake');
    setTimeout(()=> document.body.classList.remove('shake'), 420);

    // keep burst briefly then fade everything
    setTimeout(()=> {
      burst.style.transition='opacity .9s ease';
      burst.style.opacity='0';
      introScreen.style.opacity='0';
      running = false; // stop canvas loop
      // hide after fade
      setTimeout(()=> {
        introScreen.style.display='none';
        // show app
        mainApp.style.display='block';
        appWrap.style.overflow='auto';
        document.body.style.overflow='auto';
        // append welcome message (English) to chat
        window.APP && window.APP.postIntroReady && window.APP.postIntroReady();
      }, 900);
    }, 650);

  }, VISIBLE);

  // Expose function to stop intro early (if needed)
  window.runIntro = function(){ /* already running by default */ };

})();

/* ========= APP LOGIC: single chat area with modes, menu, history, upload, API stubs ========= */
document.addEventListener('DOMContentLoaded', () => {
  const mainApp = document.getElementById('mainApp');
  const chatBox = document.getElementById('chatBox');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');
  const fileInput = document.getElementById('fileInput');
  const pendingPreview = document.getElementById('pendingPreview');

  const modeButtons = document.querySelectorAll('.mode-btn');
  let currentMode = 'chat'; // chat|image|video|math

  const hamburger = document.getElementById('hamburger');
  const sideMenu = document.getElementById('side-menu');
  const newChatBtn = document.getElementById('new-chat-btn');
  const historyList = document.getElementById('history-list');

  const settingsBtn = document.getElementById('settings-btn');
  const settingsModal = document.getElementById('settings-modal');
  const languageSelect = document.getElementById('language-select');

  // Simple app state: current conversation id & history store
  const STORAGE_KEY = 'ai_assistant_history_v1';
  let conversations = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  let currentConversation = { id: Date.now(), title: 'New chat', messages: [] };

  function saveConversation(conv){
    // if exists replace; else push
    const idx = conversations.findIndex(c=>c.id===conv.id);
    if(idx>=0) conversations[idx]=conv;
    else conversations.unshift(conv);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(conversations));
    renderHistory();
  }

  function renderHistory(){
    historyList.innerHTML = '';
    conversations.forEach(conv=>{
      const div = document.createElement('div');
      div.className = 'history-item';
      div.textContent = conv.title || ('Chat ' + new Date(conv.id).toLocaleString());
      div.onclick = ()=> {
        // load conversation into UI
        loadConversation(conv.id);
        sideMenu.classList.remove('open');
      };
      historyList.appendChild(div);
    });
  }

  function newConversation(){
    currentConversation = { id: Date.now(), title: 'New chat', messages: [] };
    renderChat();
  }

  function loadConversation(id){
    const conv = conversations.find(c=>c.id===id);
    if(!conv) return;
    currentConversation = JSON.parse(JSON.stringify(conv));
    renderChat();
  }

  function renderChat(){
    chatBox.innerHTML = '';
    for(const m of currentConversation.messages){
      const b = makeBubble(m.from, m.text, m.meta);
      chatBox.appendChild(b);
    }
    // scroll
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function makeBubble(from, text, meta){
    const div = document.createElement('div');
    div.className = 'bubble ' + (from==='user' ? 'user-bubble' : 'ai-bubble');
    if(from==='ai'){
      // show greeting large title if meta.greeting
      if(meta && meta.greeting){
        const t = document.createElement('span');
        t.className = 'title-large';
        t.textContent = 'AI Assistant Pro';
        div.appendChild(t);
      }
    }
    const p = document.createElement('div');
    p.innerHTML = text;
    div.appendChild(p);
    if(meta && meta.thumbnail){
      const img = document.createElement('img');
      img.className = 'thumbnail';
      img.src = meta.thumbnail;
      div.appendChild(img);
    }
    return div;
  }

  // initial rendering
  renderHistory();
  newConversation();

  // post-intro ready hook to send greeting
  window.APP = window.APP || {};
  window.APP.postIntroReady = function(){
    // show greeting from AI in English
    const greeting = "Hello! I’m AI Assistant Pro — your intelligent companion.\nWhat would you like to explore today?";
    const aiMsg = { from:'ai', text: greeting, meta:{ greeting:true } };
    currentConversation.messages.push(aiMsg);
    saveConversation(currentConversation);
    renderChat();
  };

  // Mode selection
  modeButtons.forEach(btn=>{
    btn.addEventListener('click', ()=> {
      modeButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentMode = btn.dataset.mode;
      // subtle placeholder change
      if(currentMode==='chat') chatInput.placeholder='Type a message...';
      if(currentMode==='image') chatInput.placeholder='Describe the image to create...';
      if(currentMode==='video') chatInput.placeholder='Describe the short video/gif to generate...';
      if(currentMode==='math') chatInput.placeholder='Enter the math problem...';
    });
  });

  // Hamburger menu toggle
  hamburger.addEventListener('click', ()=> {
    sideMenu.classList.toggle('open');
  });
  // close menu when clicking outside
  document.addEventListener('click', (e)=>{
    if(!sideMenu.contains(e.target) && !hamburger.contains(e.target)){
      sideMenu.classList.remove('open');
    }
  });

  // new chat
  newChatBtn.addEventListener('click', ()=> {
    // save current with a simple title (first line or 'Session <date>')
    if(currentConversation.messages.length){
      // derive title from first user message or 'Chat <date>'
      const firstUser = currentConversation.messages.find(m=>m.from==='user');
      currentConversation.title = firstUser ? (firstUser.text.split('\n')[0].slice(0,40)) : ('Chat ' + new Date(currentConversation.id).toLocaleString());
      saveConversation(currentConversation);
    }
    newConversation();
    sideMenu.classList.remove('open');
  });

  // file upload handling
  document.querySelector('.icon-btn').addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      // show thumbnail preview in pending area
      pendingPreview.innerHTML = `<img src="${reader.result}" style="width:80px;height:80px;border-radius:8px;object-fit:cover; border:2px solid rgba(255,255,255,0.06);">`;
      // also store as pending file in memory for next send
      window._pendingFile = { name: f.name, data: reader.result };
    };
    reader.readAsDataURL(f);
  });

  // Send action - unified for modes
  async function sendAction(){
    const text = chatInput.value.trim();
    const pendingFile = window._pendingFile || null;
    if(!text && !pendingFile) return;
    // append user bubble (with thumbnail if file)
    let userMeta = {};
    if(pendingFile) userMeta.thumbnail = pendingFile.data;
    currentConversation.messages.push({ from:'user', text: text || ('[file: ' + (pendingFile?pendingFile.name:'') + ']'), meta: userMeta });
    renderChat();
    chatInput.value = '';
    pendingPreview.innerHTML = ''; window._pendingFile = null;

    // show loading bubble
    const loading = { from:'ai', text: 'Processing...', meta:{} };
    currentConversation.messages.push(loading);
    renderChat();

    // Decide endpoint / behavior based on currentMode
    try {
      let responseText = '';
      let responseMeta = {};

      if(currentMode === 'chat'){
        // general chat endpoint: /api/chat
        const payload = { message:text, language: languageSelect.value, file: pendingFile ? pendingFile.data : undefined };
        const r = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(!r.ok) throw new Error('Server error: ' + r.statusText);
        const data = await r.json();
        responseText = data.response || data.text || 'No response.';
      } else if(currentMode === 'image'){
        // image creation endpoint
        const payload = { prompt: text || (pendingFile ? '[file uploaded]' : '' ) };
        const r = await fetch('/api/pollinations-image', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(!r.ok) throw new Error('Server error: ' + r.statusText);
        const data = await r.json();
        // expected data.imageUrl
        responseText = data.caption || 'Image generated';
        responseMeta.thumbnail = data.imageUrl || data.image || '';
      } else if(currentMode === 'video'){
        // generate frames -> gif
        const payload = { prompt: text };
        const r = await fetch('/api/pollinations-frames', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(!r.ok) throw new Error('Server error: ' + r.statusText);
        const res = await r.json();
        const frames = res.frames || [];
        if(frames.length){
          // create gif client-side
          responseText = 'Generated video (GIF)';
          // create a temporary gif via gif.js
          const gif = new GIF({ workers:2, quality:10 });
          const images = await Promise.all(frames.map(src => new Promise(resolve=>{
            const img = new Image(); img.src = src; img.onload = ()=> resolve(img); img.onerror = ()=> resolve(null);
          })));
          images.filter(Boolean).forEach(img=> gif.addFrame(img, { delay: 120 }));
          const blob = await new Promise((resolve)=>{
            gif.on('finished', b => resolve(b));
            gif.render();
          });
          responseMeta.thumbnail = URL.createObjectURL(blob);
        } else {
          responseText = 'No frames returned.';
        }
      } else if(currentMode === 'math'){
        const payload = { question: text, file: pendingFile ? pendingFile.data : undefined };
        const r = await fetch('/api/math', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(!r.ok) throw new Error('Server error: ' + r.statusText);
        const d = await r.json();
        responseText = d.response || d.solution || 'No solution.';
      }

      // replace last loading entry (which is at end) with AI response
      // remove loading
      for(let i=currentConversation.messages.length-1;i>=0;i--){
        if(currentConversation.messages[i].from==='ai' && currentConversation.messages[i].text==='Processing...'){
          currentConversation.messages.splice(i,1);
          break;
        }
      }
      currentConversation.messages.push({ from:'ai', text: responseText, meta: responseMeta });
      // set title if still New chat and user typed something (for history)
      if(currentConversation.title === 'New chat' && text){
        currentConversation.title = text.split('\n')[0].slice(0,50);
      }
      saveConversation(currentConversation);
      renderChat();

      // MathJax rendering if any LaTeX in response
      if(window.MathJax) MathJax.typesetPromise().catch(()=>{});

    } catch(err){
      // replace loading with error
      for(let i=currentConversation.messages.length-1;i>=0;i--){
        if(currentConversation.messages[i].from==='ai' && currentConversation.messages[i].text==='Processing...'){
          currentConversation.messages.splice(i,1);
          break;
        }
      }
      currentConversation.messages.push({ from:'ai', text: '❌ Error: ' + err.message, meta:{} });
      saveConversation(currentConversation);
      renderChat();
    }
  }

  sendBtn.addEventListener('click', sendAction);
  chatInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendAction(); } });

  // Settings modal: show on click, hide on mouseleave
  settingsBtn.addEventListener('click', (e)=> {
    e.stopPropagation();
    settingsModal.classList.toggle('show');
  });
  settingsModal.addEventListener('mouseleave', ()=> settingsModal.classList.remove('show'));
  document.addEventListener('click', (e)=>{
    if(!settingsModal.contains(e.target) && !settingsBtn.contains(e.target)){
      settingsModal.classList.remove('show');
    }
  });

  // ensure app initially hidden until intro hides - but also allow skipping intro if needed
  // mainApp.style.display = 'none'; // already handled in intro module

});
</script>
</body>
</html>
