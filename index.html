<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Assistant Pro</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
body { background-color:#0f0f13; color:#fff; font-family:'Segoe UI',sans-serif; margin:0; padding:0;}
.container {max-width:900px;margin:2rem auto;background:#1a1c29;border-radius:1.5rem;padding:1.5rem;box-shadow:0 15px 30px rgba(0,0,0,0.7);}
.tabs {display:flex;border-bottom:2px solid #333;margin-bottom:1rem;}
.tab-btn {flex:1;text-align:center;padding:1rem;cursor:pointer;color:#aaa;font-weight:bold;transition:all 0.2s;}
.tab-btn.active {color:#fff;border-bottom:3px solid #facc15;}
.tab-content {display:none;}
.tab-content.active {display:block;}
.chat-box {background:#111827;border-radius:12px;padding:1rem;height:350px;overflow-y:auto;display:flex;flex-direction:column;}
.bubble {max-width:80%;padding:10px 14px;border-radius:12px;margin-bottom:10px;line-height:1.5;word-wrap:break-word;white-space:pre-wrap;}
.user-bubble {background:#2563eb;align-self:flex-end;color:white;border-bottom-right-radius:2px;}
.ai-bubble {background:#374151;align-self:flex-start;color:#e5e7eb;border-bottom-left-radius:2px;}
mark.highlight {background-color:#fde047;color:black;font-weight:bold;padding:0 3px;border-radius:3px;}
textarea,input{width:100%;padding:0.75rem;border-radius:0.75rem;background:#1e1e2a;border:1px solid #333;color:white;resize:none;outline:none;}
button{padding:0.75rem 1rem;border-radius:0.75rem;font-weight:bold;cursor:pointer;transition:all 0.2s;}
#btnCreateImage{background:#10b981;color:#111827;}#btnCreateImage:hover{background:#059669;}
#btnChat{background:#6366f1;color:white;}#btnChat:hover{background:#4f46e5;}
#btnMath{background:#f59e0b;color:#111827;}#btnMath:hover{background:#d97706;}
img.generated-image{border-radius:12px;max-width:100%;margin-top:1rem;}
#settings-btn{position:absolute;top:1rem;right:1rem;font-size:1.5rem;cursor:pointer;color:#facc15;}
#settings-modal{position:absolute;top:3rem;right:1rem;width:200px;background:#1a1c29;border:1px solid #facc15;border-radius:0.75rem;padding:1rem;display:none;}
.flex-tools {display:flex;gap:0.5rem;margin-bottom:0.5rem;}
.tool-btn {width:48px;height:48px;background:#2c2c3a;display:flex;align-items:center;justify-content:center;border-radius:0.5rem;cursor:pointer;transition:all 0.2s;}
.tool-btn:hover {background:#3e3e55;}
.input-row {display:flex;gap:0.5rem;margin-top:0.5rem;}
.input-row textarea {flex:1;}
#cameraPreviewContainer {display:none;width:100%;}
#cameraPreview {border-radius:12px;width:100%;margin-top:0.5rem;}
</style>
</head>
<body>
<div class="container relative">
  <div id="settings-btn">‚öôÔ∏è</div>
  <div id="settings-modal">
    <label class="block mb-2">Ng√¥n ng·ªØ chat:</label>
    <select id="language-select" class="w-full p-2 rounded bg-gray-800 text-white">
      <option value="vi">Ti·∫øng Vi·ªát</option>
      <option value="en">English</option>
      <option value="zh-CN">ÁÆÄ‰Ωì‰∏≠Êñá</option>
    </select>
  </div>

  <div class="tabs">
    <div class="tab-btn active" data-tab="image">üñºÔ∏è T·∫°o ·∫¢nh</div>
    <div class="tab-btn" data-tab="chat">üí¨ Chat</div>
    <div class="tab-btn" data-tab="math">üßÆ Gi·∫£i To√°n</div>
  </div>

  <!-- T·∫°o ·∫¢nh -->
  <div class="tab-content active" id="image">
    <div class="chat-box" id="imageBox"></div>
    <textarea id="imagePrompt" rows="2" placeholder="Nh·∫≠p m√¥ t·∫£ ·∫£nh..."></textarea>
    <button id="btnCreateImage" class="mt-2 w-full">T·∫°o ·∫¢nh</button>
  </div>

  <!-- Chat -->
  <div class="tab-content" id="chat">
    <div class="chat-box" id="chatBox"></div>
    <div class="input-row">
      <textarea id="chatInput" rows="2" placeholder="Nh·∫≠p tin nh·∫Øn..."></textarea>
      <label class="tool-btn"><input type="file" id="fileInput" accept="image/*" class="hidden">üìÅ</label>
      <button id="cameraBtn" class="tool-btn">üì∏</button>
    </div>
    <button id="btnChat" class="mt-2 w-full">G·ª≠i</button>
    <div id="cameraPreviewContainer">
      <video id="cameraPreview" autoplay playsinline></video>
      <button id="captureBtn" class="mt-2 w-full bg-green-500 rounded text-black font-bold">Ch·ª•p & G·ª≠i</button>
    </div>
  </div>

  <!-- Gi·∫£i To√°n -->
  <div class="tab-content" id="math">
    <div class="chat-box" id="mathBox"></div>
    <div class="input-row">
      <textarea id="mathPrompt" rows="2" placeholder="Nh·∫≠p b√†i to√°n..."></textarea>
      <label class="tool-btn"><input type="file" id="mathFileInput" accept="image/*" class="hidden">üìÅ</label>
      <button id="mathCameraBtn" class="tool-btn">üì∏</button>
    </div>
    <button id="btnMath" class="mt-2 w-full">Gi·∫£i</button>
    <div id="mathCameraPreviewContainer">
      <video id="mathCameraPreview" autoplay playsinline></video>
      <button id="mathCaptureBtn" class="mt-2 w-full bg-green-500 rounded text-black font-bold">Ch·ª•p & G·ª≠i</button>
    </div>
  </div>
</div>

<script>
// Tab chuy·ªÉn ƒë·ªïi
const tabs=document.querySelectorAll(".tab-btn");
const contents=document.querySelectorAll(".tab-content");
tabs.forEach(tab=>{
  tab.addEventListener("click",()=>{
    tabs.forEach(t=>t.classList.remove("active"));
    contents.forEach(c=>c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  });
});

// Chat & To√°n
function addBubble(boxId,text,sender){const box=document.getElementById(boxId);const div=document.createElement("div");div.className=`bubble ${sender==='user'?'user-bubble':'ai-bubble'}`;div.innerHTML=text;box.appendChild(div);box.scrollTop=box.scrollHeight;}
function updateLastAIBubble(boxId,text){const box=document.getElementById(boxId);const bubbles=box.getElementsByClassName("ai-bubble");if(bubbles.length>0){bubbles[bubbles.length-1].innerHTML=text;}box.scrollTop=box.scrollHeight;}

let chatHistory=[];
let currentLang=localStorage.getItem("geminiChatLanguage")||"vi";
document.getElementById("language-select").value=currentLang;

// Settings
const settingsBtn=document.getElementById("settings-btn");
const settingsModal=document.getElementById("settings-modal");
settingsBtn.addEventListener("click",()=>{settingsModal.style.display=settingsModal.style.display==="none"?"block":"none";});
document.addEventListener("click",(e)=>{if(!settingsModal.contains(e.target)&&!settingsBtn.contains(e.target)){settingsModal.style.display="none";}});
document.getElementById("language-select").addEventListener("change",(e)=>{
  currentLang=e.target.value;
  localStorage.setItem("geminiChatLanguage",currentLang);
  chatHistory=[];
  document.getElementById("chatBox").innerHTML="";
  alert(`ƒê√£ chuy·ªÉn ng√¥n ng·ªØ sang ${e.target.options[e.target.selectedIndex].text}. Vui l√≤ng b·∫Øt ƒë·∫ßu chat m·ªõi.`);
});

// Pollinations t·∫°o ·∫£nh
document.getElementById("btnCreateImage").addEventListener("click",async()=>{
  const prompt=document.getElementById("imagePrompt").value.trim();
  if(!prompt)return;
  addBubble("imageBox",prompt,"user");
  addBubble("imageBox","üß† ƒêANG T·∫†O ·∫¢NH...","ai");
  try{
    const res=await fetch("/api/pollinations-image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt})});
    const data=await res.json();
    updateLastAIBubble("imageBox",`<img src="${data.imageUrl}" class="generated-image">`);
  }catch{updateLastAIBubble("imageBox","‚ùå L·ªói k·∫øt n·ªëi server.");}
});

// Chat
document.getElementById("btnChat").addEventListener("click",async()=>{
  const message=document.getElementById("chatInput").value.trim();
  if(!message)return;
  addBubble("chatBox",message,"user");
  chatHistory.push({role:"user",text:message});
  document.getElementById("chatInput").value="";
  addBubble("chatBox","üß† ƒêANG TR·∫¢ L·ªúI...","ai");
  try{
    const res=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message,history:chatHistory,language:currentLang})});
    const data=await res.json();
    updateLastAIBubble("chatBox",data.response);
    chatHistory.push({role:"assistant",text:data.response});
  }catch{updateLastAIBubble("chatBox","‚ùå L·ªói k·∫øt n·ªëi server.");}
});

// Gi·∫£i To√°n
document.getElementById("btnMath").addEventListener("click",async()=>{
  const question=document.getElementById("mathPrompt").value.trim();
  if(!question)return;
  addBubble("mathBox",question,"user");
  document.getElementById("mathPrompt").value="";
  addBubble("mathBox","üß† ƒêANG GI·∫¢I TO√ÅN...","ai");
  try{
    const res=await fetch("/api/math",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question})});
    const data=await res.json();
    updateLastAIBubble("mathBox",data.response);
    MathJax.typesetPromise();
  }catch{updateLastAIBubble("mathBox","‚ùå L·ªói k·∫øt n·ªëi server.");}
});

// === Upload ·∫£nh chat ===
function setupImageUpload(fileInputId, boxId){
  const input=document.getElementById(fileInputId);
  input.addEventListener("change", async (e)=>{
    const file=e.target.files[0];
    if(!file) return;
    if(!file.type.startsWith("image/")){ alert("Vui l√≤ng ch·ªçn ·∫£nh."); return; }
    const reader=new FileReader();
    reader.onload=async function(){
      const base64=reader.result;
      addBubble(boxId, `<img src="${base64}" class="generated-image">`,"user");
      addBubble(boxId,"üß† ƒêANG PH√ÇN T√çCH ·∫¢NH...","ai");
      try{
        const res=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({history:chatHistory,image:base64,language:currentLang})});
        const data=await res.json();
        updateLastAIBubble(boxId,data.response);
        chatHistory.push({role:"assistant",text:data.response});
      }catch{updateLastAIBubble(boxId,"‚ùå L·ªói k·∫øt n·ªëi server.");}
    };
    reader.readAsDataURL(file);
  });
}
setupImageUpload("fileInput","chatBox");
setupImageUpload("mathFileInput","mathBox");

// === Camera tr·ª±c ti·∫øp ===
function setupCamera(btnId, previewContainerId, previewId, captureBtnId, boxId){
  const btn=document.getElementById(btnId);
  const container=document.getElementById(previewContainerId);
  const preview=document.getElementById(previewId);
  const captureBtn=document.getElementById(captureBtnId);
  let stream=null;

  btn.addEventListener("click", async()=>{
    if(container.style.display==="none"||container.style.display===""){
      container.style.display="block";
      try{stream=await navigator.mediaDevices.getUserMedia({video:true});preview.srcObject=stream;}catch{alert("Kh√¥ng th·ªÉ truy c·∫≠p camera.");}
    } else {
      container.style.display="none";
      if(stream) stream.getTracks().forEach(t=>t.stop());
    }
  });

  captureBtn.addEventListener("click", async()=>{
    if(!stream) return;
    const canvas=document.createElement("canvas");
    canvas.width=preview.videoWidth;
    canvas.height=preview.videoHeight;
    const ctx=canvas.getContext("2d");
    ctx.drawImage(preview,0,0);
    const base64=canvas.toDataURL("image/png");

    addBubble(boxId, `<img src="${base64}" class="generated-image">`,"user");
    addBubble(boxId,"üß† ƒêANG PH√ÇN T√çCH ·∫¢NH...","ai");
    try{
      const res=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({history:chatHistory,image:base64,language:currentLang})});
      const data=await res.json();
      updateLastAIBubble(boxId,data.response);
      chatHistory.push({role:"assistant",text:data.response});
    }catch{updateLastAIBubble(boxId,"‚ùå L·ªói k·∫øt n·ªëi server.");}

    container.style.display="none";
    stream.getTracks().forEach(t=>t.stop());
  });
}

setupCamera("cameraBtn","cameraPreviewContainer","cameraPreview","captureBtn","chatBox");
setupCamera("mathCameraBtn","mathCameraPreviewContainer","mathCameraPreview","mathCaptureBtn","mathBox");
</script>
</body>
</html>
