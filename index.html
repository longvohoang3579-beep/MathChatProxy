<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tr·ª£ L√Ω AI ƒêa NƒÉng üß†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --app-height: 100dvh; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #121212; color: #e4e6eb; }
        .full-viewport-height { height: var(--app-height); }
        .chat-container { background-color: #1e1e1e; }
        .bubble { padding: 10px 14px; border-radius: 18px; margin: 8px 0; max-width: 90%; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4); line-height: 1.5; }
        .user { background: #1e90ff; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai { background: #3a3b3c; color: #e4e6eb; align-self: flex-start; border-bottom-left-radius: 4px; }
        .highlight { background-color: #ffc400; color: #18191a; padding: 2px 4px; border-radius: 4px; font-weight: 600; font-family: 'Courier New', Courier, monospace; }
        .typing-indicator { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        .generated-image-container { background-color: #2c2c2c; border: 1px solid #444; padding: 1rem; border-radius: 12px; margin-top: 1rem; text-align: center; }
        .generated-image { border-radius: 8px; margin-top: 8px; max-width: 100%; height: auto; }
        .tab-button { transition: all 0.2s ease-in-out; border-bottom: 2px solid transparent; }
        .tab-button.active { border-bottom-color: #1e90ff; color: white; }
    </style>
</head>
<body class="p-0 flex items-center justify-center bg-black">
    <div class="w-full max-w-full sm:max-w-lg bg-[#242526] shadow-2xl rounded-none sm:rounded-2xl flex flex-col overflow-hidden full-viewport-height border border-gray-700">
        
        <header class="bg-gradient-to-r from-gray-800 to-black text-white p-4 text-center shadow-lg flex-shrink-0">
            <h1 class="text-xl font-extrabold">üß† Tr·ª£ L√Ω AI ƒêa NƒÉng</h1>
        </header>

        <nav class="flex justify-around bg-gray-900 p-2 shadow-md flex-shrink-0">
            <button id="tab-chat" onclick="switchView('chat')" class="tab-button active w-full py-2 text-gray-300 font-semibold">üí¨ Chat</button>
            <button id="tab-image" onclick="switchView('image')" class="tab-button w-full py-2 text-gray-300 font-semibold">üé® T·∫°o ·∫¢nh</button>
            <button id="tab-math" onclick="switchView('math')" class="tab-button w-full py-2 text-gray-300 font-semibold">üßÆ Gi·∫£i To√°n</button>
        </nav>

        <div class="flex-grow overflow-hidden relative">
            <div id="chat-view" class="flex flex-col h-full">
                <main id="general-chat-box" class="overflow-y-auto p-4 flex flex-col space-y-3 flex-grow chat-container">
                    <div class="bubble ai">Xin ch√†o! B·∫°n mu·ªën tr√≤ chuy·ªán v·ªÅ ch·ªß ƒë·ªÅ g√¨ h√¥m nay?</div>
                </main>
                <footer class="p-3 border-t border-gray-700 bg-[#242526] flex-shrink-0">
                    <div class="flex items-end space-x-2">
                        <input type="text" id="general-chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..."
                               class="flex-grow border border-gray-600 rounded-full px-4 py-3 bg-gray-700 text-white shadow-inner"
                               onkeypress="if(event.key === 'Enter') sendGeneralChatMessage()">
                        <button onclick="sendGeneralChatMessage()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-3 rounded-full font-semibold shadow-lg">G·ª≠i</button>
                    </div>
                </footer>
            </div>

            <div id="image-view" class="p-4 overflow-y-auto h-full hidden">
                <h2 class="text-lg font-bold text-center mb-4">üé® AI T·∫°o ·∫¢nh (DeepAI)</h2>
                <div class="space-y-4">
                    <div>
                        <label for="image-prompt" class="block mb-1 text-sm font-medium text-gray-400">N·ªôi dung ·∫£nh:</label>
                        <textarea id="image-prompt" rows="3" placeholder="V√≠ d·ª•: m·ªôt ch√∫ m√®o phi h√†nh gia ƒëang c∆∞·ª°i t√™n l·ª≠a tr√™n d·∫£i ng√¢n h√†, tranh s∆°n d·∫ßu"
                                  class="w-full border border-gray-600 rounded-lg px-3 py-2 bg-gray-700 text-white focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <button onclick="generateDeepAiImage()" id="generate-image-btn" class="w-full bg-green-600 hover:bg-green-500 text-white px-5 py-3 rounded-lg font-semibold shadow-lg transition-colors">
                        T·∫°o ·∫£nh
                    </button>
                </div>
                <div id="image-result-container" class="mt-4"></div>
            </div>

            <div id="math-view" class="flex flex-col h-full hidden">
                <main id="math-chat-box" class="overflow-y-auto p-4 flex flex-col space-y-3 flex-grow chat-container">
                    <div class="bubble ai">Ch√†o b·∫°n! G·ª≠i cho t√¥i b√†i to√°n b·∫±ng ch·ªØ ho·∫∑c h√¨nh ·∫£nh nh√©.</div>
                </main>
                <footer class="p-3 border-t border-gray-700 bg-[#242526] flex-shrink-0">
                    <div id="math-image-preview" class="hidden mb-2 p-2 bg-[#3a3b3c] rounded-lg">
                         <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-400">·∫¢nh ƒë√£ ch·ªçn:</span>
                            <button onclick="clearMathImage()" class="text-red-400 hover:text-red-300 text-xs">‚ùå X√≥a</button>
                        </div>
                        <img id="math-preview-img" class="mt-2 h-16 rounded">
                    </div>
                    <div class="flex items-end space-x-2">
                        <button onclick="document.getElementById('fileInput').click()" title="ƒê√≠nh k√®m ·∫£nh" class="p-3 rounded-full bg-gray-700 hover:bg-gray-600">üìé</button>
                        <input type="file" accept="image/*" id="fileInput" class="hidden" onchange="handleMathFileSelect(event)">
                        <button onclick="document.getElementById('cameraInput').click()" title="Ch·ª•p ·∫£nh" class="p-3 rounded-full bg-gray-700 hover:bg-gray-600">üì∏</button>
                        <input type="file" accept="image/*" capture="environment" id="cameraInput" class="hidden" onchange="handleMathFileSelect(event)">
                        <input type="text" id="math-text-input" placeholder="H·ªèi b√†i to√°n..."
                               class="flex-grow border border-gray-600 rounded-full px-4 py-3 bg-gray-700 text-white shadow-inner"
                               onkeypress="if(event.key === 'Enter') sendMathProblem()">
                        <button onclick="sendMathProblem()" id="math-send-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-3 rounded-full font-semibold shadow-lg">G·ª≠i</button>
                    </div>
                </footer>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const views = { chat: document.getElementById('chat-view'), image: document.getElementById('image-view'), math: document.getElementById('math-view') };
        const tabs = { chat: document.getElementById('tab-chat'), image: document.getElementById('tab-image'), math: document.getElementById('tab-math') };
        const generalChatBox = document.getElementById('general-chat-box');
        const generalChatInput = document.getElementById('general-chat-input');
        const imagePromptInput = document.getElementById('image-prompt');
        const imageResultContainer = document.getElementById('image-result-container');
        const generateImageBtn = document.getElementById('generate-image-btn');
        const mathChatBox = document.getElementById('math-chat-box');
        const mathTextInput = document.getElementById('math-text-input');
        const mathImagePreview = document.getElementById('math-image-preview');
        const mathPreviewImg = document.getElementById('math-preview-img');
        const mathSendBtn = document.getElementById('math-send-btn');
        let mathImageBase64 = null;

        // --- API Endpoints ---
        const API_GENERAL_CHAT_URL = "/api/general-chat";
        const API_DEEPAI_IMAGE_URL = "/api/deepai-image";
        const API_MATH_URL = "/api/ask";

        // --- Core Logic ---
        function switchView(viewName) {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            Object.values(tabs).forEach(t => t.classList.remove('active'));
            views[viewName].classList.remove('hidden');
            tabs[viewName].classList.add('active');
        }

        function formatAiResponse(text) { return text.replace(/\n/g, '<br>').replace(/`([^`]+)`/g, '<span class="highlight">$1</span>'); }

        function addMessage(chatBox, content, role = "ai", isHtml = false) {
            const div = document.createElement("div");
            div.className = `bubble ${role}`;
            div.innerHTML = isHtml ? content : (role === 'ai' ? formatAiResponse(content) : content.replace(/\n/g, '<br>'));
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        function addTypingIndicator(chatBox, message = "... ƒëang x·ª≠ l√Ω ...") {
            const typingDiv = document.createElement("div");
            typingDiv.id = `typingIndicator-${chatBox.id}`;
            typingDiv.className = 'bubble ai typing-indicator';
            typingDiv.textContent = message;
            chatBox.appendChild(typingDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function removeTypingIndicator(chatBox) {
            const indicator = document.getElementById(`typingIndicator-${chatBox.id}`);
            if (indicator) indicator.remove();
        }

        // --- General Chat Functions ---
        async function sendGeneralChatMessage() {
            const text = generalChatInput.value.trim();
            if (!text) return;
            addMessage(generalChatBox, text, "user");
            generalChatInput.value = "";
            addTypingIndicator(generalChatBox, "... ƒëang suy nghƒ© ...");
            try {
                const response = await fetch(API_GENERAL_CHAT_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ prompt: text }) });
                if (!response.ok) throw new Error((await response.json()).message);
                addMessage(generalChatBox, (await response.json()).response, "ai");
            } catch (error) { addMessage(generalChatBox, `‚ùå L·ªói: ${error.message}`, "ai"); } finally { removeTypingIndicator(generalChatBox); }
        }
        
        // --- Image Generation Functions (Secure) ---
        async function generateDeepAiImage() {
            const prompt = imagePromptInput.value.trim();
            if (!prompt) { alert("Vui l√≤ng nh·∫≠p n·ªôi dung ·∫£nh mu·ªën t·∫°o."); return; }
            generateImageBtn.disabled = true;
            generateImageBtn.textContent = "ƒêang t·∫°o ·∫£nh...";
            imageResultContainer.innerHTML = `<div class="text-center text-gray-400">Vui l√≤ng ch·ªù...</div>`;
            try {
                const response = await fetch(API_DEEPAI_IMAGE_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ prompt }) });
                if (!response.ok) throw new Error((await response.json()).message || `L·ªói HTTP ${response.status}`);
                const data = await response.json();
                imageResultContainer.innerHTML = `<div class="generated-image-container"><p class="text-sm text-gray-300 mb-2">"${prompt}"</p><img src="${data.imageUrl}" class="generated-image" alt="AI generated image"></div>`;
            } catch (error) { imageResultContainer.innerHTML = `<div class="text-center text-red-400">‚ùå L·ªói: ${error.message}</div>`; } finally { generateImageBtn.disabled = false; generateImageBtn.textContent = "T·∫°o ·∫£nh"; }
        }

        // --- Math Solver Functions ---
        function handleMathFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                mathPreviewImg.src = e.target.result;
                mathImagePreview.classList.remove('hidden');
                mathImageBase64 = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function clearMathImage() {
            mathImageBase64 = null;
            mathImagePreview.classList.add('hidden');
            mathPreviewImg.src = '';
        }

        async function sendMathProblem() {
            const text = mathTextInput.value.trim();
            if (!text && !mathImageBase64) return;
            if (mathImageBase64) addMessage(mathChatBox, `<img src="${mathPreviewImg.src}" class="max-w-xs rounded">`, "user", true);
            if (text) addMessage(mathChatBox, text, "user");
            const payload = { question: text, imageBase64: mathImageBase64 };
            mathTextInput.value = "";
            clearMathImage();
            mathSendBtn.disabled = true;
            addTypingIndicator(mathChatBox, "... ƒëang gi·∫£i to√°n ...");
            try {
                 const response = await fetch(API_MATH_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error((await response.json()).message);
                addMessage(mathChatBox, (await response.json()).response, "ai");
            } catch (error) { addMessage(mathChatBox, `‚ùå L·ªói: ${error.message}`, "ai"); } finally { removeTypingIndicator(mathChatBox); mathSendBtn.disabled = false; }
        }
    </script>
</body>
</html>