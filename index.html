<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Assistant Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* Import font chữ hiện đại từ Google */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

        /* ======== CẢI THIỆN MÀU SẮC CHO SANG TRỌNG ======== */
        :root {
            --primary-yellow: #ffb800; /* Vàng đậm và sáng hơn */
            --dark-bg: #0d0d10; /* Nền tối hơn nữa */
            --main-bg: #1a1a1e; /* Nền chính */
            --input-bg: #222228; /* Nền ô nhập liệu */
            --bubble-ai-bg: #2d2d33; 
            --bubble-user-bg: linear-gradient(135deg, #7b68ee, #4a90e2); /* Bubble User - Màu Tím-Xanh Cao cấp */
            --text-primary: #f0f0f5; /* Trắng sáng */
            --text-secondary: #b0b0bb; /* Xám ấm */
        }
        
        /* ======== SCROLLBAR THEME DARK ======== */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--main-bg); }
        ::-webkit-scrollbar-thumb { background-color: #4a4a52; border-radius: 10px; border: 2px solid var(--main-bg); }
        ::-webkit-scrollbar-thumb:hover { background-color: #6b6b75; }

        body {
            background-color: var(--dark-bg);
            /* Giảm bớt độ sáng của chấm lưới để nền tinh tế hơn */
            background-image: radial-gradient(circle at 1% 1%, rgba(255, 255, 255, 0.02) 1px, transparent 0),
                              radial-gradient(circle at 99% 99%, rgba(255, 255, 255, 0.02) 1px, transparent 0);
            background-size: 50px 50px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 0; overflow: hidden;
        }
        
        /* Sidebar */
        #sidebar { 
            background-color: var(--main-bg); /* Sidebar dùng nền chính */
            border-right: 1px solid #333333; /* Đường viền tối hơn */
        }

        /* Highlight */
        mark.highlight { 
            background-color: var(--primary-yellow); 
            color: black; 
            font-weight: bold; 
            padding: 2px 5px; 
            border-radius: 4px; 
        }

        /* ======== KHUNG CHAT SANG TRỌNG HƠN ======== */
        @keyframes fadeInBubble { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .bubble { 
            max-width: 85%; 
            padding: 12px 18px; 
            border-radius: 18px; 
            margin-bottom: 12px; 
            line-height: 1.6; 
            word-wrap: break-word; 
            white-space: pre-wrap; 
            animation: fadeInBubble 0.3s ease-out forwards; 
            /* Tăng cường bóng đổ cho cảm giác nổi và 3D hơn */
            box-shadow: 0 6px 20px rgba(0,0,0,0.3); 
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .user-bubble { 
            background: var(--bubble-user-bg); 
            color: white; 
            border-bottom-right-radius: 6px; 
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.2); 
        }
        .ai-bubble { 
            background: var(--input-bg); /* Dùng màu input cho bubble AI để đồng bộ */
            color: var(--text-primary); 
            border-bottom-left-radius: 6px; 
            border: 1px solid #333333; /* Viền mỏng */
        }

        /* ======== KHU VỰC INPUT NÂNG CẤP ======== */
        .input-area { 
            margin-top: 1rem; 
            padding: 0.5rem; 
            /* Đổi nền thành màu tối trong suốt, tạo hiệu ứng mờ ảo */
            background: rgba(26, 26, 30, 0.85); 
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px);
            border-radius: 1rem; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5); 
            border: 1px solid #333333; /* Viền tinh tế */
        }

        .mode-btn {
            background: #222228; /* Màu nền mode button */
            border: 1px solid #333333;
            font-size: 0.85rem;
        }
        .mode-btn.active {
            background-color: var(--primary-yellow);
            color: var(--dark-bg);
            font-weight: 700;
            border-color: var(--primary-yellow);
        }
        .mode-btn.active:hover {
            background: #ffc433;
        }
        
        .input-row { 
            background: transparent; /* Loại bỏ nền input-row */
            border: none; /* Loại bỏ viền input-row */
            padding: 0; /* Loại bỏ padding input-row */
        }
        
        textarea { 
            font-size: 1.05rem; /* Tăng nhẹ font size */
            padding: 10px 12px;
        }
        
        .send-btn { 
            /* Thay đổi send-btn thành hình tròn và lớn hơn */
            background: var(--primary-yellow); 
            color: var(--dark-bg);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-shadow: 0 4px 15px rgba(255, 184, 0, 0.4); /* Bóng vàng nổi bật */
        }
        .send-btn:hover { 
            transform: scale(1.05);
        }

        /* Responsive */
        @media (max-width: 768px) {
            #sidebar { transform: translateX(-100%); }
            #sidebar.open { width: 100%; }
            #sidebar.open ~ #chat-container { margin-left: 0; filter: blur(5px) brightness(0.6); }
        }
    </style>
    <script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>
</head>
<body>
    
    <div id="intro-screen">
        <div class="intro-container">
            <div id="intro-yellow-flash"></div>
            <div id="intro-text">AI Assistant Pro</div>
            <div id="intro-burst"></div>
        </div>
    </div>
    
    <div id="app-wrapper">
        
        <aside id="sidebar">
            <button id="new-chat-btn" class="p-3 rounded-lg font-bold">＋ Cuộc trò chuyện mới</button>
            <h2 class="text-gray-400 text-sm font-bold mt-6 mb-2 uppercase">Lịch sử</h2>
            <div id="chat-history">
                </div>
        </aside>
        
        <main id="chat-container">
            <div class="header relative">
                <div id="menu-btn" class="menu-btn">☰</div>
                <div id="settings-btn">⚙️</div>
                <div id="settings-modal">
                    <label class="block mb-2">Ngôn ngữ chat:</label>
                    <select id="language-select" class="w-full p-2 rounded bg-gray-800 text-white">
                        <option value="vi">Tiếng Việt</option>
                        <option value="en">English</option>
                        <option value="zh-CN">简体中文</option>
                    </select>
                </div>
            </div>
            
            <div class="chat-box" id="chatBox">
                </div>
            
            <div class="input-area">
                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="chat" title="Trò chuyện thông thường">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2V2zm3.5 1a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/></svg>
                        <span>Chat</span>
                    </button>
                    <button class="mode-btn" data-mode="image" title="Tạo ảnh từ mô tả">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/><path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/></svg>
                        <span>Tạo Ảnh</span>
                    </button>
                    <button class="mode-btn" data-mode="math" title="Giải bài toán">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM4 13.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zM12 2H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1zM6.646 9.646a.5.5 0 0 1 .708 0l1 1a.5.5 0 0 1-.708.708l-1-1a.5.5 0 0 1 0-.708zm2-3a.5.5 0 0 1 0 .708l-1 1a.5.5 0 0 1-.708-.708l1-1a.5.5 0 0 1 .708 0zM5 6.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/></svg>
                        <span>Giải Toán</span>
                    </button>
                    <button class="mode-btn" data-mode="video" title="Tạo video/GIF ngắn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M0 1a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V1zm4 0v6h8V1H4zm8 8H4v6h8V9zM1 1v2h2V1H1zm2 3H1v2h2V4zM1 7v2h2V7H1zm2 3H1v2h2v-2zm-2 3v2h2v-2H1zM15 1h-2v2h2V1zm-2 3v2h2V4h-2zm2 3h-2v2h2V7zm-2 3v2h2v-2h-2zm2 3h-2v2h2v-2z"/></svg>
                        <span>Tạo Video</span>
                    </button>
                </div>

                <div class="pending-preview" id="previewContainer"></div>

                <div class="input-row">
                    <label class="icon-btn" for="fileInput" title="Tải ảnh hoặc file">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16"><path d="M4.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h2z"/><path d="M6.5 1h3a.5.5 0 0 1 .5.5v14a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-14a.5.5 0 0 1 .5-.5z"/><path d="M11.5 5a.5.5 0 0 1 .5.5v5a.5.5 0 0 1-.5-.5h-2a.5.5 0 0 1-.5-.5v-5a.5.5 0 0 1 .5-.5h2z"/></svg>
                    </label>
                    <input type="file" id="fileInput" accept="image/*" hidden />
                    <textarea id="mainInput" rows="1" placeholder="Nhập tin nhắn..."></textarea>
                    <button id="sendBtn" class="send-btn" title="Gửi">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" stroke-width="2" width="22" height="22" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
            </div>
            
        </main>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // =======================================================
        // === DOM ELEMENTS & STATE MANAGEMENT
        // =======================================================
        const introScreen = document.getElementById('intro-screen');
        const appWrapper = document.getElementById('app-wrapper');
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menu-btn');
        const chatContainer = document.getElementById('chat-container');
        const chatBox = document.getElementById('chatBox');
        const mainInput = document.getElementById('mainInput');
        const sendBtn = document.getElementById('sendBtn');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const languageSelect = document.getElementById('language-select');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistoryContainer = document.getElementById('chat-history');
        const modeButtons = document.querySelectorAll('.mode-btn');

        let currentChatMode = 'chat'; // 'chat', 'image', 'math', 'video'
        let uploadedFile = null; // Stores uploaded file as base64
        let chatHistory = {}; // { chatId: { title: '...', messages: [] } }
        let activeChatId = null;


        // =======================================================
        // === INITIALIZATION & INTRO
        // =======================================================
        function playIntro() {
            setTimeout(() => {
                introScreen.style.opacity = '0';
                setTimeout(() => {
                    introScreen.style.display = 'none';
                    appWrapper.style.opacity = '1';
                    document.body.style.overflow = 'auto';
                }, 1000); // Wait for fade-out to finish
            }, 6000); // Total intro duration
        }
        
        function initializeApp() {
            playIntro();
            loadHistoryFromStorage();
            if (Object.keys(chatHistory).length === 0) {
                startNewChat();
            } else {
                // Load the most recent chat
                const latestChatId = Object.keys(chatHistory).sort().pop();
                loadChat(latestChatId);
            }
            renderChatHistory();
        }

        initializeApp();

        // =======================================================
        // === CHAT HISTORY MANAGEMENT
        // =======================================================
        function saveHistoryToStorage() {
            localStorage.setItem('ai_assistant_pro_history', JSON.stringify(chatHistory));
        }

        function loadHistoryFromStorage() {
            const storedHistory = localStorage.getItem('ai_assistant_pro_history');
            if (storedHistory) {
                chatHistory = JSON.parse(storedHistory);
            }
        }

        function startNewChat() {
            const newId = `chat_${Date.now()}`;
            activeChatId = newId;
            chatHistory[activeChatId] = {
                title: 'Cuộc trò chuyện mới',
                messages: []
            };
            chatBox.innerHTML = '';
            renderChatHistory();
            saveHistoryToStorage();
        }
        
        function loadChat(chatId) {
            if (!chatHistory[chatId]) return;
            activeChatId = chatId;
            chatBox.innerHTML = '';
            chatHistory[chatId].messages.forEach(msg => {
                const bubble = appendMessage(chatBox, msg.content, msg.type, false);
                // Bắt buộc chạy MathJax khi tải lịch sử
                if (msg.type === 'ai' && msg.content.includes('$')) {
                    MathJax.typesetPromise([bubble]);
                }
            });
            renderChatHistory();
        }

        function renderChatHistory() {
            chatHistoryContainer.innerHTML = '';
            // Sort chats by date, newest first
            const sortedChatIds = Object.keys(chatHistory).sort((a, b) => b.localeCompare(a));

            sortedChatIds.forEach(chatId => {
                const chat = chatHistory[chatId];
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.textContent = chat.title;
                historyItem.dataset.chatId = chatId;
                if (chatId === activeChatId) {
                    historyItem.classList.add('active');
                }
                historyItem.addEventListener('click', () => {
                    loadChat(chatId);
                    // Tự động đóng sidebar trên mobile khi load chat mới
                    if(window.innerWidth <= 768) {
                        sidebar.classList.remove('open');
                        chatContainer.style.filter = 'none';
                    }
                });
                chatHistoryContainer.appendChild(historyItem);
            });
        }
        
        function updateChatTitle(firstUserMessage) {
            if (chatHistory[activeChatId] && chatHistory[activeChatId].messages.length <= 2) { 
                const newTitle = firstUserMessage.substring(0, 30) + (firstUserMessage.length > 30 ? '...' : '');
                chatHistory[activeChatId].title = newTitle || "Ảnh đã gửi";
                renderChatHistory();
                saveHistoryToStorage();
            }
        }

        newChatBtn.addEventListener('click', () => {
            startNewChat();
            if(sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                if(window.innerWidth <= 768) chatContainer.style.filter = 'none';
            }
        });


        // =======================================================
        // === CORE UI & EVENT LISTENERS
        // =======================================================
        
        // Sidebar toggle
        menuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            if(window.innerWidth <= 768 && sidebar.classList.contains('open')) {
                chatContainer.style.filter = 'blur(5px) brightness(0.6)';
            } else {
                chatContainer.style.filter = 'none';
            }
        });
        
        // Close sidebar when clicking outside
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768 && sidebar.classList.contains('open') && !sidebar.contains(e.target) && e.target !== menuBtn) {
                sidebar.classList.remove('open');
                chatContainer.style.filter = 'none';
            }
        });

        // Settings modal toggle
        settingsBtn.addEventListener('click', () => {
            settingsModal.style.display = settingsModal.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', (e) => {
            if (!settingsModal.contains(e.target) && !settingsBtn.contains(e.target)) {
                settingsModal.style.display = 'none';
            }
        });

        // Mode selection
        modeButtons.forEach(button => {
            button.addEventListener('click', () => {
                modeButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentChatMode = button.dataset.mode;
                const modeText = button.querySelector('span').textContent;
                mainInput.placeholder = `Nhập mô tả để ${modeText.toLowerCase()}...`;
            });
        });

        // File upload handling
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onloadend = () => {
                uploadedFile = reader.result;
                previewContainer.innerHTML = `<img src="${reader.result}" style="border: 2px solid var(--primary-yellow);" alt="preview">`;
            };
            reader.readAsDataURL(file);
        });

        // Send message handler
        const handleSendMessage = async () => {
            const prompt = mainInput.value.trim();
            const image = uploadedFile;

            if (!prompt && !image) return;

            let userMessageContent = prompt;
            if (image) {
                userMessageContent = `<img src="${image}" style="max-height: 100px; border-radius: 8px; margin-bottom: 5px; display: block; border: 1px solid #4a90e2;" alt="uploaded image"><br>${prompt}`;
            }

            appendMessage(chatBox, userMessageContent, 'user');
            if(chatHistory[activeChatId].messages.length === 1) { 
                updateChatTitle(prompt || "Phân tích ảnh");
            }
            
            const loadingBubble = showLoading(chatBox);

            // Clear inputs
            mainInput.value = '';
            mainInput.style.height = 'auto'; // Reset textarea height
            previewContainer.innerHTML = '';
            uploadedFile = null;
            fileInput.value = '';

            try {
                let responseData;
                let finalContent = ''; 

                switch (currentChatMode) {
                    case 'image':
                        responseData = await callApi('/api/pollinations-image', { prompt });
                        if (!responseData.imageUrl) throw new Error("Server không trả về URL ảnh.");
                        finalContent = `<img src="${responseData.imageUrl}" class="generated-image" alt="Generated Image">`;
                        break;
                    case 'video':
                        loadingBubble.textContent = 'Đang tải các khung hình (bước 1/2)...';
                        const frameData = await callApi('/api/pollinations-frames', { prompt });
                        if (!frameData.frames || frameData.frames.length < 8) throw new Error(`Chỉ nhận được ${frameData.frames.length || 0} khung hình. Không đủ để tạo video.`);
                        
                        loadingBubble.textContent = `Đang render GIF từ ${frameData.frames.length} khung hình (bước 2/2)...`;
                        const videoUrl = await createGifFromFrames(frameData.frames);
                        finalContent = `<img src="${videoUrl}" class="generated-video" alt="Generated Video">`;
                        break;
                    case 'math':
                        responseData = await callApi('/api/math', { question: prompt, image });
                        finalContent = responseData.response || 'Không có phản hồi toán học.';
                        break;
                    case 'chat':
                    default:
                        responseData = await callApi('/api/chat', { message: prompt, image, language: languageSelect.value, history: [] });
                        finalContent = responseData.response || 'Không có phản hồi chat.';
                        break;
                }
                
                loadingBubble.innerHTML = finalContent;
                
                // Bắt buộc chạy MathJax sau khi nội dung đã được chèn vào DOM cho mode Math
                if (currentChatMode === 'math' && loadingBubble.innerHTML.includes('$')) {
                    MathJax.typesetPromise([loadingBubble]);
                }

                // Lưu AI response vào history
                if (loadingBubble.innerHTML) {
                    chatHistory[activeChatId].messages.push({ type: 'ai', content: loadingBubble.innerHTML });
                    saveHistoryToStorage();
                }

                // Reset mode to chat for convenience
                document.querySelector('.mode-btn[data-mode="chat"]').click();


            } catch (error) {
                const errorMessage = `❌ Lỗi: ${error.message}`;
                loadingBubble.textContent = errorMessage;
                chatHistory[activeChatId].messages.push({ type: 'ai', content: errorMessage });
                saveHistoryToStorage();
            }
        };

        sendBtn.addEventListener('click', handleSendMessage);
        mainInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });


        // =======================================================
        // === HELPER & UTILITY FUNCTIONS
        // =======================================================

        // Appends a message bubble to a chat box
        function appendMessage(box, content, type, save = true) {
            const bubble = document.createElement('div');
            bubble.classList.add('bubble', type === 'user' ? 'user-bubble' : 'ai-bubble');
            bubble.innerHTML = content;
            box.appendChild(bubble);
            box.scrollTop = box.scrollHeight;

            if (save && activeChatId && chatHistory[activeChatId]) {
                chatHistory[activeChatId].messages.push({ type, content });
                saveHistoryToStorage();
            }
            return bubble;
        }

        // Shows a loading bubble
        function showLoading(box) {
            return appendMessage(box, 'Đang xử lý...', 'ai', false); // Don't save loading message
        }
        
        // Generic API call wrapper (Cải tiến xử lý lỗi)
        async function callApi(endpoint, body) {
            const serverUrl = window.location.origin;
            const response = await fetch(`${serverUrl}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });

            if (!response.ok) {
                // Thử đọc chi tiết lỗi từ body
                let errorDetail = await response.text();
                let errorStatus = response.status;

                try {
                    const errorJson = JSON.parse(errorDetail);
                    errorDetail = errorJson.message || errorJson.response || errorDetail;
                } catch (e) {
                    // response không phải JSON, dùng text
                }
                
                if(errorStatus === 400 || errorDetail.includes('API Key')) {
                    throw new Error(`Lỗi API Key/Tham số (${errorStatus}): ${errorDetail}`);
                }
                if(errorStatus === 404) {
                     throw new Error(`Endpoint không tìm thấy (${endpoint}). Vui lòng kiểm tra Server.`);
                }
                
                throw new Error(`Lỗi từ Server (${errorStatus}): ${errorDetail}`);
            }
            
            // Xử lý response rỗng (Pollinations Image có thể trả về 200 OK rỗng)
            const text = await response.text();
            return text ? JSON.parse(text) : {};
        }

        // GIF creation logic (Giữ nguyên)
        function createGifFromFrames(frames) {
             return new Promise((resolve, reject) => {
                const gif = new GIF({
                    workers: 2,
                    quality: 10,
                    width: 512,
                    height: 512,
                });

                const imagePromises = frames.map(frameData => {
                    return new Promise(resolveImg => {
                        const img = new Image();
                        img.crossOrigin = "anonymous";
                        img.src = frameData;
                        img.onload = () => resolveImg(img);
                        img.onerror = () => resolveImg(null); 
                    });
                });

                Promise.all(imagePromises).then(imageElements => {
                    const validImages = imageElements.filter(img => img !== null);
                    if(validImages.length === 0) reject(new Error("Không thể tải bất kỳ khung hình nào."));

                    validImages.forEach(img => {
                        gif.addFrame(img, { delay: 100 });
                    });

                    gif.on('finished', function(blob) {
                        const videoUrl = URL.createObjectURL(blob);
                        resolve(videoUrl);
                    });
                    
                    gif.on('error', function(err) {
                        reject(new Error("Lỗi khi render GIF: " + err.message));
                    });

                    gif.render();
                }).catch(reject);
             });
        }
        
        // Auto-resize textarea
        mainInput.addEventListener('input', () => {
            mainInput.style.height = 'auto';
            mainInput.style.height = (mainInput.scrollHeight) + 'px';
        });

    });
    </script>
</body>
</html>