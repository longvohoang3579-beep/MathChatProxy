<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Assistant Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* --- Giữ nguyên toàn bộ CSS của bạn --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        :root { --primary-yellow: #facc15; --dark-bg: #0a0a0c; /* ... */ }
        body { font-family: 'Inter', sans-serif; /* ... */ }
        .summary-actions { margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem; border-top: 1px solid #444; padding-top: 0.75rem; }
        .summary-btn { background-color: #374151; color: #e5e7eb; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem; cursor: pointer; transition: background-color 0.2s; border: none; }
        .summary-btn:hover:not(:disabled) { background-color: #4b5563; }
        .summary-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        /* --- Hết CSS --- */
    </style>
    <script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>
</head>
<body>
    <audio id="intro-audio" src="data:audio/mpeg;base64,..."></audio>
    <div id="intro-screen">...</div>
    <div id="limit-overlay">...</div>
    <div id="voice-overlay">...</div>

    <div id="app-wrapper">
        <aside id="sidebar">
             <div class="social-login-container mb-4">...</div>
             <button id="new-chat-btn" class="p-3 rounded-lg font-bold">＋ New Conversation</button>
             <h2 class="text-gray-400 text-sm font-bold mt-6 mb-2 uppercase">History</h2>
             <div id="chat-history"></div>
             <div id="usage-counter" class="text-center text-sm text-gray-400 mt-auto pt-4 border-t border-gray-700">Loading usage...</div>
        </aside>

        <main id="chat-container">
            <div class="header relative">...</div>
            <div class="chat-box" id="chatBox"></div>
            <div class="input-area">
                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="chat" title="Trò chuyện"><span>Chat</span></button>
                    <button class="mode-btn" data-mode="image" title="Tạo ảnh"><span>Tạo Ảnh</span></button>
                    <button class="mode-btn" data-mode="math" title="Giải toán"><span>Giải Toán</span></button>
                    <button class="mode-btn" data-mode="video" title="Tạo video"><span>Tạo Video</span></button>
                    <button class="mode-btn" data-mode="edit_image" title="Chỉnh sửa ảnh"><span>Sửa Ảnh</span></button>
                    {/* Xóa nút này */}
                    <button class="mode-btn" data-mode="notetaker" title="Ghi chú văn bản"><span>Ghi Chú</span></button>
                </div>
                <div class="pending-preview" id="previewContainer"></div>
                <div class="input-row">...</div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Giữ nguyên tất cả các biến DOM và logic cũ ---
        const getEl = (id) => document.getElementById(id);
        const introScreen = getEl('intro-screen'), /*...*/ usageCounterEl = getEl('usage-counter'); // Add usageCounterEl

        let currentChatMode = 'chat', uploadedFile = null, chatHistory = {}, activeChatId = null, isRecording = false;

        // === Logic Giới Hạn Hàng Ngày (Giữ nguyên) ===
        const MAX_DAILY_USES = 20;
        const UNLOCK_PASSWORD = "Hoang1082009@";
        let usageData = { count: 0, date: '', unlocked: false };
        function loadUsageData() { /* ... Giữ nguyên ... */ }
        function saveUsageData() { /* ... Giữ nguyên ... */ }
        function updateUsageDisplay() { /* ... Giữ nguyên ... */ }
        function checkUsageLimit() { /* ... Giữ nguyên ... */ }
        function incrementUsageCount() { /* ... Giữ nguyên ... */ }
        unlockBtn.addEventListener('click', () => { /* ... Giữ nguyên ... */ });

        // === Logic Voice Chat (Giữ nguyên) ===
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let conversationMode = false;
        let silenceTimeout;
        if (SpeechRecognition) { /* ... Giữ nguyên toàn bộ logic voice ... */ }
        else { voiceBtn.style.display = 'none'; }
        function startListening() { /* ... Giữ nguyên ... */ }
        function speak(text, lang) { /* ... Giữ nguyên ... */ }
        async function handleVoiceQuery(transcript, langCode) { /* ... Giữ nguyên ... */ }
        voiceBtn.addEventListener('click', () => { /* ... Giữ nguyên ... */ });
        voiceMicIcon.addEventListener('click', () => { /* ... Giữ nguyên ... */ });
        voiceCloseBtn.addEventListener('click', () => { /* ... Giữ nguyên ... */ });

        // === Logic Flashcard/Mindmap (Giữ nguyên) ===
        function addSummaryActions(bubbleElement, summaryText) { /* ... Giữ nguyên ... */ }

        // --- Core Chat Logic (Giữ nguyên) ---
        function playIntro() { /* ... Giữ nguyên ... */ }
        function saveHistoryToStorage() { /* ... Giữ nguyên ... */ }
        function loadHistoryFromStorage() { /* ... Giữ nguyên ... */ }
        function startNewChat() { /* ... Giữ nguyên ... */ }
        function loadChat(chatId) { /* ... Giữ nguyên ... */ }
        function renderChatHistory() { /* ... Giữ nguyên ... */ }
        function updateChatTitle(firstUserMessage, isImageOnly = false) { /* ... Giữ nguyên ... */ }

        // --- Event Listeners (Cập nhật mode selector) ---
        newChatBtn.addEventListener('click', () => { /* ... */ });
        menuBtn.addEventListener('click', () => { /* ... */ });
        settingsBtn.addEventListener('click', () => { /* ... */ });
        document.addEventListener('click', (e) => { /* ... */ }); // Close modals

        modeButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (button.disabled) return;
                modeButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentChatMode = button.dataset.mode;
                // Update placeholder
                switch(currentChatMode) {
                    // case 'summarize_youtube': // Xóa case này
                    //     mainInput.placeholder = 'Paste YouTube video URL here...'; break;
                    case 'edit_image': mainInput.placeholder = 'Upload image & describe desired changes...'; break;
                    case 'notetaker': mainInput.placeholder = 'Paste text for note-taking...'; break;
                    case 'math': mainInput.placeholder = 'Enter math problem or upload image...'; break;
                    case 'image': mainInput.placeholder = 'Describe the image you want to create...'; break;
                    case 'video': mainInput.placeholder = 'Describe the short video/GIF...'; break;
                    default: mainInput.placeholder = 'Ask me anything...';
                }
                fileInput.labels[0].style.display = ['chat', 'math', 'edit_image'].includes(currentChatMode) ? 'flex' : 'none';
            });
        });

        fileInput.addEventListener('change', (event) => { /* ... Giữ nguyên ... */ });

        // --- Main Send Function (Cập nhật) ---
        const handleSendMessage = async () => {
             if (!checkUsageLimit()) return;
             const prompt = mainInput.value.trim(); const image = uploadedFile;
             if (currentChatMode === 'edit_image' && !image) { alert("Please upload an image for editing."); return; }
             // Bỏ kiểm tra prompt cho summarize_youtube
             if (!prompt && !image && currentChatMode !== 'notetaker') { return; } // Cho phép gửi ảnh không cần text ở chat/math/edit
             if (!prompt && currentChatMode === 'notetaker') { alert("Please paste text for note-taking."); return; }

             if (document.querySelector('.welcome-message')) document.querySelector('.welcome-message').remove();
             let userMessageContent = prompt;
             if (image) userMessageContent = `<img src="${image}" style="max-height: 100px; max-width: 150px; border-radius: 8px; display:block; margin-bottom: 5px;" alt="uploaded"><p>${prompt || 'Analyze/Edit this image'}</p>`;

             appendMessage(userMessageContent || "[Image Sent]", 'user');
             updateChatTitle(prompt, !prompt && !!image);
             const loadingBubble = showLoading();
             const currentPromptValue = prompt; const currentImageValue = image;
             mainInput.value = ''; previewContainer.innerHTML = ''; uploadedFile = null; fileInput.value = ''; mainInput.style.height = 'auto';

            try {
                let responseData;
                let finalContent = '';
                let isSummaryResult = false; // Chỉ bật cho notetaker

                switch (currentChatMode) {
                    case 'image': /* Giữ nguyên */ break;
                    case 'edit_image': /* Giữ nguyên */ break;
                    case 'math': /* Giữ nguyên */ break;
                    // case 'summarize_youtube': // Xóa case này
                    //     responseData = await callApi('/api/summarize-youtube', { youtubeUrl: currentPromptValue });
                    //     finalContent = responseData.response;
                    //     isSummaryResult = true;
                    //     break;
                    case 'notetaker':
                        responseData = await callApi('/api/summarize-text', { textToSummarize: currentPromptValue });
                        finalContent = responseData.response;
                        isSummaryResult = true; // Bật cho notetaker
                        break;
                    case 'video': /* Giữ nguyên */ break;
                    default: /* Giữ nguyên chat */ break;
                }

                 // --- Xử lý switch case (Giữ nguyên logic bên trong các case còn lại) ---
                 switch (currentChatMode) {
                     case 'image':
                         responseData = await callApi('/api/pollinations-image', { prompt: currentPromptValue });
                         finalContent = `<img src="${responseData.imageUrl}" class="generated-image">`;
                         break;
                     case 'edit_image':
                         loadingBubble.querySelector('.bubble').innerHTML = 'Generating edit description...';
                         const descriptionResponse = await callApi('/api/edit-image', { message: currentPromptValue, image: currentImageValue });
                         const newPrompt = descriptionResponse.response;
                         if (newPrompt.startsWith('❌')) throw new Error(newPrompt);
                         loadingBubble.querySelector('.bubble').innerHTML = 'Generating edited image...';
                         const imageResponse = await callApi('/api/pollinations-image', { prompt: newPrompt });
                         finalContent = `<p><strong>Generated based on:</strong> ${newPrompt}</p><img src="${imageResponse.imageUrl}" class="generated-image">`;
                         break;
                     case 'math':
                         responseData = await callApi('/api/math', { question: currentPromptValue, image: currentImageValue });
                         finalContent = responseData.response;
                         break; // MathJax sẽ được gọi sau
                     case 'notetaker':
                         responseData = await callApi('/api/summarize-text', { textToSummarize: currentPromptValue });
                         finalContent = responseData.response;
                         isSummaryResult = true; // Bật cho notetaker
                         break;
                     case 'video':
                         loadingBubble.querySelector('.bubble').innerHTML = 'Generating video frames...';
                         responseData = await callApi('/api/pollinations-frames', { prompt: currentPromptValue });
                         // Quan trọng: Kiểm tra responseData.frames có tồn tại và là mảng không rỗng
                         if (!responseData.frames || !Array.isArray(responseData.frames) || responseData.frames.length === 0) {
                              // Nếu server trả về lỗi hoặc mảng rỗng (do placeholder)
                              throw new Error(responseData.message || 'Video frame generation failed or not implemented.');
                         }
                         loadingBubble.querySelector('.bubble').innerHTML = 'Rendering GIF...';
                         const videoUrl = await createGifFromFrames(responseData.frames);
                         finalContent = `<img src="${videoUrl}" class="generated-video" alt="Generated Video">`;
                         break;
                     default: // chat
                         responseData = await callApi('/api/chat', { message: currentPromptValue, image: currentImageValue, language: languageSelect.value });
                         finalContent = responseData.response;
                         break;
                 }


                const aiBubbleElement = loadingBubble.querySelector('.bubble');
                aiBubbleElement.innerHTML = finalContent;

                if (currentChatMode === 'math') {
                     MathJax.typesetPromise([aiBubbleElement]);
                }

                // Thêm actions nếu là notetaker và thành công
                if (isSummaryResult && !finalContent.startsWith('❌')) {
                    addSummaryActions(aiBubbleElement, finalContent);
                }

                saveMessage(aiBubbleElement.innerHTML, 'ai');
                incrementUsageCount();

            } catch (error) { /* ... Giữ nguyên xử lý lỗi ... */
                console.error("Error in handleSendMessage:", error);
                const errorMessage = `❌ Lỗi: ${error.message}`;
                loadingBubble.querySelector('.bubble').textContent = errorMessage;
                saveMessage(errorMessage, 'ai');
            }
        };

        // --- Giữ nguyên các hàm helper và khởi tạo ---
        sendBtn.addEventListener('click', handleSendMessage);
        mainInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } });
        function appendMessage(content, type, save = true) { /* ... */ }
        function saveMessage(content, type) { /* ... */ }
        function showLoading() { /* ... */ }
        async function callApi(endpoint, body) { /* ... */ }
        function createGifFromFrames(frames) { /* ... */ }
        mainInput.addEventListener('input', () => { /* ... */ });
        function initializeApp() { /* ... */ }
        initializeApp();
    });
    </script>
</body>
</html>