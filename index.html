<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Assistant Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        :root {
            --primary-yellow: #facc15; --dark-bg: #0a0a0c; --main-bg: #141417;
            --input-bg: #1f1f23; --bubble-ai-bg: #2d2d33;
            --bubble-user-bg: linear-gradient(135deg, #5e5ce6, #2563eb);
            --text-primary: #e4e4e7; --text-secondary: #a1a1aa;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--main-bg); }
        ::-webkit-scrollbar-thumb { background-color: #4a4a52; border-radius: 10px; border: 2px solid var(--main-bg); }
        body {
            background-color: var(--dark-bg);
            background-image: radial-gradient(circle at 1% 1%, rgba(255, 255, 255, 0.04) 1px, transparent 0), radial-gradient(circle at 99% 99%, rgba(255, 255, 255, 0.04) 1px, transparent 0);
            background-size: 50px 50px; color: var(--text-primary); font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow: hidden;
        }
        #intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: var(--dark-bg); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 1; transition: opacity 1s ease-in-out 6s; }
        .intro-container { position: relative; display: flex; align-items: center; justify-content: center; }
        #intro-yellow-flash { position: absolute; width: 100vw; height: 100vh; background-color: var(--primary-yellow); animation: yellowFlash 2s ease-in-out forwards; }
        @keyframes yellowFlash { 0% { transform: scale(0); border-radius: 50%; } 50% { transform: scale(1); border-radius: 0; } 100% { transform: scale(1); border-radius: 0; opacity: 0; } }
        #intro-text { position: relative; color: #fff; font-size: 3rem; font-weight: bold; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); opacity: 0; animation: logoAnimate 4s ease-in-out 1.5s forwards; }
        #intro-text::after { content: ''; position: absolute; top: 0; left: -10%; width: 20%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent); transform: skewX(-25deg); opacity: 0; animation: shine 1.5s ease-in-out 3s forwards; }
        #intro-burst { position: absolute; width: 1px; height: 1px; background: white; border-radius: 50%; opacity: 0; animation: burst 1s ease-out 5s forwards; }
        @keyframes logoAnimate { 0% { opacity: 0; transform: scale(2); } 25% { opacity: 1; transform: scale(1); } 75% { opacity: 1; transform: scale(1); } 100% { opacity: 1; transform: scale(1.1); } }
        @keyframes shine { 0% { left: -10%; opacity: 1; } 100% { left: 110%; opacity: 1; } }
        @keyframes burst { from { opacity: 1; transform: scale(0); box-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px var(--primary-yellow), 0 0 30px var(--primary-yellow); } to { opacity: 0; transform: scale(200); box-shadow: 0 0 50px #fff, 0 0 75px var(--primary-yellow); } }
        mark.highlight { background-color: var(--primary-yellow); color: black; font-weight: bold; padding: 2px 5px; border-radius: 4px; }
        #app-wrapper { display: flex; height: 100vh; opacity: 0; transition: opacity 0.5s ease-in; }
        #sidebar { width: 260px; background-color: var(--dark-bg); border-right: 1px solid #27272a; padding: 1rem; display: flex; flex-direction: column; transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); position: fixed; left: 0; top: 0; height: 100%; z-index: 100; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        #sidebar.open { transform: translateX(0); }
        #new-chat-btn { background-color: transparent; border: 1px solid var(--primary-yellow); color: var(--primary-yellow); width: 100%; text-align: center; transition: all 0.2s ease; }
        #new-chat-btn:hover { background-color: var(--primary-yellow); color: var(--dark-bg); }
        .history-item { padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-secondary); transition: all 0.2s; border-left: 3px solid transparent; }
        .history-item:hover { background-color: var(--main-bg); color: var(--text-primary); }
        .history-item.active { background-color: #27272a; color: white; font-weight: 500; border-left-color: var(--primary-yellow); }
        #chat-container { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; max-width: 900px; margin: 0 auto; padding: 1rem; transition: margin-left 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        #sidebar.open ~ #chat-container { margin-left: 260px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 0 0.5rem; }
        .menu-btn, #settings-btn { font-size: 1.8rem; cursor: pointer; color: var(--primary-yellow); z-index: 101; transition: transform 0.2s; }
        .menu-btn:hover, #settings-btn:hover { transform: scale(1.1); }
        .chat-box { background: transparent; padding: 1rem; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; scroll-behavior: smooth; margin-top: 1rem; gap: 1rem; }
        .message-group { display: flex; gap: 12px; max-width: 90%; }
        .message-group.user { align-self: flex-end; flex-direction: row-reverse; }
        .message-group.ai { align-self: flex-start; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background: #444; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-top: 4px; }
        .avatar-user { background: #5e5ce6; }
        .avatar-ai { background: var(--primary-yellow); color: #111; }
        @keyframes fadeInBubble { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .bubble { padding: 12px 18px; border-radius: 18px; line-height: 1.6; word-wrap: break-word; white-space: pre-wrap; animation: fadeInBubble 0.3s ease-out forwards; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .user .bubble { background: var(--bubble-user-bg); color: white; border-bottom-right-radius: 4px; }
        .ai .bubble { background: var(--bubble-ai-bg); color: var(--text-primary); border-bottom-left-radius: 4px; }
        .welcome-message { text-align: center; color: var(--text-secondary); padding: 2rem 1rem; animation: fadeInBubble 0.5s ease; }
        .welcome-message h2 { font-size: 1.8rem; font-weight: bold; color: var(--text-primary); }
        .typing-indicator { display: flex; align-items: center; gap: 5px; }
        .typing-indicator span { width: 8px; height: 8px; background-color: #777; border-radius: 50%; animation: typing 1s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        pre { background-color: #0d1117; color: #c9d1d9; padding: 1rem; border-radius: 8px; overflow-x: auto; border: 1px solid #30363d; font-size: 0.9em; }
        code { font-family: 'Courier New', Courier, monospace; }
        .input-area { margin-top: 1rem; padding: 0.5rem; background: var(--main-bg); border-radius: 1rem; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); }
        .mode-selector { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; justify-content: center; flex-wrap: wrap; }
        .mode-btn { background: #2d3748; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; border: 2px solid transparent; font-size: 0.9rem; color: var(--text-secondary); }
        .mode-btn:hover { background: #4a5568; color: var(--text-primary); }
        .mode-btn.active { border-color: var(--primary-yellow); background-color: #374151; color: var(--primary-yellow); font-weight: 500; }
        .input-row { display: flex; align-items: flex-end; gap: 0.75rem; background: var(--input-bg); padding: 0.5rem; border-radius: 0.75rem; border: 1px solid #333; transition: border-color 0.2s; }
        .input-row:focus-within { border-color: var(--primary-yellow); }
        textarea { width: 100%; padding: 0.6rem; border-radius: 0.5rem; background: transparent; border: none; color: white; resize: none; outline: none; max-height: 200px; font-size: 1rem; line-height: 1.5; }
        .icon-btn, .send-btn { background: transparent; padding: 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: none; color: var(--text-secondary); flex-shrink: 0; }
        .icon-btn:hover { color: var(--primary-yellow); background: #374151; }
        .send-btn { background: var(--primary-yellow); color: var(--dark-bg); }
        .send-btn:hover { transform: scale(1.1); }
        .pending-preview { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; padding: 0.5rem; }
        .pending-preview img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #475569; }
        img.generated-image, .generated-video { border-radius: 12px; max-width: 100%; margin-top: 1rem; display: block; max-height: 400px; margin-left: auto; margin-right: auto; }
        #settings-modal { position: absolute; top: 3rem; right: 1rem; width: 200px; background: var(--main-bg); border: 1px solid var(--primary-yellow); border-radius: 0.75rem; padding: 1rem; display: none; z-index: 100; }
        #voice-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(5px); z-index: 1500; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .mic-wave-container { width: 200px; height: 200px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; }
        .mic-wave-container.listening .wave { animation: ripple 1.5s ease-out infinite; }
        .mic-wave-container .wave { position: absolute; width: 100%; height: 100%; border: 4px solid var(--primary-yellow); border-radius: 50%; opacity: 0; }
        .mic-wave-container .wave:nth-child(2) { animation-delay: 0.3s; }
        .mic-wave-container .wave:nth-child(3) { animation-delay: 0.6s; }
        @keyframes ripple { from { transform: scale(0.5); opacity: 1; } to { transform: scale(1.5); opacity: 0; } }
        .mic-icon { font-size: 3rem; color: #111; background-color: var(--primary-yellow); border-radius: 50%; padding: 20px; z-index: 10; cursor: pointer; }
        #limit-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 2000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        #password-form { background: var(--main-bg); padding: 2.5rem; border-radius: 1rem; text-align: center; border: 3px solid var(--primary-yellow); box-shadow: 0 0 30px rgba(250, 204, 21, 0.3); }
        .social-login-container { display: flex; gap: 0.75rem; align-items: center; }
        .social-btn { background-color: #2d2d33; border: 1px solid #444; color: white; padding: 0.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .social-btn:hover { background-color: #444; border-color: var(--primary-yellow); }
    </style>
    <script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>
</head>
<body>
    <audio id="intro-audio" src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAAAAAACAAAARGF2aW5jaCBSZ... (Phần audio base64 được giữ nguyên)" preload="auto"></audio>
    <div id="intro-screen">
        <div class="intro-container">
            <div id="intro-yellow-flash"></div>
            <div id="intro-text">AI Assistant Pro</div>
            <div id="intro-burst"></div>
        </div>
    </div>

    <div id="limit-overlay">
        <div id="password-form">
            <h2 class="text-2xl font-bold mb-4 text-yellow-500">Đã hết lượt sử dụng miễn phí!</h2>
            <p id="limit-message" class="mb-6 text-gray-300">Vui lòng nhập mật khẩu để mở khóa sử dụng không giới hạn:</p>
            <input type="password" id="password-input" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-yellow-500 outline-none" placeholder="Mật khẩu">
            <button id="unlock-btn" class="mt-4 p-3 bg-yellow-500 text-black font-bold rounded-lg w-full hover:bg-yellow-600 transition">Mở khóa Vô Hạn</button>
            <p id="password-message" class="mt-3 text-red-500 hidden"></p>
        </div>
    </div>
    <div id="voice-overlay">
        <div class="mic-wave-container" id="mic-wave">
            <div class="wave"></div><div class="wave"></div><div class="wave"></div>
            <div class="mic-icon" id="voice-mic-icon">🎤</div>
        </div>
        <p id="voice-status" class="mt-6 text-xl font-medium text-yellow-500">Nhấn Mic để Bắt đầu Nói...</p>
        <button id="voice-close-btn" class="mt-10 p-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition">Tắt Chức Năng Giọng Nói</button>
    </div>

    <div id="app-wrapper">
        <aside id="sidebar">
            <div class="social-login-container mb-4">
                <button onclick="alert('Chức năng đăng nhập Google đang được phát triển!')" class="social-btn" title="Đăng nhập với Google">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M15.545 6.558a9.42 9.42 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.689 7.689 0 0 1 5.352 2.082l-2.28... (Phần SVG Google được giữ nguyên)"/></svg>
                </button>
                <button onclick="alert('Chức năng đăng nhập Facebook đang được phát triển!')" class="social-btn" title="Đăng nhập với Facebook">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951"/></svg>
                </button>
            </div>
            <button id="new-chat-btn" class="p-3 mb-4 rounded-lg font-semibold flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                Chat Mới
            </button>
            <div class="flex-grow overflow-y-auto space-y-2">
                <div id="history-list">
                    </div>
            </div>
            <div class="mt-4 border-t border-gray-700 pt-4 text-center text-sm text-gray-500">
                AI Assistant Pro © 2025
            </div>
        </aside>

        <main id="chat-container" class="w-full md:ml-0">
            <header class="header">
                <div class="menu-btn" id="menu-btn">☰</div>
                <h1 class="text-xl font-bold text-yellow-500">AI Assistant Pro</h1>
                <div class="menu-btn" id="settings-btn">⚙️</div>
                <div id="settings-modal">
                    <button class="w-full text-left p-2 rounded hover:bg-gray-700 transition text-sm">Cài đặt</button>
                    <button class="w-full text-left p-2 rounded hover:bg-gray-700 transition text-sm">Đăng xuất</button>
                </div>
            </header>

            <div class="chat-box" id="chat-box">
                <div class="welcome-message" id="welcome-message">
                    <h2>Chào mừng đến với AI Assistant Pro!</h2>
                    <p class="mt-2">Hãy chọn chế độ và bắt đầu tương tác với AI.</p>
                </div>
                </div>

            <div class="input-area">
                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="chat">
                        <span role="img" aria-label="chat">💬</span> Chat Chung
                    </button>
                    <button class="mode-btn" data-mode="summarizer">
                        <span role="img" aria-label="summarizer">📝</span> Tóm Tắt
                    </button>
                    <button class="mode-btn" data-mode="video_creator">
                        <span role="img" aria-label="video_creator">🎬</span> Tạo Video
                    </button>
                    <button class="mode-btn" data-mode="image_editor">
                        <span role="img" aria-label="image_editor">🎨</span> Chỉnh Sửa Ảnh
                    </button>
                    <button class="mode-btn" data-mode="notetaker">
                        <span role="img" aria-label="notetaker">📌</span> Notetaker
                    </button>
                </div>

                <div id="image-upload-area" class="mb-2 p-2 bg-gray-800 rounded-lg hidden">
                    <p class="text-sm text-yellow-500 mb-1">Upload Ảnh:</p>
                    <input type="file" id="image-input" accept="image/*" class="w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100">
                    <div id="image-preview" class="pending-preview mt-2"></div>
                </div>
                
                <div id="note-link-area" class="mb-2 p-2 bg-gray-800 rounded-lg hidden">
                    <p class="text-sm text-yellow-500 mb-1">Dán Nội dung cuộc họp/Link (tượng trưng) vào đây:</p>
                </div>


                <div class="input-row">
                    <button class="icon-btn" id="voice-btn" title="Ghi âm giọng nói">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/><path d="M10 8V7a2 2 0 1 0-4 0v1a2 2 0 1 0 4 0z"/></svg>
                    </button>
                    <textarea id="user-input" rows="1" placeholder="Nhập yêu cầu của bạn..." class="h-10"></textarea>
                    <button class="send-btn" id="send-btn" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.5.5 0 0 1-.923.018L.789 8.243a.5.5 0 0 1 .017-.924l14.547-5.819a.5.5 0 0 1 .54.11zM6.635 10.825l.836.836L14.717 5.17l-.836-.836L6.635 10.825z"/></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CÁC HÀM TIỆN ÍCH KHÔNG ĐỔI (ĐƯỢC GIỮ NGUYÊN) ---
        // ... (Kích hoạt audio, hiển thị intro, kiểm tra giới hạn) ...
        const introAudio = document.getElementById('intro-audio');
        const introScreen = document.getElementById('intro-screen');
        const appWrapper = document.getElementById('app-wrapper');
        const menuBtn = document.getElementById('menu-btn');
        const sidebar = document.getElementById('sidebar');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const modeBtns = document.querySelectorAll('.mode-btn');
        const welcomeMessage = document.getElementById('welcome-message');
        const voiceBtn = document.getElementById('voice-btn');
        const voiceOverlay = document.getElementById('voice-overlay');
        const voiceCloseBtn = document.getElementById('voice-close-btn');
        const voiceStatus = document.getElementById('voice-status');
        const micWave = document.getElementById('mic-wave');
        const limitOverlay = document.getElementById('limit-overlay');
        const unlockBtn = document.getElementById('unlock-btn');
        const passwordInput = document.getElementById('password-input');
        const passwordMessage = document.getElementById('password-message');
        const historyList = document.getElementById('history-list');

        let currentMode = 'chat';
        let isProcessing = false;
        let messages = []; // Lịch sử trò chuyện cho phiên hiện tại
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
        let currentChatId = null;
        let userLimit = parseInt(localStorage.getItem('userLimit')) || 3; // 3 lượt miễn phí
        let isPremium = localStorage.getItem('isPremium') === 'true';
        const PREMIUM_PASSWORD = 'superaiprolock'; // Mật khẩu mẫu

        // NEW: Elements cho chức năng mới
        const imageUploadArea = document.getElementById('image-upload-area');
        const imageInput = document.getElementById('image-input');
        const imagePreview = document.getElementById('image-preview');
        const noteLinkArea = document.getElementById('note-link-area');
        let selectedFile = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Intro
            introAudio.play().catch(e => console.log('Autoplay prevented.'));
            setTimeout(() => {
                introScreen.style.opacity = '0';
                setTimeout(() => {
                    introScreen.style.display = 'none';
                    appWrapper.style.opacity = '1';
                }, 1000);
            }, 6000);

            // Tải lịch sử
            loadHistory();
            if (Object.keys(chatHistory).length > 0) {
                const latestId = Object.keys(chatHistory).pop();
                loadChat(latestId);
            } else {
                startNewChat();
            }
            
            checkLimit();
        });

        function checkLimit() {
            if (!isPremium && userLimit <= 0) {
                limitOverlay.style.display = 'flex';
            } else {
                limitOverlay.style.display = 'none';
            }
        }

        function useLimit() {
            if (!isPremium) {
                userLimit -= 1;
                localStorage.setItem('userLimit', userLimit);
                checkLimit();
            }
        }

        unlockBtn.addEventListener('click', () => {
            if (passwordInput.value === PREMIUM_PASSWORD) {
                isPremium = true;
                localStorage.setItem('isPremium', 'true');
                limitOverlay.style.display = 'none';
                passwordMessage.textContent = 'Mở khóa thành công!';
                passwordMessage.className = 'mt-3 text-green-500';
                passwordMessage.style.display = 'block';
            } else {
                passwordMessage.textContent = 'Mật khẩu không đúng.';
                passwordMessage.className = 'mt-3 text-red-500';
                passwordMessage.style.display = 'block';
            }
        });

        // Toggle Sidebar
        menuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            document.body.classList.toggle('sidebar-open');
        });

        // Toggle Settings Modal
        settingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsModal.style.display = settingsModal.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', (e) => {
            if (e.target !== settingsBtn && !settingsModal.contains(e.target)) {
                settingsModal.style.display = 'none';
            }
        });

        // Input handling
        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = userInput.scrollHeight + 'px';
            sendBtn.disabled = userInput.value.trim() === '' && !selectedFile;
        });

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (userInput.value.trim() !== '' || selectedFile) {
                    sendMessage();
                }
            }
        });

        sendBtn.addEventListener('click', sendMessage);

        // --- CÁC HÀM QUẢN LÝ CHAT ---

        function loadHistory() {
            historyList.innerHTML = '';
            const ids = Object.keys(chatHistory).reverse();
            ids.forEach(id => {
                const item = document.createElement('div');
                item.className = 'history-item';
                if (id === currentChatId) {
                    item.classList.add('active');
                }
                item.textContent = chatHistory[id].title || `Chat #${id.slice(0, 4)}`;
                item.dataset.id = id;
                item.addEventListener('click', () => loadChat(id));
                historyList.appendChild(item);
            });
        }

        function saveChat() {
            if (!currentChatId) return;
            const title = messages.length > 0 ? messages[0].content.substring(0, 30) + '...' : 'Cuộc trò chuyện mới';
            chatHistory[currentChatId] = {
                title: title,
                messages: messages
            };
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            loadHistory();
        }

        function startNewChat(mode = 'chat') {
            currentChatId = Date.now().toString();
            messages = [];
            currentMode = mode;
            chatBox.innerHTML = '';
            displayWelcomeMessage();
            saveChat();
            loadHistory();
            document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.history-item[data-id="${currentChatId}"]`).classList.add('active');
            
            // Cập nhật chế độ
            modeBtns.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.mode-btn[data-mode="${mode}"]`).classList.add('active');
            updateModeInterface(mode);
        }

        function loadChat(id) {
            if (isProcessing) return;
            saveChat(); // Lưu chat hiện tại trước khi chuyển
            
            currentChatId = id;
            messages = chatHistory[id].messages || [];
            currentMode = 'chat'; // Mặc định là chat khi tải lại lịch sử
            
            chatBox.innerHTML = '';
            messages.forEach(msg => {
                appendMessage(msg.content, msg.role, false);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
            
            document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.history-item[data-id="${id}"]`).classList.add('active');
            
            // Reset input area
            userInput.value = '';
            userInput.style.height = 'auto';
            sendBtn.disabled = true;
            
            // Quay về chế độ chat chung
            modeBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === 'chat') btn.classList.add('active');
            });
            currentMode = 'chat';
            updateModeInterface('chat');
        }

        newChatBtn.addEventListener('click', () => startNewChat());

        // --- HÀM THÊM MESSAGE VÀO CHAT BOX ---
        function appendMessage(content, role, shouldScroll = true) {
            const messageGroup = document.createElement('div');
            messageGroup.className = `message-group ${role}`;

            const avatar = document.createElement('div');
            avatar.className = `avatar ${role === 'user' ? 'avatar-user' : 'avatar-ai'}`;
            avatar.textContent = role === 'user' ? 'U' : 'AI';

            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            
            // Xử lý nội dung markdown (tạm thời không dùng thư viện markdown parser)
            // Thay thế markdown code blocks bằng <pre><code>
            let htmlContent = content;
            const codeBlockRegex = /```([\w\d]+)?\n([\s\S]*?)```/g;
            htmlContent = htmlContent.replace(codeBlockRegex, (match, lang, code) => {
                const language = lang || 'text';
                const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return `<pre><code class="language-${language}">${escapedCode.trim()}</code></pre>`;
            });

            // Xử lý hình ảnh/video đầu ra
            if (role === 'ai') {
                const videoMatch = content.match(/<video>(.*?)<\/video>/);
                const imageMatch = content.match(/<image>(.*?)<\/image>/);
                
                if (imageMatch) {
                    const imageUrl = imageMatch[1];
                    htmlContent = htmlContent.replace(imageMatch[0], `<img src="${imageUrl}" class="generated-image" alt="Ảnh được tạo">`);
                } else if (videoMatch) {
                    const videoUrl = videoMatch[1];
                    htmlContent = htmlContent.replace(videoMatch[0], `<iframe src="${videoUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="generated-video"></iframe>`);
                }
            }

            // Xử lý tiêu đề markdown
            htmlContent = htmlContent.replace(/^###\s*(.*)$/gm, '<h3>$1</h3>');
            htmlContent = htmlContent.replace(/^##\s*(.*)$/gm, '<h2>$1</h2>');
            htmlContent = htmlContent.replace(/^#\s*(.*)$/gm, '<h1>$1</h1>');
            
            // Xử lý danh sách
            htmlContent = htmlContent.replace(/^\s*\*\s*(.*)$/gm, '<li>$1</li>');
            htmlContent = htmlContent.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
            
            bubble.innerHTML = htmlContent;

            messageGroup.appendChild(avatar);
            messageGroup.appendChild(bubble);
            chatBox.appendChild(messageGroup);
            
            if (shouldScroll) {
                chatBox.scrollTop = chatBox.scrollHeight;
            }
            
            // Render MathJax (nếu có)
            if (window.MathJax) {
                MathJax.typeset([bubble]);
            }
        }

        function displayTypingIndicator() {
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.className = 'message-group ai';
            typingIndicator.innerHTML = `
                <div class="avatar avatar-ai">AI</div>
                <div class="bubble typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            `;
            chatBox.appendChild(typingIndicator);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function displayWelcomeMessage() {
            if (chatBox.children.length === 0) {
                chatBox.appendChild(welcomeMessage);
            } else if (chatBox.children[0].id !== 'welcome-message') {
                chatBox.prepend(welcomeMessage);
            }
        }

        // --- CÁC HÀM XỬ LÝ CHỨC NĂNG MỚI ---

        // NEW: Cập nhật giao diện theo chế độ
        function updateModeInterface(mode) {
            imageUploadArea.classList.add('hidden');
            noteLinkArea.classList.add('hidden');
            userInput.placeholder = "Nhập yêu cầu của bạn...";
            
            // Xóa file đã chọn
            selectedFile = null;
            imageInput.value = '';
            imagePreview.innerHTML = '';
            sendBtn.disabled = userInput.value.trim() === '';

            switch (mode) {
                case 'chat':
                    userInput.placeholder = "Hỏi bất cứ điều gì...";
                    break;
                case 'summarizer':
                    userInput.placeholder = "Dán văn bản, link bài viết cần tóm tắt...";
                    break;
                case 'video_creator':
                    userInput.placeholder = "Mô tả ý tưởng kịch bản video bạn muốn...";
                    break;
                case 'image_editor':
                    imageUploadArea.classList.remove('hidden');
                    userInput.placeholder = "Mô tả chỉnh sửa bạn muốn (ví dụ: 'thêm kính râm cho người này')...";
                    sendBtn.disabled = !selectedFile && userInput.value.trim() === '';
                    break;
                case 'notetaker':
                    noteLinkArea.classList.remove('hidden');
                    userInput.placeholder = "Dán nội dung hoặc link Google Meet (tượng trưng) để ghi chú...";
                    break;
            }
        }

        modeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (isProcessing) return;
                
                modeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
                
                // Bắt đầu chat mới khi chuyển chế độ
                // startNewChat(currentMode); 
                // Thay đổi: Chỉ reset giao diện và giữ lại lịch sử nếu không bắt đầu chat mới
                
                updateModeInterface(currentMode);
                welcomeMessage.querySelector('p').textContent = `Bạn đang ở chế độ ${btn.textContent.trim()}.`;
            });
        });
        
        // NEW: Xử lý upload ảnh cho chế độ chỉnh sửa ảnh
        imageInput.addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            imagePreview.innerHTML = '';
            
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = 'Ảnh đã chọn';
                    imagePreview.appendChild(img);
                };
                reader.readAsDataURL(selectedFile);
                sendBtn.disabled = false;
            } else {
                sendBtn.disabled = userInput.value.trim() === '';
            }
        });

        // --- HÀM XỬ LÝ GỬI TIN NHẮN CHÍNH ---
        async function sendMessage() {
            if (isProcessing || (userInput.value.trim() === '' && !selectedFile)) return;
            
            if (!isPremium && userLimit <= 0) {
                checkLimit();
                return;
            }

            const inputContent = userInput.value.trim();
            isProcessing = true;
            sendBtn.disabled = true;
            removeTypingIndicator();
            welcomeMessage.remove();

            // 1. Thêm tin nhắn người dùng
            let userMessage = inputContent;
            if (currentMode === 'image_editor' && selectedFile) {
                // Trong thực tế, đây sẽ là base64 của ảnh hoặc một URL.
                // Ở đây ta chỉ dùng tên file để gửi lên server mock.
                userMessage = `Chỉnh sửa ảnh "${selectedFile.name}": ${inputContent}`; 
            }
            
            // Xóa nội dung input sau khi lấy
            userInput.value = '';
            userInput.style.height = 'auto';
            selectedFile = null;
            imageInput.value = '';
            imagePreview.innerHTML = '';
            
            appendMessage(userMessage, 'user');
            messages.push({ role: 'user', content: userMessage });
            saveChat(); 

            // 2. Hiển thị Typing Indicator
            displayTypingIndicator();

            try {
                let apiEndpoint = '/api/chat';
                let requestBody = {
                    messages: messages,
                    mode: currentMode
                };
                let isImageRequest = false;
                let isNoteTakerRequest = false;

                // Xử lý API cho các chế độ đặc biệt
                if (currentMode === 'image_editor' && selectedFile) {
                    apiEndpoint = '/api/image-edit';
                    isImageRequest = true;
                    // Đối với upload file, chúng ta dùng FormData
                    const formData = new FormData();
                    formData.append('image', selectedFile);
                    formData.append('prompt', inputContent);
                    requestBody = formData;
                } else if (currentMode === 'notetaker') {
                    apiEndpoint = '/api/notetaker';
                    isNoteTakerRequest = true;
                    requestBody = { content: inputContent };
                }

                // Gửi request
                const fetchOptions = isImageRequest ? {
                    method: 'POST',
                    body: requestBody, // FormData không cần 'Content-Type': 'application/json'
                } : {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                };

                const response = await fetch(apiEndpoint, fetchOptions);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                removeTypingIndicator();
                useLimit();

                let aiResponseContent = '';
                
                if (isImageRequest) {
                    // Xử lý response từ Image Edit
                    aiResponseContent = `**AI Photo Editor:** ${data.message}\n\n<image>${data.imageUrl}</image>`;
                } else if (isNoteTakerRequest) {
                    // Xử lý response từ Notetaker
                    aiResponseContent = data.notes;
                } else {
                    // Xử lý response từ Chat/Summarizer/Video Creator
                    aiResponseContent = data.reply;
                }
                
                // 3. Thêm tin nhắn AI và lưu lịch sử
                appendMessage(aiResponseContent, 'ai');
                messages.push({ role: 'assistant', content: aiResponseContent });
                saveChat();

            } catch (error) {
                console.error('Lỗi gửi tin nhắn:', error);
                removeTypingIndicator();
                appendMessage(`❌ Đã xảy ra lỗi: ${error.message}. Vui lòng thử lại hoặc kiểm tra server console.`, 'ai');
                messages.push({ role: 'assistant', content: `Đã xảy ra lỗi.` });
                saveChat();
            } finally {
                isProcessing = false;
                sendBtn.disabled = userInput.value.trim() === '' && !selectedFile;
            }
        }
        
        // --- CHỨC NĂNG VOICE (Giữ nguyên) ---
        // ... (Logic Voice Recognition được giữ nguyên nếu có) ...
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        let isListening = false;

        if (recognition) {
            recognition.lang = 'vi-VN'; 
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isListening = true;
                voiceStatus.textContent = 'Đang Nghe... Hãy nói!';
                micWave.classList.add('listening');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                userInput.dispatchEvent(new Event('input')); // Cập nhật chiều cao và nút gửi
                voiceOverlay.style.display = 'none';
                isListening = false;
            };

            recognition.onerror = (event) => {
                console.error('Lỗi nhận dạng giọng nói:', event.error);
                voiceStatus.textContent = `Lỗi: ${event.error}. Nhấn Mic để Thử Lại.`;
                micWave.classList.remove('listening');
                isListening = false;
            };
            
            recognition.onend = () => {
                isListening = false;
                voiceStatus.textContent = 'Nhấn Mic để Bắt đầu Nói...';
                micWave.classList.remove('listening');
            };
            
            voiceBtn.addEventListener('click', () => {
                if (isProcessing) return;
                voiceOverlay.style.display = 'flex';
                // Đảm bảo nút Mic trong overlay cũng hoạt động
                if (!isListening) {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error("Error starting recognition:", e);
                        voiceStatus.textContent = 'Lỗi: Không thể bắt đầu nhận dạng giọng nói.';
                    }
                }
            });
            
            document.getElementById('voice-mic-icon').addEventListener('click', () => {
                 if (isListening) {
                    recognition.stop();
                } else {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error("Error starting recognition:", e);
                        voiceStatus.textContent = 'Lỗi: Không thể bắt đầu nhận dạng giọng nói.';
                    }
                }
            });

        } else {
            voiceBtn.style.display = 'none';
        }

        voiceCloseBtn.addEventListener('click', () => {
            if (isListening) {
                recognition.stop();
            }
            voiceOverlay.style.display = 'none';
        });

    </script>
</body>
</html>