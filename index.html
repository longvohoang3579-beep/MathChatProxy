<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Chat - Gemini 2.5 + Pollinations</title>
<style>
  body {background:#0f172a;color:white;font-family:sans-serif;margin:0;padding:0;display:flex;flex-direction:column;align-items:center;}
  .tabs {display:flex;gap:10px;margin:10px;}
  .tab {padding:8px 16px;border-radius:8px;background:#1e293b;cursor:pointer;}
  .tab.active {background:#2563eb;}
  .tab-content {display:none;width:90%;max-width:700px;background:#1e293b;padding:12px;border-radius:12px;}
  .tab-content.active {display:block;}
  .chat-box {height:420px;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px;}
  .bubble {padding:8px 12px;border-radius:10px;max-width:80%;word-wrap:break-word;}
  .user {background:#2563eb;align-self:flex-end;}
  .ai {background:#334155;align-self:flex-start;}
  .pending-preview {display:flex;gap:8px;flex-wrap:wrap;margin:6px 0;}
  .pending-preview img {width:60px;height:60px;object-fit:cover;border-radius:8px;border:2px solid #475569;}
  .input-row {display:flex;align-items:center;gap:8px;margin-top:8px;}
  textarea {flex:1;resize:none;border:none;padding:8px;border-radius:8px;background:#0f172a;color:white;}
  .icon-btn {padding:8px;border-radius:8px;background:#334155;cursor:pointer;font-size:18px;}
  .icon-btn:hover {background:#475569;}
  .send-btn {background:#2563eb;color:white;font-size:22px;padding:8px 14px;border-radius:10px;}
  .send-btn:hover {background:#3b82f6;}
  .file-link {color:#93c5fd;text-decoration:underline;}
</style>
</head>
<body>
<h2>✨ Gemini 2.5 Chat + Giải toán + Pollinations</h2>
<div class="tabs">
  <div class="tab active" data-tab="chat">💬 Chat</div>
  <div class="tab" data-tab="math">🧮 Giải toán</div>
  <div class="tab" data-tab="image">🎨 Tạo ảnh</div>
</div>

<!-- CHAT TAB -->
<div id="chat" class="tab-content active">
  <div id="chatBox" class="chat-box"></div>
  <div id="chatPreview" class="pending-preview"></div>
  <div class="input-row">
    <label class="icon-btn" for="chatFileInput">📁</label>
    <input type="file" id="chatFileInput" accept="image/*,.pdf,.docx" style="display:none">
    <button class="icon-btn" id="chatCameraBtn">📷</button>
    <textarea id="chatInput" placeholder="Nhập tin nhắn..."></textarea>
    <button class="send-btn" id="btnChat">›</button>
  </div>
</div>

<!-- MATH TAB -->
<div id="math" class="tab-content">
  <div id="mathBox" class="chat-box"></div>
  <div id="mathPreview" class="pending-preview"></div>
  <div class="input-row">
    <label class="icon-btn" for="mathFileInput">📁</label>
    <input type="file" id="mathFileInput" accept="image/*,.pdf,.docx" style="display:none">
    <button class="icon-btn" id="mathCameraBtn">📷</button>
    <textarea id="mathPrompt" placeholder="Nhập bài toán..."></textarea>
    <button class="send-btn" id="btnMath">›</button>
  </div>
</div>

<!-- IMAGE TAB -->
<div id="image" class="tab-content">
  <div id="imageBox" class="chat-box"></div>
  <div class="input-row">
    <textarea id="imagePrompt" placeholder="Nhập mô tả ảnh..."></textarea>
    <button class="send-btn" id="btnCreateImage">›</button>
  </div>
</div>

<script>
let chatPendingFiles = [], mathPendingFiles = [];

// Gắn event tab
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  }
});

// ==== CHAT ====
document.getElementById("chatFileInput").addEventListener("change",e=>{
  chatPendingFiles=[...e.target.files];
  renderPreview("chatPreview",chatPendingFiles);
});
document.getElementById("btnChat").addEventListener("click",async()=>{
  const text=document.getElementById("chatInput").value.trim();
  if(!text && chatPendingFiles.length===0)return;
  addUserBubble("chatBox",text,chatPendingFiles);
  const files=await filesToBase64(chatPendingFiles);
  document.getElementById("chatPreview").innerHTML="";
  chatPendingFiles=[];
  document.getElementById("chatInput").value="";
  try{
    const res=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:text,images:files})});
    const data=await res.json();
    addAIBubble("chatBox",data.reply||"❌ Không có phản hồi hợp lệ từ Gemini.");
  }catch{addAIBubble("chatBox","❌ Lỗi kết nối server.");}
});

// ==== MATH ====
document.getElementById("mathFileInput").addEventListener("change",e=>{
  mathPendingFiles=[...e.target.files];
  renderPreview("mathPreview",mathPendingFiles);
});
document.getElementById("btnMath").addEventListener("click",async()=>{
  const text=document.getElementById("mathPrompt").value.trim();
  if(!text && mathPendingFiles.length===0)return;
  addUserBubble("mathBox",text,mathPendingFiles);
  const files=await filesToBase64(mathPendingFiles);
  document.getElementById("mathPreview").innerHTML="";
  mathPendingFiles=[];
  document.getElementById("mathPrompt").value="";
  try{
    const res=await fetch("/api/math",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:text,images:files})});
    const data=await res.json();
    addAIBubble("mathBox",data.reply||"❌ Không có phản hồi hợp lệ từ Gemini.");
  }catch{addAIBubble("mathBox","❌ Lỗi kết nối server.");}
});

// ==== IMAGE (Pollinations) ====
document.getElementById("btnCreateImage").addEventListener("click",async()=>{
  const text=document.getElementById("imagePrompt").value.trim();
  if(!text)return;
  addUserBubble("imageBox",text);
  addAIBubble("imageBox","🧠 Đang tạo ảnh...");
  try{
    const res=await fetch("/api/pollinations-image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:text})});
    const data=await res.json();
    updateLastAIBubble("imageBox",`<img src="${data.imageUrl}" style="max-width:100%;border-radius:10px;">`);
  }catch{updateLastAIBubble("imageBox","❌ Lỗi kết nối server.");}
});

// ==== HÀM PHỤ ====
function renderPreview(id,files){
  const container=document.getElementById(id);
  container.innerHTML="";
  files.forEach(f=>{
    if(f.type.startsWith("image/")){
      const img=document.createElement("img");
      img.src=URL.createObjectURL(f);
      container.appendChild(img);
    }else{
      const span=document.createElement("span");
      span.textContent=f.name;
      container.appendChild(span);
    }
  });
}

function addUserBubble(boxId,text,files=[]){
  const box=document.getElementById(boxId);
  const div=document.createElement("div");
  div.className="bubble user";
  if(files?.length){
    files.forEach(f=>{
      if(f.type.startsWith("image/")){
        const img=document.createElement("img");
        img.src=URL.createObjectURL(f);
        img.style="max-width:120px;border-radius:6px;display:block;margin-bottom:6px;";
        div.appendChild(img);
      }else{
        const a=document.createElement("a");
        a.href=URL.createObjectURL(f);
        a.textContent=f.name;
        a.className="file-link";
        a.target="_blank";
        div.appendChild(a);
      }
    });
  }
  if(text)div.append(text);
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}

function addAIBubble(boxId,content){
  const box=document.getElementById(boxId);
  const div=document.createElement("div");
  div.className="bubble ai";
  div.innerHTML=content;
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}

function updateLastAIBubble(boxId,html){
  const box=document.getElementById(boxId);
  const last=box.querySelector(".bubble.ai:last-child");
  if(last)last.innerHTML=html;
}

async function filesToBase64(files){
  const arr=[];
  for(const f of files){
    const base64=await new Promise((res,rej)=>{
      const r=new FileReader();
      r.onload=()=>res(r.result);
      r.onerror=rej;
      r.readAsDataURL(f);
    });
    arr.push({name:f.name,type:f.type,data:base64});
  }
  return arr;
}
</script>
</body>
</html>
