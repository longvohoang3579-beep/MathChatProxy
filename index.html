<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Assistant Pro</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
/* ================= Global (gi·ªØ nguy√™n phong c√°ch c≈©) ================= */
body {
  background-color:#0f0f13; color:#fff; font-family:'Segoe UI',sans-serif;
  margin:0; padding:0; overflow:hidden;
}

/* ---------------- Intro wrapper (overlay) ---------------- */
#intro-screen {
  position: fixed;
  top:0; left:0; width:100%; height:100vh;
  background: radial-gradient(circle at center, #0b1220 0%, #02040a 70%);
  overflow:hidden;
  display:flex; align-items:center; justify-content:center;
  flex-direction:column; z-index:9999;
  transition:opacity 1.2s ease;
}

/* subtle glowing background to make creatures pop */
#intro-bg {
  position:absolute; inset:0;
  background:
    radial-gradient(circle at 30% 20%, rgba(3,37,58,0.45) 0%, transparent 30%),
    radial-gradient(circle at 80% 80%, rgba(60,8,70,0.35) 0%, transparent 25%),
    linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.6));
  filter: blur(6px);
  opacity:0.9;
  pointer-events:none;
}

/* central logo/text */
#intro-text {
  position:relative;
  color:#facc15;
  font-size:2.3rem; font-weight:700;
  text-shadow:0 0 18px rgba(250,200,50,0.9), 0 0 40px rgba(255,255,255,0.08);
  z-index:10010;
  transform: translateY(-6px);
}

/* subtitle */
#intro-subtext {
  color:#dbeafe;
  margin-top:0.8rem;
  font-size:1rem;
  opacity:0.9;
  z-index:10010;
}

/* ================= Realistic-like dragon & phoenix (SVG-based shapes + motion) =================
   - Use layered SVG groups with gradients and shadows to simulate depth
   - Multiple instances fly from different directions
   - pointer-events:none so they never block clicks on main UI when visible
*/

/* container for creatures */
.creatures {
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:9998;
}

/* each creature wrapper */
.creature {
  position:absolute;
  width:360px; height:200px;
  will-change: transform, opacity;
  filter: drop-shadow(0 12px 20px rgba(0,0,0,0.6));
  opacity:0.95;
}

/* smaller on mobile */
@media (max-width:800px){
  .creature { width:220px; height:130px; }
  #intro-text { font-size:1.6rem; }
}

/* flight keyframes (path-like motion + gentle flap/tilt) */
@keyframes fly-left-to-right {
  0% { transform: translateX(-30vw) translateY(-10vh) scale(0.9) rotate(-18deg); opacity:0; }
  10% { opacity:1; }
  50% { transform: translateX(20vw) translateY(-4vh) scale(1.05) rotate(6deg); }
  100% { transform: translateX(80vw) translateY(6vh) scale(0.95) rotate(18deg); opacity:0; }
}
@keyframes fly-right-to-left {
  0% { transform: translateX(130vw) translateY(12vh) scale(0.9) rotate(18deg); opacity:0; }
  10% { opacity:1; }
  50% { transform: translateX(40vw) translateY(4vh) scale(1.05) rotate(-6deg); }
  100% { transform: translateX(-30vw) translateY(-6vh) scale(0.95) rotate(-18deg); opacity:0; }
}
@keyframes fly-top-to-bottom {
  0% { transform: translateY(-30vh) translateX(2vw) scale(0.9) rotate(-6deg); opacity:0; }
  10% { opacity:1; }
  50% { transform: translateY(10vh) translateX(8vw) scale(1.05) rotate(3deg); }
  100% { transform: translateY(60vh) translateX(20vw) scale(0.95) rotate(10deg); opacity:0; }
}
@keyframes fly-bottom-to-top {
  0% { transform: translateY(130vh) translateX(90vw) scale(0.9) rotate(12deg); opacity:0; }
  10% { opacity:1; }
  50% { transform: translateY(40vh) translateX(70vw) scale(1.05) rotate(-3deg); }
  100% { transform: translateY(-30vh) translateX(60vw) scale(0.95) rotate(-12deg); opacity:0; }
}

/* wing flap (subtle scaling/rotation to simulate flapping) */
@keyframes wing-flap {
  0% { transform: translateY(0) rotate(0deg) scaleY(1); }
  25% { transform: translateY(-2px) rotate(-3deg) scaleY(0.98); }
  50% { transform: translateY(0) rotate(0deg) scaleY(1); }
  75% { transform: translateY(2px) rotate(3deg) scaleY(1.02); }
  100% { transform: translateY(0) rotate(0deg) scaleY(1); }
}

/* each creature gets its own animation timeline and delay */
.creature.dragon-1 { left:-20%; top:10%; animation: fly-left-to-right 5.8s cubic-bezier(.22,.9,.4,1) 0s forwards; transform-origin:center; }
.creature.dragon-2 { left:100%; top:65%; animation: fly-right-to-left 6.4s cubic-bezier(.22,.9,.4,1) 0.8s forwards; transform-origin:center; }
.creature.phoenix-1{ left:10%; top:120%; animation: fly-bottom-to-top 6.6s cubic-bezier(.2,.9,.3,1) 0.3s forwards; transform-origin:center; }
.creature.phoenix-2{ left:80%; top:-30%; animation: fly-top-to-bottom 6s cubic-bezier(.2,.9,.3,1) 1.1s forwards; transform-origin:center; }

/* subtle flap on nested group */
.creature .flap { animation: wing-flap 0.9s ease-in-out infinite; transform-origin:center; }

/* appearance boost: inner glow using pseudo-element */
.creature::after {
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(circle at 50% 40%, rgba(255,200,40,0.06), transparent 40%);
  border-radius: 50%;
  mix-blend-mode: screen;
  pointer-events:none;
}

/* ensure intro text sits above creatures */
#intro-text, #intro-subtext { pointer-events:none; }

/* hide intro when removed (applied by JS) */
.hidden-intro { opacity:0 !important; pointer-events:none !important; }

/* ================= Main UI (gi·ªØ nguy√™n nguy√™n b·∫£n) ================= */
.container {max-width:900px;margin:2rem auto;background:#1a1c29;border-radius:1.5rem;padding:1.5rem;box-shadow:0 15px 30px rgba(0,0,0,0.7);display:none;}
.tabs {display:flex;border-bottom:2px solid #333;margin-bottom:1rem;}
.tab-btn {flex:1;text-align:center;padding:1rem;cursor:pointer;color:#aaa;font-weight:bold;transition:all 0.2s;}
.tab-btn.active {color:#fff;border-bottom:3px solid #facc15;}
.tab-content {display:none;}
.tab-content.active {display:block;}
.chat-box {background:#111827;border-radius:12px;padding:1rem;height:400px;overflow-y:auto;display:flex;flex-direction:column; scroll-behavior: smooth;}
.bubble {max-width:80%;padding:10px 14px;border-radius:12px;margin-bottom:10px;line-height:1.5;word-wrap:break-word;white-space:pre-wrap;}
.user-bubble {background:#2563eb;align-self:flex-end;color:white;border-bottom-right-radius:2px;}
.ai-bubble {background:#374151;align-self:flex-start;color:#e5e7eb;border-bottom-left-radius:2px;}
mark.highlight {background-color:#fde047;color:black;font-weight:bold;padding:0 3px;border-radius:3px;}
textarea,input{width:100%;padding:0.75rem;border-radius:0.75rem;background:#1e1e2a;border:1px solid #333;color:white;resize:none;outline:none;}
button{padding:0.75rem 1rem;border-radius:0.75rem;font-weight:bold;cursor:pointer;transition:all 0.2s; border: none;}
#btnCreateImage{background:#10b981;color:#111827;}#btnCreateImage:hover{background:#059669;}
.send-btn{background:#6366f1;color:white;} .send-btn:hover{background:#4f46e5;} /* G·ªôp chung cho c√°c n√∫t g·ª≠i */
img.generated-image, .generated-video {border-radius:12px;max-width:100%;margin-top:1rem; display: block; max-height: 400px; margin-left: auto; margin-right: auto;}
#settings-btn{position:absolute;top:1rem;right:1rem;font-size:1.5rem;cursor:pointer;color:#facc15;}
#settings-modal{position:absolute;top:3rem;right:1rem;width:200px;background:#1a1c29;border:1px solid #facc15;border-radius:0.75rem;padding:1rem;display:none; z-index: 100;}
.pending-preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
.pending-preview img{width:60px;height:60px;object-fit:cover;border-radius:8px;border:2px solid #475569;}
.input-row{display:flex;align-items:center;gap:6px;margin-top:8px;}
.icon-btn{background:#27293a;padding:8px;border-radius:8px;cursor:pointer;transition:0.2s;}
.icon-btn:hover{background:#3f4259;}
.icon-btn svg{width:22px;height:22px;color:#facc15;}
.send-btn{background:#6366f1;padding:10px;border-radius:50%;display:flex;align-items:center;justify-content:center;}
.send-btn:hover{background:#4f46e5;}
.send-btn svg{width:22px;height:22px;transform:rotate(0deg);}

</style>
</head>

<body>
<!-- INTRO -->
<div id="intro-screen" role="dialog" aria-label="Intro animation">
  <div id="intro-bg"></div>

  <!-- animated creatures group -->
  <div class="creatures" aria-hidden="true">
    <!-- Dragon 1 (left->right) -->
    <div class="creature dragon-1" aria-hidden="true">
      <!-- SVG stylized realistic-ish dragon head + body (gradient fills for depth) -->
      <svg viewBox="0 0 900 500" preserveAspectRatio="xMidYMid meet" style="width:100%; height:100%;">
        <defs>
          <linearGradient id="dGradA" x1="0" x2="1">
            <stop offset="0%" stop-color="#2b2a2a"/>
            <stop offset="40%" stop-color="#6b3f1f"/>
            <stop offset="100%" stop-color="#b86c1a"/>
          </linearGradient>
          <linearGradient id="dGradB" x1="0" x2="1">
            <stop offset="0%" stop-color="#ffefbf" stop-opacity="0.15"/>
            <stop offset="100%" stop-color="#ffd080" stop-opacity="0.02"/>
          </linearGradient>
          <filter id="soft" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="6" result="blur"/>
            <feBlend in="SourceGraphic" in2="blur"/>
          </filter>
        </defs>

        <!-- body -->
        <g transform="translate(0,80) scale(0.8)">
          <ellipse cx="420" cy="240" rx="300" ry="90" fill="url(#dGradA)" opacity="0.98"/>
          <!-- layered scale pattern -->
          <g opacity="0.25" transform="translate(60,160)">
            <path d="M0 0 C60 -40, 120 -40, 180 0 C240 40, 300 40, 360 0" fill="#000" transform="scale(1.6,0.8)" opacity="0.08"></path>
          </g>

          <!-- wing (flapping group) -->
          <g class="flap" transform="translate(200,100)">
            <path d="M20 180 C120 20, 340 -20, 440 160 C360 140, 240 160, 20 180 Z" fill="#8b3d22" opacity="0.95" />
            <path d="M20 180 C120 20, 340 -20, 440 160 C360 140, 240 160, 20 180 Z" fill="url(#dGradB)" opacity="0.35" />
          </g>

          <!-- head -->
          <g transform="translate(520,110) scale(0.7)">
            <path d="M45 95 C60 20, 140 10, 170 55 C195 90, 185 120, 140 140 C80 170, 10 150, 45 95 Z" fill="#4b2b1b"/>
            <path d="M110 55 C130 40, 145 50, 155 70" stroke="#ffd27a" stroke-width="3" fill="none" opacity="0.8"/>
            <circle cx="150" cy="75" r="5" fill="#f7d86a"/>
          </g>
        </g>
      </svg>
    </div>

    <!-- Dragon 2 (right->left) -->
    <div class="creature dragon-2" aria-hidden="true">
      <svg viewBox="0 0 900 500" preserveAspectRatio="xMidYMid meet" style="width:100%; height:100%;">
        <defs>
          <linearGradient id="dGradC" x1="0" x2="1">
            <stop offset="0%" stop-color="#1e2a3a"/>
            <stop offset="50%" stop-color="#2f6b86"/>
            <stop offset="100%" stop-color="#4fb1d6"/>
          </linearGradient>
        </defs>
        <g transform="translate(0,60) scale(0.8)">
          <ellipse cx="420" cy="240" rx="280" ry="80" fill="url(#dGradC)" opacity="0.98"/>
          <g class="flap" transform="translate(150,90)">
            <path d="M20 180 C120 20, 340 -20, 440 160 C360 140, 240 160, 20 180 Z" fill="#14384d" opacity="0.95" />
            <path d="M20 180 C120 20, 340 -20, 440 160 C360 140, 240 160, 20 180 Z" fill="#7fd6f0" opacity="0.12" />
          </g>
          <g transform="translate(120,60) scale(0.85)">
            <path d="M45 95 C60 20, 140 10, 170 55 C195 90, 185 120, 140 140 C80 170, 10 150, 45 95 Z" fill="#0e2733"/>
            <circle cx="150" cy="75" r="5" fill="#cfeeff"/>
          </g>
        </g>
      </svg>
    </div>

    <!-- Phoenix 1 (bottom->top) -->
    <div class="creature phoenix-1" aria-hidden="true">
      <svg viewBox="0 0 900 500" preserveAspectRatio="xMidYMid meet" style="width:100%; height:100%;">
        <defs>
          <radialGradient id="pG1" cx="30%" cy="30%">
            <stop offset="0%" stop-color="#ffd07a"/>
            <stop offset="50%" stop-color="#ff6c00"/>
            <stop offset="100%" stop-color="#b31a00"/>
          </radialGradient>
        </defs>
        <g transform="translate(0,40) scale(0.8)">
          <ellipse cx="420" cy="220" rx="260" ry="80" fill="url(#pG1)" opacity="0.98"/>
          <g class="flap" transform="translate(240,60)">
            <path d="M20 180 C120 20, 340 -20, 440 160 C360 140, 240 160, 20 180 Z" fill="#ff9a3c" opacity="0.95" />
            <path d="M20 180 C120 20, 340 -20, 440 160 C360 140, 240 160, 20 180 Z" fill="#ffd7b0" opacity="0.25" />
          </g>
          <g transform="translate(520,110) scale(0.7)">
            <path d="M45 95 C60 20, 140 10, 170 55 C195 90, 185 120, 140 140 C80 170, 10 150, 45 95 Z" fill="#8b2500"/>
            <circle cx="150" cy="75" r="5" fill="#fff5d1"/>
          </g>
        </g>
      </svg>
    </div>

    <!-- Phoenix 2 (top->bottom) -->
    <div class="creature phoenix-2" aria-hidden="true">
      <svg viewBox="0 0 900 500" preserveAspectRatio="xMidYMid meet" style="width:100%; height:100%;">
        <defs>
          <radialGradient id="pG2" cx="70%" cy="70%">
            <stop offset="0%" stop-color="#ffd7a6"/>
            <stop offset="50%" stop-color="#ff3e00"/>
            <stop offset="100%" stop-color="#6b1300"/>
          </radialGradient>
        </defs>
        <g transform="translate(0,60) scale(0.8)">
          <ellipse cx="420" cy="240" rx="260" ry="80" fill="url(#pG2)" opacity="0.98"/>
          <g class="flap" transform="translate(100,80)">
            <path d="M20 180 C120 20, 340 -20, 440 160 C360 140, 240 160, 20 180 Z" fill="#ff6a2b" opacity="0.95" />
            <path d="M20 180 C120 20, 340 -20, 440 160 C360 140, 240 160, 20 180 Z" fill="#ffd7b0" opacity="0.22" />
          </g>
          <g transform="translate(560,140) scale(0.7)">
            <path d="M45 95 C60 20, 140 10, 170 55 C195 90, 185 120, 140 140 C80 170, 10 150, 45 95 Z" fill="#6e1a00"/>
            <circle cx="150" cy="75" r="5" fill="#fff2d8"/>
          </g>
        </g>
      </svg>
    </div>
  </div>

  <!-- central text/logo stays above -->
  <div id="intro-text">‚ú® Welcome to <mark style="background:#111;color:#facc15;padding:3px 6px;border-radius:6px;">AI Assistant Pro</mark> ‚ú®</div>
  <div id="intro-subtext">Unleash the magic of creativity and intelligence.</div>
</div>

<!-- ================= MAIN UI (NGUY√äN B·∫¢N) ================= -->
<div class="container relative" id="mainApp">
  <div id="settings-btn">‚öôÔ∏è</div>
  <div id="settings-modal">
    <label class="block mb-2">Ng√¥n ng·ªØ chat:</label>
    <select id="language-select" class="w-full p-2 rounded bg-gray-800 text-white">
      <option value="vi">Ti·∫øng Vi·ªát</option>
      <option value="en">English</option>
      <option value="zh-CN">ÁÆÄ‰Ωì‰∏≠Êñá</option>
    </select>
  </div>

  <div class="tabs">
    <div class="tab-btn active" data-tab="image">üñºÔ∏è T·∫°o ·∫¢nh</div>
    <div class="tab-btn" data-tab="chat">üí¨ Chat</div>
    <div class="tab-btn" data-tab="math">üßÆ Gi·∫£i To√°n</div>
    <div class="tab-btn" data-tab="video">üéûÔ∏è T·∫°o Video</div>
  </div>

  <div class="tab-content active" id="image">
    <div class="chat-box" id="imageBox"></div>
    <textarea id="imagePrompt" rows="2" placeholder="Nh·∫≠p m√¥ t·∫£ ·∫£nh..."></textarea>
    <button id="btnCreateImage" class="mt-2 w-full">T·∫°o ·∫¢nh</button>
  </div>

  <div class="tab-content" id="chat">
    <div class="chat-box" id="chatBox"></div>
    <div class="pending-preview" id="chatPreview"></div>
    <div class="input-row">
      <label class="icon-btn" for="chatFileInput" title="T·∫£i ·∫£nh ho·∫∑c file">üìÅ</label>
      <input type="file" id="chatFileInput" accept="image/*" hidden />
      <textarea id="chatInput" rows="1" placeholder="Nh·∫≠p tin nh·∫Øn..."></textarea>
      <button id="btnChat" class="send-btn" title="G·ª≠i">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="white" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12l14 7-7-7 7-7-14 7z"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="tab-content" id="math">
    <div class="chat-box" id="mathBox"></div>
    <div class="pending-preview" id="mathPreview"></div>
    <div class="input-row">
      <label class="icon-btn" for="mathFileInput" title="T·∫£i ·∫£nh ho·∫∑c file">üìÅ</label>
      <input type="file" id="mathFileInput" accept="image/*" hidden />
      <textarea id="mathPrompt" rows="1" placeholder="Nh·∫≠p b√†i to√°n..."></textarea>
      <button id="btnMath" class="send-btn" title="Gi·∫£i">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="white" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12l14 7-7-7 7-7-14 7z"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="tab-content" id="video">
    <div class="chat-box" id="videoBox"></div>
    <div class="pending-preview" id="videoPreview"></div>
    <div class="input-row">
       <textarea id="videoPrompt" rows="1" placeholder="Nh·∫≠p m√¥ t·∫£ video..."></textarea>
      <button id="btnVideo" class="send-btn" title="T·∫°o Video">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="white" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12l14 7-7-7 7-7-14 7z"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- ================= Scripts: gi·ªØ nguy√™n logic chat/image/math/video (GI·ªÆ NGUY√äN) ================= -->
<script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>
<script src="https://unpkg.com/gif.js@0.2.0/dist/gif.worker.js"></script>

<script>
// ================= Intro lifecycle =================
// Remove intro after 6s (fade) and ensure main UI shown
function endIntro() {
  const intro = document.getElementById('intro-screen');
  intro.classList.add('hidden-intro');
  setTimeout(() => {
    intro.style.display = 'none';
    const mainApp = document.getElementById('mainApp');
    mainApp.style.display = 'block';
    document.body.style.overflow = 'auto';
  }, 400); // short wait for fade transition
}

window.addEventListener('load', () => {
  // start: let creatures animate (CSS handles motion). After 6s remove intro.
  setTimeout(endIntro, 6000);
});

// ================= Tabs (unchanged) =================
const tabs=document.querySelectorAll(".tab-btn");
const contents=document.querySelectorAll(".tab-content");
tabs.forEach(tab=>tab.addEventListener("click",()=>{
  tabs.forEach(t=>t.classList.remove("active"));
  contents.forEach(c=>c.classList.remove("active"));
  tab.classList.add("active");
  document.getElementById(tab.dataset.tab).classList.add("active");
}));

// ================= Main app JS (GI·ªÆ NGUY√äN ch·ª©c nƒÉng) =================
document.addEventListener('DOMContentLoaded', () => {

    // === L·∫•y c√°c ph·∫ßn t·ª≠ DOM ===
    const imageBox = document.getElementById('imageBox');
    const imagePrompt = document.getElementById('imagePrompt');
    const btnCreateImage = document.getElementById('btnCreateImage');

    const chatBox = document.getElementById('chatBox');
    const chatInput = document.getElementById('chatInput');
    const btnChat = document.getElementById('btnChat');
    const chatFileInput = document.getElementById('chatFileInput');
    const chatPreview = document.getElementById('chatPreview');

    const mathBox = document.getElementById('mathBox');
    const mathPrompt = document.getElementById('mathPrompt');
    const btnMath = document.getElementById('btnMath');
    const mathFileInput = document.getElementById('mathFileInput');
    const mathPreview = document.getElementById('mathPreview');

    const videoBox = document.getElementById('videoBox');
    const videoPrompt = document.getElementById('videoPrompt');
    const btnVideo = document.getElementById('btnVideo');

    const languageSelect = document.getElementById('language-select');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');

    // L∆∞u tr·ªØ ·∫£nh ƒë√£ upload (d∆∞·ªõi d·∫°ng base64)
    let uploadedFiles = { chat: null, math: null };

    // === H√†m tr·ª£ gi√∫p ===
    function appendMessage(box, content, type) {
        const bubble = document.createElement('div');
        bubble.classList.add('bubble', type === 'user' ? 'user-bubble' : 'ai-bubble');
        bubble.innerHTML = content;
        box.appendChild(bubble);
        box.scrollTop = box.scrollHeight;
        return bubble;
    }

    function showLoading(box) {
        return appendMessage(box, 'ƒêang x·ª≠ l√Ω...', 'ai');
    }

    function handleFileUpload(event, type) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onloadend = () => {
            uploadedFiles[type] = reader.result;
            const previewContainer = type === 'chat' ? chatPreview : mathPreview;
            previewContainer.innerHTML = `<img src="${reader.result}" alt="preview">`;
        };
        reader.readAsDataURL(file);
    }

    // === G√°n s·ª± ki·ªán ===

    // 1. T·∫°o ·∫£nh
    btnCreateImage.addEventListener('click', async () => {
        const prompt = imagePrompt.value.trim();
        if (!prompt) return;

        appendMessage(imageBox, prompt, 'user');
        const loadingBubble = showLoading(imageBox);
        imagePrompt.value = '';

        try {
            const response = await fetch('/api/pollinations-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt }),
            });

            if (!response.ok) throw new Error('L·ªói t·ª´ server: ' + response.statusText);

            const data = await response.json();
            loadingBubble.innerHTML = `<img src="${data.imageUrl}" class="generated-image" alt="Generated Image">`;
        } catch (error) {
            loadingBubble.textContent = `‚ùå L·ªói: ${error.message}`;
        }
    });

    // 2. Chat
    async function handleChat() {
        const message = chatInput.value.trim();
        const image = uploadedFiles.chat;
        if (!message && !image) return;

        appendMessage(chatBox, message, 'user');
        const loadingBubble = showLoading(chatBox);
        chatInput.value = '';
        chatPreview.innerHTML = '';
        uploadedFiles.chat = null;

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message,
                    image,
                    language: languageSelect.value,
                    history: []
                }),
            });
            if (!response.ok) throw new Error('L·ªói t·ª´ server: ' + response.statusText);
            const data = await response.json();
            loadingBubble.innerHTML = data.response;
        } catch (error) {
            loadingBubble.textContent = `‚ùå L·ªói: ${error.message}`;
        }
    }
    btnChat.addEventListener('click', handleChat);
    chatInput.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleChat(); } });

    // 3. Gi·∫£i to√°n
    async function handleMath() {
        const question = mathPrompt.value.trim();
        const image = uploadedFiles.math;
        if (!question && !image) return;

        appendMessage(mathBox, question, 'user');
        const loadingBubble = showLoading(mathBox);
        mathPrompt.value = '';
        mathPreview.innerHTML = '';
        uploadedFiles.math = null;

        try {
            const response = await fetch('/api/math', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question, image }),
            });
            if (!response.ok) throw new Error('L·ªói t·ª´ server: ' + response.statusText);
            const data = await response.json();
            loadingBubble.innerHTML = data.response;
            MathJax.typesetPromise([loadingBubble]);
        } catch (error) {
            loadingBubble.textContent = `‚ùå L·ªói: ${error.message}`;
        }
    }
    btnMath.addEventListener('click', handleMath);
    mathPrompt.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleMath(); } });

    // 4. T·∫°o Video (GIF)
    btnVideo.addEventListener('click', async () => {
        const prompt = videoPrompt.value.trim();
        if (!prompt) return;

        appendMessage(videoBox, prompt, 'user');
        const loadingBubble = showLoading(videoBox);
        videoPrompt.value = '';

        try {
            loadingBubble.textContent = 'ƒêang t·∫£i c√°c khung h√¨nh (b∆∞·ªõc 1/2)...';
            const frameResponse = await fetch('/api/pollinations-frames', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt }),
            });

            if (!frameResponse.ok) throw new Error(`L·ªói t·∫£i khung h√¨nh: ${frameResponse.statusText}`);
            const { frames } = await frameResponse.json();

            if (!frames || frames.length === 0) throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c khung h√¨nh n√†o.');

            loadingBubble.textContent = `ƒêang render video t·ª´ ${frames.length} khung h√¨nh (b∆∞·ªõc 2/2)...`;

            const gif = new GIF({
                workers: 2,
                quality: 10,
                width: 512,
                height: 512
            });

            const imagePromises = frames.map(frameData => {
                return new Promise(resolve => {
                    const img = new Image();
                    img.src = frameData;
                    img.onload = () => resolve(img);
                    img.onerror = () => resolve(null);
                });
            });

            const imageElements = (await Promise.all(imagePromises)).filter(Boolean);

            imageElements.forEach(img => {
                gif.addFrame(img, { delay: 100 });
            });

            gif.on('finished', function(blob) {
                const videoUrl = URL.createObjectURL(blob);
                loadingBubble.innerHTML = `<img src="${videoUrl}" class="generated-video" alt="Generated Video">`;
                videoBox.scrollTop = videoBox.scrollHeight;
            });

            gif.render();

        } catch (error) {
            loadingBubble.textContent = `‚ùå L·ªói: ${error.message}`;
        }
    });

    // other events
    chatFileInput.addEventListener('change', (e) => handleFileUpload(e, 'chat'));
    mathFileInput.addEventListener('change', (e) => handleFileUpload(e, 'math'));

    // settings toggle
    settingsBtn.addEventListener('click', () => {
        settingsModal.style.display = settingsModal.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', (e) => {
        if (!settingsModal.contains(e.target) && !settingsBtn.contains(e.target)) {
            settingsModal.style.display = 'none';
        }
    });
});
</script>
</body>
</html>
