<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Assistant Pro</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
body { background-color:#0f0f13; color:#fff; font-family:'Segoe UI',sans-serif; margin:0; padding:0;}
.container {max-width:900px;margin:2rem auto;background:#1a1c29;border-radius:1.5rem;padding:1.5rem;box-shadow:0 15px 30px rgba(0,0,0,0.7);}
.tabs {display:flex;border-bottom:2px solid #333;margin-bottom:1rem;}
.tab-btn {flex:1;text-align:center;padding:1rem;cursor:pointer;color:#aaa;font-weight:bold;transition:all 0.2s;}
.tab-btn.active {color:#fff;border-bottom:3px solid #facc15;}
.tab-content {display:none;}
.tab-content.active {display:block;}
.chat-box {background:#111827;border-radius:12px;padding:1rem;height:400px;overflow-y:auto;display:flex;flex-direction:column;}
.bubble {max-width:80%;padding:10px 14px;border-radius:12px;margin-bottom:10px;line-height:1.5;word-wrap:break-word;white-space:pre-wrap;}
.user-bubble {background:#2563eb;align-self:flex-end;color:white;border-bottom-right-radius:2px;}
.ai-bubble {background:#374151;align-self:flex-start;color:#e5e7eb;border-bottom-left-radius:2px;}
mark.highlight {background-color:#fde047;color:black;font-weight:bold;padding:0 3px;border-radius:3px;}
textarea,input{width:100%;padding:0.75rem;border-radius:0.75rem;background:#1e1e2a;border:1px solid #333;color:white;resize:none;outline:none;}
button{padding:0.75rem 1rem;border-radius:0.75rem;font-weight:bold;cursor:pointer;transition:all 0.2s;}
#btnCreateImage{background:#10b981;color:#111827;}#btnCreateImage:hover{background:#059669;}
#btnChat{background:#6366f1;color:white;}#btnChat:hover{background:#4f46e5;}
#btnMath{background:#f59e0b;color:#111827;}#btnMath:hover{background:#d97706;}
img.generated-image{border-radius:12px;max-width:100%;margin-top:1rem;}
#settings-btn{position:absolute;top:1rem;right:1rem;font-size:1.5rem;cursor:pointer;color:#facc15;}
#settings-modal{position:absolute;top:3rem;right:1rem;width:200px;background:#1a1c29;border:1px solid #facc15;border-radius:0.75rem;padding:1rem;display:none;}
.pending-preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
.pending-preview img{width:60px;height:60px;object-fit:cover;border-radius:8px;border:2px solid #475569;}
.input-row{display:flex;align-items:center;gap:6px;margin-top:8px;}
.icon-btn{background:#27293a;padding:8px;border-radius:8px;cursor:pointer;transition:0.2s;}
.icon-btn:hover{background:#3f4259;}
.icon-btn svg{width:22px;height:22px;color:#facc15;}
.send-btn{background:#6366f1;padding:10px;border-radius:50%;display:flex;align-items:center;justify-content:center;}
.send-btn:hover{background:#4f46e5;}
.send-btn svg{width:22px;height:22px;transform:rotate(0deg);} /* âœ… xoay ra pháº£i */
.generated-video{border-radius:12px;max-width:100%;margin-top:1rem;}
</style>
<!-- ThÃªm thÆ° viá»‡n gif.js Ä‘á»ƒ ghÃ©p áº£nh thÃ nh GIF trong trÃ¬nh duyá»‡t -->
<script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>
<script src="https://unpkg.com/gif.js@0.2.0/dist/gif.worker.js"></script>
</head>
<body>
<div class="container relative">
Â  <div id="settings-btn">âš™ï¸</div>
Â  <div id="settings-modal">
Â  Â  <label class="block mb-2">NgÃ´n ngá»¯ chat:</label>
Â  Â  <select id="language-select" class="w-full p-2 rounded bg-gray-800 text-white">
Â  Â  Â  <option value="vi">Tiáº¿ng Viá»‡t</option>
Â  Â  Â  <option value="en">English</option>
Â  Â  Â  <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
Â  Â  </select>
Â  </div>

Â  <div class="tabs">
Â  Â  <div class="tab-btn active" data-tab="image">ğŸ–¼ï¸ Táº¡o áº¢nh</div>
Â  Â  <div class="tab-btn" data-tab="chat">ğŸ’¬ Chat</div>
Â  Â  <div class="tab-btn" data-tab="math">ğŸ§® Giáº£i ToÃ¡n</div>
Â  Â  <div class="tab-btn" data-tab="video">ğŸï¸ Táº¡o Video</div>
Â  </div>

Â  <!-- Táº¡o áº¢nh -->
Â  <div class="tab-content active" id="image">
Â  Â  <div class="chat-box" id="imageBox"></div>
Â  Â  <textarea id="imagePrompt" rows="2" placeholder="Nháº­p mÃ´ táº£ áº£nh..."></textarea>
Â  Â  <button id="btnCreateImage" class="mt-2 w-full">Táº¡o áº¢nh</button>
Â  </div>

Â  <!-- Chat -->
Â  <div class="tab-content" id="chat">
Â  Â  <div class="chat-box" id="chatBox"></div>
Â  Â  <div class="pending-preview" id="chatPreview"></div>
Â  Â  <div class="input-row">
Â  Â  Â  <label class="icon-btn" for="chatFileInput" title="Táº£i áº£nh hoáº·c file">ğŸ“</label>
Â  Â  Â  <input type="file" id="chatFileInput" accept="image/*,.pdf,.txt,.docx" hidden />
Â  Â  Â  <label class="icon-btn" id="chatCameraBtn" title="Chá»¥p áº£nh">ğŸ“·</label>
Â  Â  Â  <textarea id="chatInput" rows="1" placeholder="Nháº­p tin nháº¯n..."></textarea>
Â  Â  Â  <button id="btnChat" class="send-btn" title="Gá»­i">
Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="white" viewBox="0 0 24 24">
Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12l14 7-7-7 7-7-14 7z"/>
Â  Â  Â  Â  </svg>
Â  Â  Â  </button>
Â  Â  </div>
Â  </div>

Â  <!-- Giáº£i ToÃ¡n -->
Â  <div class="tab-content" id="math">
Â  Â  <div class="chat-box" id="mathBox"></div>
Â  Â  <div class="pending-preview" id="mathPreview"></div>
Â  Â  <div class="input-row">
Â  Â  Â  <label class="icon-btn" for="mathFileInput" title="Táº£i áº£nh hoáº·c file">ğŸ“</label>
Â  Â  Â  <input type="file" id="mathFileInput" accept="image/*,.pdf,.txt,.docx" hidden />
Â  Â  Â  <label class="icon-btn" id="mathCameraBtn" title="Chá»¥p áº£nh">ğŸ“·</label>
Â  Â  Â  <textarea id="mathPrompt" rows="1" placeholder="Nháº­p bÃ i toÃ¡n..."></textarea>
Â  Â  Â  <button id="btnMath" class="send-btn" title="Giáº£i">
Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="white" viewBox="0 0 24 24">
Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12l14 7-7-7 7-7-14 7z"/>
Â  Â  Â  Â  </svg>
Â  Â  Â  </button>
Â  Â  </div>
Â  </div>

Â  <!-- Táº¡o Video -->
Â  <div class="tab-content" id="video">
Â  Â  <div class="chat-box" id="videoBox"></div>
Â  Â  <div class="pending-preview" id="videoPreview"></div>
Â  Â  <div class="input-row">
Â  Â  Â  <label class="icon-btn" for="videoFileInput" title="Táº£i áº£nh hoáº·c file">ğŸ“</label>
Â  Â  Â  <input type="file" id="videoFileInput" accept="image/*" hidden />
Â  Â  Â  <label class="icon-btn" id="videoCameraBtn" title="Chá»¥p áº£nh">ğŸ“·</label>
Â  Â  Â  <textarea id="videoPrompt" rows="1" placeholder="Nháº­p mÃ´ táº£ video..."></textarea>
Â  Â  Â  <button id="btnVideo" class="send-btn" title="Táº¡o Video">
Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="white" viewBox="0 0 24 24">
Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12l14 7-7-7 7-7-14 7z"/>
Â  Â  Â  Â  </svg>
Â  Â  Â  </button>
Â  Â  </div>
Â  </div>
</div>

<script>
/* ---------- Tabs ---------- */
const tabs=document.querySelectorAll(".tab-btn");
const contents=document.querySelectorAll(".tab-content");
tabs.forEach(tab=>{tab.addEventListener("click",()=>{tabs.forEach(t=>t.classList.remove("active"));contents.forEach(c=>c.classList.remove("active"));tab.classList.add("active");document.getElementById(tab.dataset.tab).classList.add("active");});});

/* ---------- Bubbles & Helpers ---------- */
function addBubble(boxId,text,sender){const box=document.getElementById(boxId);const div=document.createElement("div");div.className=`bubble ${sender==="user"?"user-bubble":"ai-bubble"}`;div.innerHTML=text;box.appendChild(div);box.scrollTop=box.scrollHeight;}
function updateLastAIBubble(boxId,text){const box=document.getElementById(boxId);const bubbles=box.getElementsByClassName("ai-bubble");if(bubbles.length>0){bubbles[bubbles.length-1].innerHTML=text;}box.scrollTop=box.scrollHeight;}
function addBubbleWithFiles(boxId,text,files=[],sender='user'){const box=document.getElementById(boxId);const div=document.createElement("div");div.className=`bubble ${sender==='user'?'user-bubble':'ai-bubble'}`;files.forEach(f=>{if(f.type && f.type.startsWith("image/")){const img=document.createElement("img");img.src=URL.createObjectURL(f);img.style="max-width:120px;border-radius:6px;display:block;margin-bottom:6px;";div.appendChild(img);}else{const a=document.createElement("a");a.href=URL.createObjectURL(f);a.textContent=f.name;a.target="_blank";a.className="underline text-yellow-300 block mb-1";div.appendChild(a);}});div.append(text);box.appendChild(div);box.scrollTop=box.scrollHeight;}
function renderPreview(id,files){const container=document.getElementById(id);container.innerHTML="";files.forEach(f=>{if(f.type && f.type.startsWith("image/")){const img=document.createElement("img");img.src=URL.createObjectURL(f);container.appendChild(img);}else{const span=document.createElement("span");span.textContent=f.name;container.appendChild(span);}})}
function toBase64(file){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=()=>resolve(reader.result);reader.onerror=e=>reject(e);reader.readAsDataURL(file);});}

/* ---------- Settings / Language ---------- */
let chatHistory=[];let currentLang=localStorage.getItem("geminiChatLanguage")||"vi";
document.getElementById("language-select").value=currentLang;
const settingsBtn=document.getElementById("settings-btn");const settingsModal=document.getElementById("settings-modal");
settingsBtn.addEventListener("click",()=>{settingsModal.style.display=settingsModal.style.display==="none"?"block":"none";});
document.addEventListener("click",(e)=>{if(!settingsModal.contains(e.target)&&!settingsBtn.contains(e.target)){settingsModal.style.display="none";}});
document.getElementById("language-select").addEventListener("change",(e)=>{currentLang=e.target.value;localStorage.setItem("geminiChatLanguage",currentLang);chatHistory=[];document.getElementById("chatBox").innerHTML="";addBubble("chatBox", `ÄÃ£ chuyá»ƒn ngÃ´n ngá»¯ sang <mark class="highlight">${e.target.options[e.target.selectedIndex].text}</mark>. Vui lÃ²ng báº¯t Ä‘áº§u chat má»›i.`, "ai");});

/* ---------- File inputs & camera placeholders ---------- */
let chatPendingFiles=[], mathPendingFiles=[], videoPendingFiles=[];
document.getElementById("chatFileInput").addEventListener("change",e=>{chatPendingFiles=[...e.target.files];renderPreview("chatPreview",chatPendingFiles);});
document.getElementById("mathFileInput").addEventListener("change",e=>{mathPendingFiles=[...e.target.files];renderPreview("mathPreview",mathPendingFiles);});
document.getElementById("videoFileInput").addEventListener("change",e=>{videoPendingFiles=[...e.target.files];renderPreview("videoPreview",videoPendingFiles);});
document.getElementById("chatCameraBtn").addEventListener("click",()=>addBubble("chatBox","ğŸ“· Camera Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn","ai"));
document.getElementById("mathCameraBtn").addEventListener("click",()=>addBubble("mathBox","ğŸ“· Camera Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn","ai"));
document.getElementById("videoCameraBtn").addEventListener("click",()=>addBubble("videoBox","ğŸ“· Camera Ä‘ang Ä‘Æ°á»£c phÃ¡t triá»ƒn","ai"));

/* ---------- Pollinations Image ---------- */
document.getElementById("btnCreateImage").addEventListener("click",async()=>{
Â  const prompt=document.getElementById("imagePrompt").value.trim(); if(!prompt)return;
Â  addBubble("imageBox",prompt,"user"); document.getElementById("imagePrompt").value="";
Â  addBubble("imageBox","ğŸ§  ÄANG Táº O áº¢NH...","ai");
Â  try{const res=await fetch("/api/pollinations-image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt})});const data=await res.json();updateLastAIBubble("imageBox",`<img src="${data.imageUrl}" class="generated-image">`);}catch{updateLastAIBubble("imageBox","âŒ Lá»—i káº¿t ná»‘i server.");}
});

/* ---------- Chat (Gemini) ---------- */
document.getElementById("btnChat").addEventListener("click",async()=>{
Â  const message=document.getElementById("chatInput").value.trim();
Â  if(!message && !chatPendingFiles.length) return;
Â  addBubbleWithFiles("chatBox",message,chatPendingFiles,"user");
Â  chatHistory.push({role:"user",text:message});
Â  document.getElementById("chatInput").value=""; document.getElementById("chatPreview").innerHTML="";
Â  addBubble("chatBox","ğŸ§  ÄANG TRáº¢ Lá»œI...","ai");
Â  let imageBase64=null;
Â  if(chatPendingFiles.length>0 && chatPendingFiles[0].type.startsWith("image/")) {
Â  Â  imageBase64 = await toBase64(chatPendingFiles[0]);
Â  }
Â  chatPendingFiles=[];
Â  try {
Â  Â  const res = await fetch("/api/chat", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ message, history: chatHistory, language: currentLang, image: imageBase64 }) });
Â  Â  const data = await res.json();
Â  Â  // parse markdown and keep marks; but Gemini returns HTML with <mark> so we can set innerHTML
Â  Â  updateLastAIBubble("chatBox", data.response || "âŒ KhÃ´ng cÃ³ pháº£n há»“i tá»« Gemini.");
Â  Â  chatHistory.push({role:"assistant",text:data.response});
Â  } catch (e) {
Â  Â  updateLastAIBubble("chatBox","âŒ Lá»—i káº¿t ná»‘i server.");
Â  Â  console.error(e);
Â  }
});

/* ---------- Math (Gemini LaTeX + highlight) ---------- */
document.getElementById("btnMath").addEventListener("click",async()=>{
Â  const question=document.getElementById("mathPrompt").value.trim();
Â  if(!question && !mathPendingFiles.length) return;
Â  addBubbleWithFiles("mathBox",question,mathPendingFiles,"user");
Â  document.getElementById("mathPrompt").value=""; document.getElementById("mathPreview").innerHTML="";
Â  addBubble("mathBox","ğŸ§  ÄANG GIáº¢I TOÃN...","ai");
Â  let imageBase64=null;
Â  if(mathPendingFiles.length>0 && mathPendingFiles[0].type.startsWith("image/")) {
Â  Â  imageBase64 = await toBase64(mathPendingFiles[0]);
Â  }
Â  mathPendingFiles=[];
Â  try {
Â  Â  const res = await fetch("/api/math", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ question, image: imageBase64 }) });
Â  Â  const data = await res.json();
Â  Â  updateLastAIBubble("mathBox", data.response || "âŒ KhÃ´ng cÃ³ pháº£n há»“i tá»« Gemini.");
Â  Â  MathJax.typesetPromise();
Â  } catch (e) {
Â  Â  updateLastAIBubble("mathBox","âŒ Lá»—i káº¿t ná»‘i server.");
Â  Â  console.error(e);
Â  }
});

/* ---------- Video (Pollinations -> 20 frames -> GIF/Video client-side) ---------- */
document.getElementById("btnVideo").addEventListener("click",async()=>{
    const prompt=document.getElementById("videoPrompt").value.trim();
    if(!prompt) return;
    
    // Gá»­i prompt ngÆ°á»i dÃ¹ng
    addBubble("videoBox",prompt,"user"); 
    document.getElementById("videoPrompt").value="";
    document.getElementById("videoPreview").innerHTML="";
    // Bá» qua file áº£nh pending vÃ¬ Pollinations video frames endpoint thÆ°á»ng chá»‰ dÃ¹ng prompt.
    videoPendingFiles = [];

    // START PHASE 1: Fetching Frames from Server
    const statusId = Date.now(); // Unique ID for status bubble
    addBubble("videoBox",`<span id="status-${statusId}">ğŸ¬ 1/2: Äang yÃªu cáº§u Server táº¡o 20 khung hÃ¬nh...</span>`,"ai");

    try {
        // 1. Fetch frames (Gá»i endpoint má»›i: /api/pollinations-frames)
        const fetchRes = await fetch("/api/pollinations-frames", { 
            method:"POST", 
            headers:{"Content-Type":"application/json"}, 
            body: JSON.stringify({ prompt: prompt }) 
        });
        const fetchData = await fetchRes.json();
        
        if (!fetchRes.ok || !fetchData.frames || fetchData.frames.length === 0) {
            updateLastAIBubble("videoBox",`âŒ Lá»—i: ${fetchData.message || 'Server khÃ´ng tráº£ vá» khung hÃ¬nh nÃ o.'}`);
            return;
        }

        const frames = fetchData.frames;
        
        // 2. GhÃ©p GIF (Client-side)
        document.getElementById(`status-${statusId}`).innerHTML = `ğŸ¬ 2/2: Äang ghÃ©p ${frames.length} khung hÃ¬nh thÃ nh GIF...`;

        // Khá»Ÿi táº¡o GIF
        const gif = new GIF({
            workers: 2,
            quality: 10,
            width: 512,
            height: 512,
            workerScript: 'gif.worker.js' 
        });

        // ThÃªm tá»«ng khung hÃ¬nh vÃ o GIF
        for (let i = 0; i < frames.length; i++) {
            const frameBase64 = frames[i];
            const img = new Image();
            await new Promise(resolve => {
                img.onload = () => {
                    gif.addFrame(img, { delay: 100 }); // 100ms = 10 FPS
                    document.getElementById(`status-${statusId}`).innerHTML = `ğŸ¬ 2/2: Äang ghÃ©p GIF... (${Math.round((i + 1) / frames.length * 90)}%)`;
                    resolve();
                };
                img.onerror = () => resolve(); // Bá» qua khung hÃ¬nh lá»—i
                img.src = frameBase64;
            });
        }
        
        // Cáº­p nháº­t tiáº¿n Ä‘á»™ render
        gif.on('progress', function(p) {
            document.getElementById(`status-${statusId}`).innerHTML = `ğŸ¬ 2/2: Äang render GIF... (${Math.round(90 + (p * 10))}%)`;
        });

        // HoÃ n thÃ nh vÃ  hiá»ƒn thá»‹ káº¿t quáº£
        gif.on('finished', function(blob) {
            const gifUrl = URL.createObjectURL(blob);
            const resultHtml = `
                âœ… ÄÃ£ hoÃ n thÃ nh GIF Ä‘á»™ng!
                <img src="${gifUrl}" class="generated-video" style="max-height: 350px;">
                <a href="${gifUrl}" download="ai-animation.gif" class="block mt-2 text-center text-yellow-300 underline font-bold">Táº£i xuá»‘ng GIF</a>
            `;
            updateLastAIBubble("videoBox", resultHtml);
        });

        gif.render(); // Báº¯t Ä‘áº§u render

    } catch (e) {
        updateLastAIBubble("videoBox","âŒ Lá»—i káº¿t ná»‘i hoáº·c xá»­ lÃ½ GIF trÃªn trÃ¬nh duyá»‡t.");
        console.error("Lá»—i táº¡o GIF:", e);
    }
});
</script>
</body>
</html>
