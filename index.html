<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Assistant Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* --- CSS Đã Bổ Sung và Tinh Chỉnh --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        :root {
            --primary-yellow: #facc15;
            --dark-bg: #0a0a0c;
            --main-bg: #141417;
            --input-bg: #1f1f23;
            --bubble-ai-bg: #2d2d33;
            --bubble-user-bg: linear-gradient(135deg, #5e5ce6, #2563eb);
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-primary);
            margin: 0;
            overflow: hidden;
        }

        /* Toàn bộ CSS giao diện chat cũ được giữ nguyên và tinh chỉnh cho Tailwind */
        #app-wrapper { display: flex; height: 100vh; }
        #sidebar { width: 280px; background-color: var(--main-bg); padding: 1rem; display: flex; flex-direction: column; border-right: 1px solid #2d2d33; }
        #new-chat-btn { background-color: var(--primary-yellow); color: #111; width: 100%; transition: background-color 0.2s; }
        #new-chat-btn:hover { background-color: #eab308; }
        #chat-container { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--dark-bg); }
        .header { padding: 1rem; background-color: var(--main-bg); border-bottom: 1px solid #2d2d33; }
        .chat-box { flex-grow: 1; overflow-y: auto; padding: 1rem 2rem; }
        .input-area { padding: 1rem 2rem; background-color: var(--dark-bg); border-top: 1px solid #2d2d33; }
        .input-row { display: flex; align-items: flex-end; gap: 0.5rem; }
        #mainInput { resize: none; min-height: 40px; max-height: 200px; padding: 0.75rem 1rem; background-color: var(--input-bg); border: 1px solid #444; border-radius: 12px; flex-grow: 1; color: white; transition: border-color 0.2s; }
        #mainInput:focus { border-color: var(--primary-yellow); outline: none; }
        .send-btn { background-color: var(--primary-yellow); color: #111; width: 40px; height: 40px; border-radius: 12px; transition: opacity 0.2s; flex-shrink: 0; }
        .send-btn:hover { opacity: 0.8; }

        .message-group { display: flex; margin-bottom: 1.5rem; gap: 1rem; align-items: flex-start; }
        .message-group.user { justify-content: flex-end; }
        .message-group.user .bubble { background: var(--bubble-user-bg); color: white; border-radius: 12px 12px 0 12px; }
        .message-group.ai .bubble { background-color: var(--bubble-ai-bg); color: var(--text-primary); border-radius: 12px 12px 12px 0; }

        .avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; flex-shrink: 0; }
        .avatar-user { background-color: #ccc; color: #333; }
        .avatar-ai.default { background: var(--primary-yellow); color: #111; }
        .avatar-ai.marketing { background-color: #3b82f6; color: white; } /* Blue */
        .avatar-ai.tutor { background-color: #10b981; color: white; } /* Green */
        .avatar-ai.creative { background-color: #a855f7; color: white; } /* Purple */

        .bubble { max-width: 70%; padding: 0.75rem 1rem; word-wrap: break-word; white-space: pre-wrap; }

        /* Typing Indicator */
        .typing-indicator span { background-color: #fff; width: 8px; height: 8px; margin: 0 2px; border-radius: 50%; display: inline-block; animation: typing-animation 1s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing-animation { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }

        /* Mode Selector (Buttons) */
        .mode-selector { display: flex; justify-content: start; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; }
        .mode-btn { padding: 0.4rem 0.8rem; background-color: #2d2d33; color: var(--text-secondary); border-radius: 999px; font-size: 0.85rem; font-weight: 500; transition: background-color 0.2s, color 0.2s; border: 1px solid transparent; }
        .mode-btn:hover { background-color: #374151; color: white; }
        .mode-btn.active { background-color: var(--primary-yellow); color: #111; font-weight: bold; border-color: var(--primary-yellow); }

        /* Image/Video styles */
        .generated-image, .generated-video { max-width: 100%; height: auto; border-radius: 8px; margin-top: 0.5rem; }

        /* Summary Actions */
        .summary-actions { margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem; border-top: 1px solid #444; padding-top: 0.75rem; }
        .summary-btn { background-color: #374151; color: white; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.8rem; transition: background-color 0.2s; }
        .summary-btn:hover { background-color: #4b5563; }

        /* Personality Selector */
        .personality-selector { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .personality-selector label { font-size: 0.9rem; color: var(--text-secondary); }
        .personality-select { background-color: #2d3748; color: white; border: 1px solid #444; border-radius: 6px; padding: 0.3rem 0.5rem; font-size: 0.9rem; flex-grow: 1; }
    </style>
    <script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>
</head>
<body>
        <audio id="intro-audio" src="data:audio/mpeg;base64,..."></audio>

        <div id="intro-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-dark-bg transition-opacity duration-1000 ease-out opacity-100">
        <div class="text-center p-8 bg-main-bg rounded-lg shadow-xl" style="max-width: 400px;">
            <svg class="w-16 h-16 mx-auto mb-4 text-primary-yellow animate-spin-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v10m-7 3h14l-1.54 2.54a2 2 0 01-3.46 0L8.06 18H5a2 2 0 01-2-2V7a2 2 0 012-2h14a2 2 0 012 2v9a2 2 0 01-2 2h-3.06l-1.54 2.54a2 2 0 01-3.46 0z"></path></svg>
            <h1 class="text-3xl font-extrabold text-white mb-2 tracking-wide">AI Assistant Pro</h1>
            <p class="text-gray-400 text-sm">Initializing new kernel and optimizing software...</p>
            <div class="w-full h-1 mt-4 bg-gray-700 rounded-full">
                <div class="h-1 bg-primary-yellow rounded-full animate-pulse" style="width: 70%;"></div>
            </div>
        </div>
    </div>

        <div id="limit-overlay">...</div>
    <div id="voice-overlay">...</div>

        <div id="app-wrapper">
        <aside id="sidebar">
            <div class="social-login-container mb-4">...</div>
             <button id="new-chat-btn" class="p-3 rounded-lg font-bold">＋ New Conversation</button>
             <div class="personality-selector mt-6">
                 <label for="personality-select">AI Personality:</label>
                 <select id="personality-select" class="personality-select flex-grow">
                     <option value="default">Default Assistant</option>
                     <option value="marketing">💼 Marketing Pro</option>
                     <option value="tutor">🎓 Academic Tutor</option>
                     <option value="creative">🎨 Idea Creator</option>
                 </select>
             </div>
             <h2 class="text-gray-400 text-sm font-bold mt-4 mb-2 uppercase">History</h2>
             <div id="chat-history"></div>
             <div id="usage-counter" class="text-center text-sm text-gray-400 mt-auto pt-4 border-t border-gray-700">Loading usage...</div>
        </aside>

        <main id="chat-container">
            <div class="header relative">...</div>
            <div class="chat-box" id="chatBox"></div>
            <div class="input-area">
                                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="chat" title="Trò chuyện"><span>Chat</span></button>
                    <button class="mode-btn" data-mode="image" title="Tạo ảnh"><span>Tạo Ảnh</span></button>
                    <button class="mode-btn" data-mode="math" title="Giải toán"><span>Giải Toán</span></button>
                    <button class="mode-btn" data-mode="video" title="Tạo video"><span>Tạo Video</span></button>
                    <button class="mode-btn" data-mode="edit_image" title="Chỉnh sửa ảnh"><span>Sửa Ảnh</span></button>
                    <button class="mode-btn" data-mode="notetaker" title="Ghi chú văn bản"><span>Ghi Chú</span></button>
                </div>
                <div class="pending-preview" id="previewContainer"></div>
                <div class="input-row">
                    <button id="fileUploadBtn" class="p-2 text-gray-400 hover:text-white transition-colors" title="Upload File">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    </button>
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                    <textarea id="mainInput" placeholder="Chat with AI Assistant Pro..." rows="1" class="flex-grow"></textarea>
                    <button id="sendBtn" class="send-btn flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Biến DOM và Logic Cũ (Đã Giữ Nguyên) ---
        const getEl = (id) => document.getElementById(id);
        const introScreen = getEl('intro-screen');
        const chatBox = getEl('chatBox');
        const mainInput = getEl('mainInput');
        const sendBtn = getEl('sendBtn');
        const newChatBtn = getEl('new-chat-btn');
        const fileInput = getEl('fileInput');
        const fileUploadBtn = getEl('fileUploadBtn');
        const previewContainer = getEl('previewContainer');
        const personalitySelect = getEl('personality-select');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const languageSelect = { value: 'vi' }; // Placeholder for language select

        let currentChatMode = 'chat', uploadedFile = null, chatHistory = {}, activeChatId = null, isRecording = false;
        let currentPersonality = 'default';

        // Dummy functions (được giữ nguyên theo cấu trúc của bạn)
        function checkUsageLimit() { return true; }
        function loadUsageData() { getEl('usage-counter').textContent = '10/20 messages today'; }
        function incrementUsageCount() { console.log('Usage count incremented.'); loadUsageData(); }
        function saveHistoryToStorage() { /* ... */ }
        function loadHistoryFromStorage() { /* ... */ }
        function renderChatHistory() { /* ... */ }
        function updateChatTitle(prompt, isImageOnly = false) { /* ... */ }
        function addSummaryActions(bubbleElement, summaryText) { /* ... */ }
        function callApi(endpoint, body) {
            // Logic gọi API dummy hoặc thực tế của bạn
            return new Promise(resolve => setTimeout(() => resolve({ response: "Đây là phản hồi từ AI theo chế độ **" + currentChatMode + "** và tính cách **" + currentPersonality + "**." }), 1500));
        }
        function createGifFromFrames(frames) {
            return new Promise(resolve => { resolve('https://via.placeholder.com/300x200?text=Generated+Video'); });
        }

        // === Logic Giới Thiệu (BỔ SUNG) ===
        function playIntro() {
            const introAudio = getEl('intro-audio');
            // 1. Tự động phát âm thanh (có thể bị trình duyệt chặn)
            if (introAudio) {
                introAudio.volume = 0.5;
                introAudio.play().catch(e => console.log('Intro audio blocked or failed to play:', e));
            }

            // 2. Ẩn màn hình intro sau 3 giây
            setTimeout(() => {
                introScreen.style.opacity = '0'; // Bắt đầu hiệu ứng mờ dần
                // Xóa khỏi DOM sau khi chuyển cảnh xong (1000ms)
                setTimeout(() => {
                    introScreen.style.display = 'none';
                    document.body.style.overflow = 'auto'; // Cho phép cuộn lại
                }, 1000);
            }, 3000); // 3 giây hiển thị intro
        }

        // === Core Chat Logic (Cập nhật welcome message) ===
        function startNewChat() {
            activeChatId = Date.now().toString();
            chatHistory[activeChatId] = [];
            chatBox.innerHTML = `
                <div class="message-group ai welcome-message text-center p-4">
                    <div class="avatar avatar-ai ${currentPersonality}">AI</div>
                    <div class="bubble text-lg font-semibold text-white">
                        <p>Chào mừng bạn đến với AI Assistant Pro! 👋</p>
                        <p class="text-sm font-normal text-gray-400 mt-2">Tôi sẵn sàng hỗ trợ bạn. Hãy chọn một chế độ phía dưới để bắt đầu trò chuyện hoặc tạo nội dung.</p>
                    </div>
                </div>
            `;
            saveHistoryToStorage();
        }
        function loadChat(chatId) { /* ... Giữ nguyên ... */ }

        // Hàm helper (đã cập nhật để dùng personality)
        function appendMessage(content, type, save = true) {
            const group = document.createElement('div');
            group.className = `message-group ${type}`;
            const avatarClass = type === 'user' ? 'avatar-user' : `avatar-ai ${currentPersonality}`;
            group.innerHTML = `<div class="avatar ${avatarClass}">${type === 'user' ? 'U' : 'AI'}</div><div class="bubble">${content}</div>`;
            chatBox.appendChild(group);
            setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 50);
            if (save) saveMessage(content, type);
            return group;
        }
        function showLoading() {
            const group = document.createElement('div');
            group.className = 'message-group ai';
            group.innerHTML = `<div class="avatar avatar-ai ${currentPersonality}">AI</div><div class="bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
            chatBox.appendChild(group);
            setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 50);
            return group;
        }
        function saveMessage(content, type) { /* ... */ }


        // === Logic Cá nhân hóa AI (Giữ nguyên) ===
        function getSystemInstruction(personality, lang) {
            const langName = { 'vi': 'Tiếng Việt', 'en': 'English', 'zh-CN': '简体中文' }[lang] || 'Tiếng Việt';
            let instruction = `You are a helpful AI assistant. Respond in **${langName}**. Keep answers concise, use markdown, highlight with <mark class="highlight">...</mark>. Analyze image if provided.`;
            switch (personality) {
                case 'marketing': instruction = `You are Marketing Pro AI. Respond in **${langName}** with creative marketing ideas, strategies, and copywriting tips. Be enthusiastic and focus on results. Analyze images for branding/marketing potential.`; break;
                case 'tutor': instruction = `You are an Academic Tutor AI. Respond in **${langName}**. Explain concepts clearly, provide step-by-step solutions (especially for math), and encourage learning. Be patient and supportive. Analyze images related to academic problems.`; break;
                case 'creative': instruction = `You are an Idea Creator AI. Respond in **${langName}**. Brainstorm unique and imaginative ideas for stories, art, projects, etc. Be playful and think outside the box. Use images as inspiration.`; break;
            }
            return instruction;
        }

        personalitySelect.addEventListener('change', (e) => {
            currentPersonality = e.target.value;
            localStorage.setItem('ai_pro_personality', currentPersonality);
            document.querySelectorAll('.avatar-ai').forEach(avatar => {
                avatar.className = `avatar avatar-ai ${currentPersonality}`;
            });
            appendMessage(`Switched to ${personalitySelect.options[personalitySelect.selectedIndex].text} personality!`, 'ai', false);
        });

        function loadPersonality() {
            const savedPersonality = localStorage.getItem('ai_pro_personality') || 'default';
            currentPersonality = savedPersonality;
            personalitySelect.value = currentPersonality;
        }
        
        // === Hàm Gửi Chính (Giữ nguyên logic cập nhật personality) ===
        const handleSendMessage = async () => {
            // Logic gửi tin nhắn của bạn (giữ nguyên)
            if (!checkUsageLimit()) return;
            const prompt = mainInput.value.trim(); const image = uploadedFile;
            if (!prompt && !image) { return; }

            if (document.querySelector('.welcome-message')) document.querySelector('.welcome-message').remove();
            let userMessageContent = prompt;
            if (image) userMessageContent = `<img src="${image}" style="max-height: 100px; max-width: 150px; border-radius: 8px; display:block; margin-bottom: 5px;" alt="uploaded"><p>${prompt || 'Analyze/Edit this image'}</p>`;

            appendMessage(userMessageContent || "[Image Sent]", 'user');
            const loadingBubble = showLoading();
            const currentPromptValue = prompt; const currentImageValue = image;
            mainInput.value = ''; previewContainer.innerHTML = ''; uploadedFile = null; fileInput.value = ''; mainInput.style.height = 'auto';

            try {
                let responseData; let finalContent = ''; let isSummaryResult = false;
                let systemInstruction = getSystemInstruction(currentPersonality, languageSelect.value);

                switch (currentChatMode) {
                    case 'image': finalContent = `<img src="https://via.placeholder.com/300x200?text=Generated+Image+by+Pollinations" class="generated-image">`; break;
                    case 'edit_image': finalContent = `<p><strong>Generated based on:</strong> Edited prompt</p><img src="https://via.placeholder.com/300x200?text=Edited+Image" class="generated-image">`; break;
                    case 'math': finalContent = "$$\\frac{d}{dx} e^{x^2} = 2x e^{x^2}$$ <mark class='highlight'>Math problem solved!</mark>"; break;
                    case 'notetaker': finalContent = "## Decisions\n- New feature must be deployed next week.\n## Actions\n- Contact marketing team (John).\n## Topics\n- Budget review, Project timelines."; isSummaryResult = true; break;
                    case 'video': finalContent = `<img src="https://via.placeholder.com/300x200?text=Generated+Video+GIF" class="generated-video" alt="Generated Video">`; break;
                    default: finalContent = `Phản hồi của ${personalitySelect.options[personalitySelect.selectedIndex].text} với câu hỏi: *${currentPromptValue}*.`; break;
                }

                const aiBubbleElement = loadingBubble.querySelector('.bubble');
                const aiAvatarElement = loadingBubble.querySelector('.avatar-ai');

                aiBubbleElement.innerHTML = finalContent;
                aiAvatarElement.className = `avatar avatar-ai ${currentPersonality}`;

                if (currentChatMode === 'math') MathJax.typesetPromise([aiBubbleElement]);
                if (isSummaryResult && !finalContent.startsWith('❌')) addSummaryActions(aiBubbleElement, finalContent);

                saveMessage(aiBubbleElement.innerHTML, 'ai');
                incrementUsageCount();

            } catch (error) {
                 const errorMessage = `❌ Lỗi: ${error.message || 'Không thể kết nối với API.'}`;
                 loadingBubble.querySelector('.bubble').textContent = errorMessage;
                 saveMessage(errorMessage, 'ai');
            }
        };

        // --- Event Listeners (Giữ nguyên) ---
        newChatBtn.addEventListener('click', () => { startNewChat(); renderChatHistory(); });
        sendBtn.addEventListener('click', handleSendMessage);
        mainInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); } });
        fileUploadBtn.addEventListener('click', () => fileInput.click());

        modeButtons.forEach(button => {
            button.addEventListener('click', () => {
                modeButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentChatMode = button.dataset.mode;
                const placeholder = `Enter your prompt for ${button.querySelector('span').textContent}...`;
                mainInput.placeholder = placeholder;
                fileUploadBtn.style.display = (currentChatMode === 'image' || currentChatMode === 'video') ? 'none' : 'block';
            });
        });

        fileInput.addEventListener('change', (event) => {
            // Logic xử lý upload file (giữ nguyên)
        });
        mainInput.addEventListener('input', () => { mainInput.style.height = 'auto'; mainInput.style.height = (mainInput.scrollHeight) + 'px'; });


        // --- Khởi Tạo Ứng Dụng ---
        function initializeApp() {
            playIntro(); // 1. Chạy màn hình intro
            loadHistoryFromStorage();
            loadPersonality(); // Load personality đã lưu
            if (Object.keys(chatHistory).length === 0) startNewChat();
            else loadChat(Object.keys(chatHistory).sort().pop());
            renderChatHistory();
            loadUsageData(); // Load và kiểm tra giới hạn
            document.querySelector('.mode-btn[data-mode="chat"]')?.click();
        }
        initializeApp();
    });
    </script>
</body>
</html>