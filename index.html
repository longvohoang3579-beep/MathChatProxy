<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Assistant Pro</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
body {
  background-color:#0f0f13; color:#fff; font-family:'Segoe UI',sans-serif;
  margin:0; padding:0; overflow:hidden;
}
 
/* ---------- Intro ---------- */
#intro-screen {
  position: fixed;
  top:0; left:0; width:100%; height:100vh;
  background: radial-gradient(circle at center, #1a1c29 0%, #0a0a0a 80%);
  overflow:hidden;
  display:flex; align-items:center; justify-content:center;
  flex-direction:column; z-index:1000;
  transition:opacity 1.8s ease;
}
#intro-bg {
  position:absolute; top:0; left:0; width:100%; height:100%;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.07) 0%, transparent 60%),
              radial-gradient(circle at 70% 70%, rgba(255,255,255,0.05) 0%, transparent 60%),
              radial-gradient(circle at 50% 100%, rgba(122, 255, 255, 0.08) 0%, transparent 70%);
  animation: glowMove 10s ease-in-out infinite alternate;
  filter: blur(50px);
}
@keyframes glowMove {
  0% { transform: scale(1) translate(0, 0); }
  100% { transform: scale(1.2) translate(20px, -20px); }
}
#intro-text {
  position:relative;
  color:#facc15;
  font-size:2.3rem; font-weight:bold;
  text-shadow:0 0 20px rgba(255, 255, 150, 0.8), 0 0 40px rgba(255,255,255,0.4);
  animation: floatText 3s ease-in-out infinite alternate;
}
@keyframes floatText {
  0% { transform: translateY(0); opacity:1; }
  100% { transform: translateY(-10px); opacity:0.95; }
}
#intro-subtext {
  color:#e0e7ff;
  margin-top:1rem;
  font-size:1.1rem;
  opacity:0.85;
  text-shadow:0 0 10px rgba(255,255,255,0.3);
  animation: fadeIn 3s ease-in-out 1.5s forwards;
  opacity:0;
}
@keyframes fadeIn {
  from { opacity:0; }
  to { opacity:1; }
}
 
/* ---------- Main Container ---------- */
.container {max-width:900px;margin:2rem auto;background:#1a1c29;border-radius:1.5rem;padding:1.5rem;box-shadow:0 15px 30px rgba(0,0,0,0.7);display:none;}
.tabs {display:flex;border-bottom:2px solid #333;margin-bottom:1rem;}
.tab-btn {flex:1;text-align:center;padding:1rem;cursor:pointer;color:#aaa;font-weight:bold;transition:all 0.2s;}
.tab-btn.active {color:#fff;border-bottom:3px solid #facc15;}
.tab-content {display:none;}
.tab-content.active {display:block;}
.chat-box {background:#111827;border-radius:12px;padding:1rem;height:400px;overflow-y:auto;display:flex;flex-direction:column;}
.bubble {max-width:80%;padding:10px 14px;border-radius:12px;margin-bottom:10px;line-height:1.5;word-wrap:break-word;white-space:pre-wrap;}
.user-bubble {background:#2563eb;align-self:flex-end;color:white;border-bottom-right-radius:2px;}
.ai-bubble {background:#374151;align-self:flex-start;color:#e5e7eb;border-bottom-left-radius:2px;}
mark.highlight {background-color:#fde047;color:black;font-weight:bold;padding:0 3px;border-radius:3px;}
textarea,input{width:100%;padding:0.75rem;border-radius:0.75rem;background:#1e1e2a;border:1px solid #333;color:white;resize:none;outline:none;}
button{padding:0.75rem 1rem;border-radius:0.75rem;font-weight:bold;cursor:pointer;transition:all 0.2s;}
#btnCreateImage{background:#10b981;color:#111827;}#btnCreateImage:hover{background:#059669;}
#btnChat{background:#6366f1;color:white;}#btnChat:hover{background:#4f46e5;}
#btnMath{background:#f59e0b;color:#111827;}#btnMath:hover{background:#d97706;}
img.generated-image{border-radius:12px;max-width:100%;margin-top:1rem;}
#settings-btn{position:absolute;top:1rem;right:1rem;font-size:1.5rem;cursor:pointer;color:#facc15;}
#settings-modal{position:absolute;top:3rem;right:1rem;width:200px;background:#1a1c29;border:1px solid #facc15;border-radius:0.75rem;padding:1rem;display:none;}
.pending-preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
.pending-preview img{width:60px;height:60px;object-fit:cover;border-radius:8px;border:2px solid #475569;}
.input-row{display:flex;align-items:center;gap:6px;margin-top:8px;}
.icon-btn{background:#27293a;padding:8px;border-radius:8px;cursor:pointer;transition:0.2s;}
.icon-btn:hover{background:#3f4259;}
.icon-btn svg{width:22px;height:22px;color:#facc15;}
.send-btn{background:#6366f1;padding:10px;border-radius:50%;display:flex;align-items:center;justify-content:center;}
.send-btn:hover{background:#4f46e5;}
.send-btn svg{width:22px;height:22px;transform:rotate(0deg);}
.generated-video{border-radius:12px;max-width:100%;margin-top:1rem;}
</style>
<script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>
<script src="https://unpkg.com/gif.js@0.2.0/dist/gif.worker.js"></script>
</head>
 
<body>
<div id="intro-screen">
  <div id="intro-bg"></div>
  <div id="intro-text">🌌 Welcome to <mark class="highlight">AI Assistant Pro</mark> 🌌</div>
  <div id="intro-subtext">Unleash the magic of creativity and intelligence.</div>
</div>
 
<div class="container relative" id="mainApp">
  <div id="settings-btn">⚙️</div>
  <div id="settings-modal">
    <label class="block mb-2">Ngôn ngữ chat:</label>
    <select id="language-select" class="w-full p-2 rounded bg-gray-800 text-white">
      <option value="vi">Tiếng Việt</option>
      <option value="en">English</option>
      <option value="zh-CN">简体中文</option>
    </select>
  </div>
 
  <div class="tabs">
    <div class="tab-btn active" data-tab="image">🖼️ Tạo Ảnh</div>
    <div class="tab-btn" data-tab="chat">💬 Chat</div>
    <div class="tab-btn" data-tab="math">🧮 Giải Toán</div>
    <div class="tab-btn" data-tab="video">🎞️ Tạo Video</div>
  </div>
 
  <div class="tab-content active" id="image">
    <div class="chat-box" id="imageBox"></div>
    <textarea id="imagePrompt" rows="2" placeholder="Nhập mô tả ảnh..."></textarea>
    <button id="btnCreateImage" class="mt-2 w-full">Tạo Ảnh</button>
  </div>
 
  <div class="tab-content" id="chat">
    <div class="chat-box" id="chatBox"></div>
    <div class="pending-preview" id="chatPreview"></div>
    <div class="input-row">
      <label class="icon-btn" for="chatFileInput" title="Tải ảnh hoặc file">📁</label>
      <input type="file" id="chatFileInput" accept="image/*,.pdf,.txt,.docx" hidden />
      <label class="icon-btn" id="chatCameraBtn" title="Chụp ảnh">📷</label>
      <textarea id="chatInput" rows="1" placeholder="Nhập tin nhắn..."></textarea>
      <button id="btnChat" class="send-btn" title="Gửi">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="white" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12l14 7-7-7 7-7-14 7z"/>
        </svg>
      </button>
    </div>
  </div>
 
  <div class="tab-content" id="math">
    <div class="chat-box" id="mathBox"></div>
    <div class="pending-preview" id="mathPreview"></div>
    <div class="input-row">
      <label class="icon-btn" for="mathFileInput" title="Tải ảnh hoặc file">📁</label>
      <input type="file" id="mathFileInput" accept="image/*,.pdf,.txt,.docx" hidden />
      <label class="icon-btn" id="mathCameraBtn" title="Chụp ảnh">📷</label>
      <textarea id="mathPrompt" rows="1" placeholder="Nhập bài toán..."></textarea>
      <button id="btnMath" class="send-btn" title="Giải">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="white" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12l14 7-7-7 7-7-14 7z"/>
        </svg>
      </button>
    </div>
  </div>
 
  <div class="tab-content" id="video">
    <div class="chat-box" id="videoBox"></div>
    <div class="pending-preview" id="videoPreview"></div>
    <div class="input-row">
      <label class="icon-btn" for="videoFileInput" title="Tải ảnh hoặc file">📁</label>
      <input type="file" id="videoFileInput" accept="image/*" hidden />
      <label class="icon-btn" id="videoCameraBtn" title="Chụp ảnh">📷</label>
      <textarea id="videoPrompt" rows="1" placeholder="Nhập mô tả video..."></textarea>
      <button id="btnVideo" class="send-btn" title="Tạo Video">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="white" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12l14 7-7-7 7-7-14 7z"/>
        </svg>
      </button>
    </div>
  </div>
</div>
 
<script>
// ============================================================
// ⚙️ CÁC BIẾN TOÀN CỤC VÀ HÀM TIỆN ÍCH (Chỉ để phục vụ logic nút ấn)
// ============================================================

const API_BASE_URL = window.location.origin;

let chatHistory = []; 
let currentAttachedImage = null; 

// Hàm chung để thêm tin nhắn người dùng (Cần thiết để người dùng thấy họ đã nhập gì)
function appendUserMessage(boxId, message, imageBase64 = null) {
    const chatBox = document.getElementById(boxId);
    
    if (imageBase64) {
        const userImageBubble = document.createElement('div');
        userImageBubble.className = 'bubble user-bubble';
        const img = document.createElement('img');
        img.src = imageBase64;
        img.style.maxWidth = '100%';
        img.style.borderRadius = '8px';
        img.alt = 'Ảnh người dùng';
        chatBox.appendChild(userImageBubble);
        chatBox.appendChild(img);
    }
    
    if (message) {
        const userTextBubble = document.createElement('div');
        userTextBubble.className = 'bubble user-bubble';
        userTextBubble.innerHTML = message;
        chatBox.appendChild(userTextBubble);
    }
    
    chatBox.scrollTop = chatBox.scrollHeight;
}

// Hàm chung để thêm tin nhắn đang chờ phản hồi (Cần thiết để hiển thị loading)
function appendAIPendingMessage(boxId, text = "AI đang xử lý...") {
    const chatBox = document.getElementById(boxId);
    const aiBubble = document.createElement('div');
    aiBubble.id = 'pending-ai-response';
    aiBubble.className = 'bubble ai-bubble';
    aiBubble.innerHTML = `<span style="font-style:italic;">${text}</span>`;
    chatBox.appendChild(aiBubble);
    chatBox.scrollTop = chatBox.scrollHeight;
    return aiBubble;
}

// Hàm tiện ích tạo bubble lỗi
function createErrorBubble(message) {
    const errorBubble = document.createElement('div');
    errorBubble.className = 'bubble ai-bubble';
    errorBubble.style.backgroundColor = '#991b1b';
    errorBubble.style.color = 'white';
    errorBubble.innerHTML = `Lỗi: ${message}`;
    return errorBubble;
}

// Hàm tải file và convert sang Base64
function handleFileSelect(event, previewId, fileType) {
    const file = event.target.files[0];
    if (!file) return;

    if (fileType === 'image' && !file.type.startsWith('image/')) {
        alert("Chỉ chấp nhận file ảnh cho tác vụ này.");
        event.target.value = null; 
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        currentAttachedImage = e.target.result;
        const previewDiv = document.getElementById(previewId);
        if (previewDiv) previewDiv.innerHTML = `<img src="${currentAttachedImage}" alt="Preview" title="${file.name}">`;
    };
    reader.readAsDataURL(file);
}

// Xóa file đính kèm
function clearAttachment(previewId) {
    currentAttachedImage = null;
    const previewDiv = document.getElementById(previewId);
    if (previewDiv) previewDiv.innerHTML = '';
}

// ============================================================
// 🖼️ HÀM TẠO ẢNH (CHỨC NĂNG NÚT TẠO ẢNH)
// ============================================================
async function createImage() {
    const promptInput = document.getElementById('imagePrompt');
    const prompt = promptInput.value.trim();
    if (!prompt) {
        alert("Vui lòng nhập mô tả ảnh.");
        return;
    }

    appendUserMessage('imageBox', `Tạo ảnh: ${prompt}`);
    const pendingMsg = appendAIPendingMessage('imageBox', "Đang gửi yêu cầu tạo ảnh...");
    promptInput.value = '';

    try {
        const response = await fetch(`${API_BASE_URL}/api/pollinations-image`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt })
        });

        const data = await response.json();
        pendingMsg.remove();
        const chatBox = document.getElementById('imageBox');

        if (response.ok && data.imageUrl) {
            const aiResponse = document.createElement('div');
            aiResponse.className = 'bubble ai-bubble';
            aiResponse.innerHTML = `✅ Ảnh đã được tạo.`;
            chatBox.appendChild(aiResponse);

            const img = document.createElement('img');
            img.className = 'generated-image';
            img.src = data.imageUrl;
            img.alt = 'Ảnh được tạo bởi AI';
            chatBox.appendChild(img);
        } else {
            const errorMsg = data.message || "❌ Lỗi không xác định khi tạo ảnh.";
            chatBox.appendChild(createErrorBubble(errorMsg));
        }
    } catch (error) {
        console.error("Lỗi khi gọi API Tạo Ảnh:", error);
        pendingMsg.remove();
        document.getElementById('imageBox').appendChild(createErrorBubble("❌ Lỗi kết nối đến Server."));
    }
    document.getElementById('imageBox').scrollTop = document.getElementById('imageBox').scrollHeight;
}

// ============================================================
// 💬🧮🎞️ HÀM GỬI CHUNG (CHỨC NĂNG CÁC NÚT GỬI/GIẢI/TẠO VIDEO)
// ============================================================
async function sendMessage(inputElementId, boxId, apiPath, isMath = false, isVideo = false) {
    const inputElement = document.getElementById(inputElementId);
    let message = inputElement.value.trim();
    const imageBase64 = currentAttachedImage;
    
    if (!message && !imageBase64) {
        alert("Vui lòng nhập nội dung hoặc đính kèm ảnh.");
        return;
    }

    const language = document.getElementById('language-select').value;
    const historyToUse = isMath || isVideo ? [] : chatHistory; 

    // 1. Thêm tin nhắn/ảnh người dùng
    appendUserMessage(boxId, message, imageBase64);
    
    // 2. Thêm pending message
    let pendingText = isMath ? "Đang giải bài toán..." : isVideo ? "Đang tạo chuyển động..." : "AI đang trả lời...";
    const pendingMsg = appendAIPendingMessage(boxId, pendingText);
    
    // 3. Reset input và attachment
    inputElement.value = '';
    const previewId = boxId.replace('Box', 'Preview');
    clearAttachment(previewId);
    
    // Xây dựng payload
    let payload = { 
        language: language,
        image: imageBase64,
        prompt: message,
        question: message,
        message: message,
        history: historyToUse
    };

    let url = `${API_BASE_URL}${apiPath}`;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        pendingMsg.remove();
        const chatBox = document.getElementById(boxId);

        if (response.ok) {
            
            // Xử lý tạo Video (tạo GIF từ frames)
            if (isVideo && data.frames && data.frames.length > 0) {
                const aiResponse = document.createElement('div');
                aiResponse.className = 'bubble ai-bubble';
                aiResponse.innerHTML = `✅ Đã tải về ${data.frames.length} khung hình. Đang ghép GIF...`;
                chatBox.appendChild(aiResponse);
                
                // Hàm renderGif được gọi
                const gifData = await renderGif(data.frames, 512, 512); 
                if (gifData) {
                    const videoElement = document.createElement('img');
                    videoElement.className = 'generated-video';
                    videoElement.src = gifData;
                    videoElement.alt = 'Video (GIF) được tạo bởi AI';
                    chatBox.appendChild(videoElement);
                } else {
                    chatBox.appendChild(createErrorBubble("❌ Lỗi khi render GIF trên trình duyệt."));
                }
            }
            
            // Xử lý Chat và Math (dạng text)
            else if (data.response) {
                let aiResponseText = data.response;
                
                if (aiResponseText.startsWith("❌")) {
                    chatBox.appendChild(createErrorBubble(aiResponseText));
                    return;
                }

                const aiBubble = document.createElement('div');
                aiBubble.className = 'bubble ai-bubble';
                aiBubble.innerHTML = aiResponseText;
                chatBox.appendChild(aiBubble);

                if (!isMath && !isVideo) {
                    chatHistory.push({ role: 'user', text: message });
                    chatHistory.push({ role: 'assistant', text: aiResponseText });
                }

                if (isMath) {
                    // Gọi MathJax để render công thức toán
                    MathJax.typesetPromise([chatBox]); 
                }
            }


        } else {
            const errorMsg = data.response || data.message || `❌ Lỗi HTTP ${response.status} từ Server.`;
            chatBox.appendChild(createErrorBubble(errorMsg));
        }
    } catch (error) {
        console.error(`Lỗi khi gọi API ${apiPath}:`, error);
        pendingMsg.remove();
        document.getElementById(boxId).appendChild(createErrorBubble("❌ Lỗi kết nối đến Server."));
    }
    document.getElementById(boxId).scrollTop = document.getElementById(boxId).scrollHeight;
}


// ============================================================
// 🎞️ HÀM RENDER GIF (Dùng gif.js) - Cần thiết cho Tạo Video
// ============================================================
function renderGif(frameDataUrls, width, height) {
    return new Promise((resolve) => {
        const gif = new GIF({
            workers: 2,
            quality: 10,
            width: width,
            height: height,
            workerScript: 'https://unpkg.com/gif.js@0.2.0/dist/gif.worker.js'
        });

        let loadedImages = 0;
        const totalFrames = frameDataUrls.length;
        
        frameDataUrls.forEach((dataUrl) => {
            const img = new Image();
            img.onload = () => {
                gif.addFrame(img, { delay: 150 });
                loadedImages++;
                if (loadedImages === totalFrames) {
                    gif.on('finished', (blob) => {
                        resolve(URL.createObjectURL(blob));
                    });
                    gif.render();
                }
            };
            img.onerror = () => {
                 loadedImages++;
                 if (loadedImages === totalFrames) {
                    gif.on('finished', (blob) => {
                        resolve(URL.createObjectURL(blob));
                    });
                    gif.render();
                 }
            };
            img.src = dataUrl;
        });

        // Timeout bảo vệ
        setTimeout(() => {
            if (loadedImages < totalFrames) {
                resolve(null);
            }
        }, 15000);
    });
}


// Hiệu ứng mở đầu
function playIntro() {
  const intro = document.getElementById("intro-screen");
  const mainApp = document.getElementById("mainApp");
 
  // Sau 6s ẩn intro và hiện app
  setTimeout(() => {
    intro.style.opacity = "0";
    setTimeout(() => {
      intro.style.display = "none";
      mainApp.style.display = "block";
      document.body.style.overflow = "auto";
    }, 1800);
  }, 6000);
}
playIntro();
 
/* Tabs */
const tabs=document.querySelectorAll(".tab-btn");
const contents=document.querySelectorAll(".tab-content");
tabs.forEach(tab=>tab.addEventListener("click",()=>{tabs.forEach(t=>t.classList.remove("active"));contents.forEach(c=>c.classList.remove("active"));tab.classList.add("active");document.getElementById(tab.dataset.tab).classList.add("active");
    // Xóa file đính kèm khi chuyển tab
    clearAttachment('chatPreview');
    clearAttachment('mathPreview');
    clearAttachment('videoPreview');
}));

/* LẮNG NGHE SỰ KIỆN CÁC NÚT (PHẦN BỔ SUNG CHÍNH) */
document.getElementById('btnCreateImage').addEventListener('click', createImage);
document.getElementById('btnChat').addEventListener('click', () => sendMessage('chatInput', 'chatBox', '/api/chat'));
document.getElementById('btnMath').addEventListener('click', () => sendMessage('mathPrompt', 'mathBox', '/api/math', true));
document.getElementById('btnVideo').addEventListener('click', () => sendMessage('videoPrompt', 'videoBox', '/api/pollinations-frames', false, true));

/* Lắng nghe file input */
document.getElementById('chatFileInput').addEventListener('change', (e) => handleFileSelect(e, 'chatPreview', 'file'));
document.getElementById('mathFileInput').addEventListener('change', (e) => handleFileSelect(e, 'mathPreview', 'file'));
document.getElementById('videoFileInput').addEventListener('change', (e) => handleFileSelect(e, 'videoPreview', 'image'));

/* Xử lý UX: Auto-resize textarea và gửi tin nhắn bằng Enter */
document.querySelectorAll('textarea').forEach(textarea => {
    textarea.addEventListener('input', () => {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    });
    textarea.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            const tabId = document.querySelector('.tab-btn.active').dataset.tab;
            let btnId;

            if (tabId === 'image') {
                btnId = 'btnCreateImage';
            } else if (tabId === 'chat') {
                btnId = 'btnChat';
            } else if (tabId === 'math') {
                btnId = 'btnMath';
            } else if (tabId === 'video') {
                btnId = 'btnVideo';
            }

            if (btnId) {
                document.getElementById(btnId).click();
            }
        }
    });
});

/* Settings Modal */
document.getElementById('settings-btn').addEventListener('click', () => {
    const modal = document.getElementById('settings-modal');
    modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
});
</script>
</body>
</html>